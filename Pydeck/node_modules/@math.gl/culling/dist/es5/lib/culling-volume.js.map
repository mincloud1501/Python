{"version":3,"sources":["../../../src/lib/culling-volume.js"],"names":["faces","Vector3","scratchPlaneCenter","scratchPlaneNormal","scratchPlane","Plane","CullingVolume","planes","every","plane","boundingSphere","length","center","radius","planeIndex","faceNormal","plane0","plane1","Vector4","plane0Center","copy","scale","add","plane0Distance","dot","x","y","z","w","plane1Center","negatedFaceNormal","negate","plane1Distance","boundingVolume","intersect","Intersect","INSIDE","planeCoefficients","fromCoefficients","result","intersectPlane","OUTSIDE","INTERSECTING","parentPlaneMask","Number","isFinite","MASK_OUTSIDE","MASK_INSIDE","mask","k","flag"],"mappings":"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","sourcesContent":["// This file is derived from the Cesium math library under Apache 2 license\n// See LICENSE.md and https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md\n\n/* eslint-disable */\nimport {Vector3, Vector4, assert} from 'math.gl';\nimport {Intersect} from '../constants';\nimport Plane from './plane';\n\n// X, Y, Z Unit vectors\nconst faces = [new Vector3([1, 0, 0]), new Vector3([0, 1, 0]), new Vector3([0, 0, 1])];\n\nconst scratchPlaneCenter = new Vector3();\nconst scratchPlaneNormal = new Vector3();\nconst scratchPlane = new Plane(new Vector3(1.0, 0.0, 0.0), 0.0);\n\n// A culling volume defined by planes.\nexport default class CullingVolume {\n  // For plane masks (as used in {@link CullingVolume#computeVisibilityWithPlaneMask}), this special value\n  // represents the case where the object bounding volume is entirely outside the culling volume.\n  static get MASK_OUTSIDE() {\n    return 0xffffffff;\n  }\n\n  // For plane masks (as used in {@link CullingVolume.prototype.computeVisibilityWithPlaneMask}), this value\n  // represents the case where the object bounding volume is entirely inside the culling volume.\n  static get MASK_INSIDE() {\n    return 0x00000000;\n  }\n\n  // For plane masks (as used in {@link CullingVolume.prototype.computeVisibilityWithPlaneMask}), this value\n  // represents the case where the object bounding volume (may) intersect all planes of the culling volume.\n  static get MASK_INDETERMINATE() {\n    return 0x7fffffff;\n  }\n\n  constructor(planes = []) {\n    // {Cartesian4[]} [planes] An array of clipping planes.\n    this.planes = planes;\n    assert(this.planes.every(plane => plane instanceof Plane));\n  }\n\n  // Constructs a culling volume from a bounding sphere. Creates six planes that create a box containing the sphere.\n  // The planes are aligned to the x, y, and z axes in world coordinates.\n  fromBoundingSphere(boundingSphere) {\n    this.planes.length = 2 * faces.length;\n\n    const center = boundingSphere.center;\n    const radius = boundingSphere.radius;\n\n    let planeIndex = 0;\n\n    for (const faceNormal of faces) {\n      let plane0 = this.planes[planeIndex];\n      let plane1 = this.planes[planeIndex + 1];\n\n      if (!plane0) {\n        plane0 = this.planes[planeIndex] = new Vector4();\n      }\n      if (!plane1) {\n        plane1 = this.planes[planeIndex + 1] = new Vector4();\n      }\n\n      const plane0Center = scratchPlaneCenter\n        .copy(faceNormal)\n        .scale(-radius)\n        .add(center);\n      const plane0Distance = -faceNormal.dot(plane0Center);\n\n      // plane0.fromNormalDistance(faceNormal, plane0Distance);\n      plane0.x = faceNormal.x;\n      plane0.y = faceNormal.y;\n      plane0.z = faceNormal.z;\n      plane0.w = plane0Distance;\n\n      const plane1Center = scratchPlaneCenter\n        .copy(faceNormal)\n        .scale(radius)\n        .add(center);\n\n      const negatedFaceNormal = scratchPlaneNormal.copy(faceNormal).negate();\n\n      const plane1Distance = -negatedFaceNormal.dot(plane1Center);\n\n      // plane1.fromNormalDistance(negatedFaceNormal, plane1Distance);\n      plane1.x = negatedFaceNormal.x;\n      plane1.y = negatedFaceNormal.y;\n      plane1.z = negatedFaceNormal.z;\n      plane1.w = plane1Distance;\n\n      planeIndex += 2;\n    }\n\n    return this;\n  }\n\n  // Determines whether a bounding volume intersects the culling volume.\n  computeVisibility(boundingVolume) {\n    assert(boundingVolume);\n    // const planes = this.planes;\n    let intersect = Intersect.INSIDE;\n    for (const planeCoefficients of this.planes) {\n      const plane = scratchPlane.fromCoefficients(...planeCoefficients);\n      const result = boundingVolume.intersectPlane(plane);\n      switch (result) {\n        case Intersect.OUTSIDE:\n          // We are done\n          return Intersect.OUTSIDE;\n\n        case Intersect.INTERSECTING:\n          // If no other intersection is outside, return INTERSECTING\n          intersect = Intersect.INTERSECTING;\n          break;\n\n        default:\n      }\n    }\n\n    return intersect;\n  }\n\n  // Determines whether a bounding volume intersects the culling volume.\n  /*\n   * @param {Number} parentPlaneMask A bit mask from the boundingVolume's parent's check against the same culling\n   *                                 volume, such that if (planeMask & (1 << planeIndex) === 0), for k < 31, then\n   *                                 the parent (and therefore this) volume is completely inside plane[planeIndex]\n   *                                 and that plane check can be skipped.\n   */\n  computeVisibilityWithPlaneMask(boundingVolume, parentPlaneMask) {\n    assert(boundingVolume, 'boundingVolume is required.');\n    assert(Number.isFinite(parentPlaneMask), 'parentPlaneMask is required.');\n\n    if (\n      parentPlaneMask === CullingVolume.MASK_OUTSIDE ||\n      parentPlaneMask === CullingVolume.MASK_INSIDE\n    ) {\n      // parent is completely outside or completely inside, so this child is as well.\n      return parentPlaneMask;\n    }\n\n    // Start with MASK_INSIDE (all zeros) so that after the loop, the return value can be compared with MASK_INSIDE.\n    // (Because if there are fewer than 31 planes, the upper bits wont be changed.)\n    let mask = CullingVolume.MASK_INSIDE;\n\n    const planes = this.planes;\n    for (let k = 0; k < this.planes.length; ++k) {\n      // For k greater than 31 (since 31 is the maximum number of INSIDE/INTERSECTING bits we can store), skip the optimization.\n      const flag = k < 31 ? 1 << k : 0;\n      if (k < 31 && (parentPlaneMask & flag) === 0) {\n        // boundingVolume is known to be INSIDE this plane.\n        continue;\n      }\n\n      const plane = scratchPlane.fromCoefficients(...planes[k]);\n      const result = boundingVolume.intersectPlane(plane);\n      if (result === Intersect.OUTSIDE) {\n        return CullingVolume.MASK_OUTSIDE;\n      } else if (result === Intersect.INTERSECTING) {\n        mask |= flag;\n      }\n    }\n\n    return mask;\n  }\n}\n"],"file":"culling-volume.js"}