{"version":3,"sources":["../../src/json-converter.js"],"names":["isObject","value","JSONConverter","props","log","console","configuration","onJSONChange","json","convertedJson","setProps","JSONConfiguration","parsedJSON","convertJSON","postProcessConvertedJson","convert","convertJSONRecursively","key","Array","isArray","map","element","i","String","isClassInstance","convertClassInstance","convertPlainObject","convertString","typeKey","Boolean","type","result","string","constants","enumerations","convertFunction"],"mappings":"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","sourcesContent":["// Converts JSON to props (\"hydrating\" classes, resolving enums and functions etc).\n// Lightly processes `json` props, transform string values, and extract `views` and `layers`\n// See: https://github.com/uber/deck.gl/blob/master/dev-docs/RFCs/v6.1/json-layers-rfc.md\n//\n// NOTES:\n// * This is intended to provide minimal necessary processing required to support\n//   existing deck.gl props via JSON. This is not an implementation of alternate JSON schemas.\n// * Optionally, error checking could be applied, but ideally should leverage\n//   non-JSON specific mechanisms like prop types.\n\nimport assert from './utils/assert';\nimport JSONConfiguration from './json-configuration';\nimport {instantiateClass} from './helpers/instantiate-class';\nimport parseJSON from './helpers/parse-json';\n\nconst isObject = value => value && typeof value === 'object';\n\nexport default class JSONConverter {\n  constructor(props) {\n    this.log = console; // eslint-disable-line\n    this.configuration = {};\n    this.onJSONChange = () => {};\n    this.json = null;\n    this.convertedJson = null;\n    this.setProps(props);\n  }\n\n  finalize() {}\n\n  setProps(props) {\n    // HANDLE CONFIGURATION PROPS\n    if ('configuration' in props) {\n      // Accept object or `JSONConfiguration`\n      this.configuration =\n        props.configuration instanceof JSONConfiguration\n          ? props.configuration\n          : new JSONConfiguration(props.configuration);\n    }\n\n    if ('onJSONChange' in props) {\n      this.onJSONChange = props.onJSONChange;\n    }\n  }\n\n  convert(json) {\n    // Use shallow equality to ensure we only convert same json once\n    if (!json || json === this.json) {\n      return this.convertedJson;\n    }\n    // Save json for shallow diffing\n    this.json = json;\n\n    // Accept JSON strings by parsing them\n    const parsedJSON = parseJSON(json);\n\n    // Convert the JSON\n    let convertedJson = convertJSON(parsedJSON, this.configuration);\n\n    convertedJson = this.configuration.postProcessConvertedJson(convertedJson);\n\n    this.convertedJson = convertedJson;\n    return convertedJson;\n  }\n\n  // DEPRECATED: Backwards compatibility\n  convertJson(json) {\n    return this.convert(json);\n  }\n}\n\nfunction convertJSON(json, configuration) {\n  // Fixup configuration\n  configuration = new JSONConfiguration(configuration);\n  return convertJSONRecursively(json, '', configuration);\n}\n\n// Converts JSON to props (\"hydrating\" classes, resolving enums and functions etc).\nfunction convertJSONRecursively(json, key, configuration) {\n  if (Array.isArray(json)) {\n    return json.map((element, i) => convertJSONRecursively(element, String(i), configuration));\n  }\n\n  // If object.type is in configuration, instantitate\n  if (isClassInstance(json, configuration)) {\n    return convertClassInstance(json, configuration);\n  }\n\n  if (isObject(json)) {\n    return convertPlainObject(json, configuration);\n  }\n\n  // Single value\n  if (typeof json === 'string') {\n    return convertString(json, key, configuration);\n  }\n\n  // Return unchanged (number, boolean, ...)\n  return json;\n}\n\n// Returns true if an object has a `type` field\nfunction isClassInstance(json, configuration) {\n  const {typeKey} = configuration;\n  return isObject(json) && Boolean(json[typeKey]);\n}\n\nfunction convertClassInstance(json, configuration) {\n  // Extract the class type field\n  const {typeKey} = configuration;\n  const type = json[typeKey];\n\n  // Prepare a props object and ensure all values have been converted\n  let props = {...json};\n  delete props[typeKey];\n\n  props = convertPlainObject(props, configuration);\n\n  return instantiateClass(type, props, configuration);\n}\n\n// Plain JS object, convert each key and return.\nfunction convertPlainObject(json, configuration) {\n  assert(isObject(json));\n\n  const result = {};\n  for (const key in json) {\n    const value = json[key];\n    result[key] = convertJSONRecursively(value, key, configuration);\n  }\n  return result;\n}\n\n// Convert one string value in an object\n// TODO - hard to convert without type hint\n// TODO - Define a syntax for functions so we don't need to sniff types?\n// if (json.indexOf('@@: ') === 0)\n// if (typeHint === function)\n// parseExpressionString(propValue, configuration, isAccessor);\n\n// TODO - We could also support string syntax for hydrating other types, like regexps...\n// But no current use case\nfunction convertString(string, key, configuration) {\n  if (configuration.constants[string]) {\n    return configuration.constants[string];\n  }\n  if (configuration.enumerations[string]) {\n    // TODO - look up\n    return string;\n  }\n  if (configuration.convertFunction) {\n    return configuration.convertFunction(string, key, configuration);\n  }\n  return string;\n}\n"],"file":"json-converter.js"}