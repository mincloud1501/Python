{"version":3,"sources":["../../../../src/effects/lighting/lighting-effect.js"],"names":["AmbientLight","Texture2D","ProgramManager","DirectionalLight","Effect","Matrix4","Vector3","ShadowPass","default","shadow","DEFAULT_AMBIENT_LIGHT_PROPS","color","intensity","DEFAULT_DIRECTIONAL_LIGHT_PROPS","direction","DEFAULT_SHADOW_COLOR","LightingEffect","props","ambientLight","directionalLights","pointLights","shadowColor","shadowPasses","dummyShadowMap","programManager","key","lightSource","type","push","_applyDefaultLights","some","light","gl","layers","viewports","onViewportActive","views","shadowMatrices","_createLightMatrix","length","_createShadowPasses","getDefaultProgramManager","addDefaultModule","width","height","shadowMaps","i","shadowPass","render","filter","layer","shadowEnabled","effectProps","shadowLightId","shadowMap","_getProjectedPointLights","_getProjectedDirectionalLights","lightSources","removeDefaultModule","lightMatrices","viewMatrix","lookAt","eye","negate","projectedPointLights","pointLight","getProjectedLight","projectedDirectionalLights","directionalLight"],"mappings":";;;;;AAAA,SAAQA,YAAR,EAAsBC,SAAtB,EAAiCC,cAAjC,QAAsD,eAAtD;AACA,OAAOC,gBAAP,MAA6B,qBAA7B;AACA,OAAOC,MAAP,MAAmB,kBAAnB;AACA,SAAQC,OAAR,EAAiBC,OAAjB,QAA+B,SAA/B;AACA,OAAOC,UAAP,MAAuB,0BAAvB;AACA,SAAQC,OAAO,IAAIC,MAAnB,QAAgC,+BAAhC;AAEA,IAAMC,2BAA2B,GAAG;AAACC,EAAAA,KAAK,EAAE,CAAC,GAAD,EAAM,GAAN,EAAW,GAAX,CAAR;AAAyBC,EAAAA,SAAS,EAAE;AAApC,CAApC;AACA,IAAMC,+BAA+B,GAAG,CACtC;AACEF,EAAAA,KAAK,EAAE,CAAC,GAAD,EAAM,GAAN,EAAW,GAAX,CADT;AAEEC,EAAAA,SAAS,EAAE,GAFb;AAGEE,EAAAA,SAAS,EAAE,CAAC,CAAC,CAAF,EAAK,CAAC,CAAN,EAAS,CAAC,CAAV;AAHb,CADsC,EAMtC;AACEH,EAAAA,KAAK,EAAE,CAAC,GAAD,EAAM,GAAN,EAAW,GAAX,CADT;AAEEC,EAAAA,SAAS,EAAE,GAFb;AAGEE,EAAAA,SAAS,EAAE,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAC,GAAR;AAHb,CANsC,CAAxC;AAYA,IAAMC,oBAAoB,GAAG,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,MAAM,GAAhB,CAA7B;;IAGqBC,c;;;AACnB,0BAAYC,KAAZ,EAAmB;AAAA;;AAAA;;AACjB,wFAAMA,KAAN;AACA,UAAKC,YAAL,GAAoB,IAApB;AACA,UAAKC,iBAAL,GAAyB,EAAzB;AACA,UAAKC,WAAL,GAAmB,EAAnB;AAEA,UAAKC,WAAL,GAAmBN,oBAAnB;AACA,UAAKO,YAAL,GAAoB,EAApB;AACA,UAAKC,cAAL,GAAsB,IAAtB;AACA,UAAKd,MAAL,GAAc,KAAd;AACA,UAAKe,cAAL,GAAsB,IAAtB;;AAEA,SAAK,IAAMC,GAAX,IAAkBR,KAAlB,EAAyB;AACvB,UAAMS,WAAW,GAAGT,KAAK,CAACQ,GAAD,CAAzB;;AAEA,cAAQC,WAAW,CAACC,IAApB;AACE,aAAK,SAAL;AACE,gBAAKT,YAAL,GAAoBQ,WAApB;AACA;;AAEF,aAAK,aAAL;AACE,gBAAKP,iBAAL,CAAuBS,IAAvB,CAA4BF,WAA5B;;AACA;;AAEF,aAAK,OAAL;AACE,gBAAKN,WAAL,CAAiBQ,IAAjB,CAAsBF,WAAtB;;AACA;;AACF;AAZF;AAcD;;AACD,UAAKG,mBAAL;;AAEA,UAAKpB,MAAL,GAAc,MAAKU,iBAAL,CAAuBW,IAAvB,CAA4B,UAAAC,KAAK;AAAA,aAAIA,KAAK,CAACtB,MAAV;AAAA,KAAjC,CAAd;AAhCiB;AAiClB;;;;4BAEOuB,E,QAAkD;AAAA,UAA7CC,MAA6C,QAA7CA,MAA6C;AAAA,UAArCC,SAAqC,QAArCA,SAAqC;AAAA,UAA1BC,gBAA0B,QAA1BA,gBAA0B;AAAA,UAARC,KAAQ,QAARA,KAAQ;AACxD,UAAI,CAAC,KAAK3B,MAAV,EAAkB,OAAO,EAAP;;AAGlB,UAAM4B,cAAc,GAAG,KAAKC,kBAAL,EAAvB;;AAEA,UAAI,KAAKhB,YAAL,CAAkBiB,MAAlB,KAA6B,CAAjC,EAAoC;AAClC,aAAKC,mBAAL,CAAyBR,EAAzB;AACD;;AACD,UAAI,CAAC,KAAKR,cAAV,EAA0B;AAExB,aAAKA,cAAL,GAAsBtB,cAAc,CAACuC,wBAAf,CAAwCT,EAAxC,CAAtB;;AACA,YAAIvB,MAAJ,EAAY;AACV,eAAKe,cAAL,CAAoBkB,gBAApB,CAAqCjC,MAArC;AACD;AACF;;AAED,UAAI,CAAC,KAAKc,cAAV,EAA0B;AACxB,aAAKA,cAAL,GAAsB,IAAItB,SAAJ,CAAc+B,EAAd,EAAkB;AACtCW,UAAAA,KAAK,EAAE,CAD+B;AAEtCC,UAAAA,MAAM,EAAE;AAF8B,SAAlB,CAAtB;AAID;;AAED,UAAMC,UAAU,GAAG,EAAnB;;AAEA,WAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKxB,YAAL,CAAkBiB,MAAtC,EAA8CO,CAAC,EAA/C,EAAmD;AACjD,YAAMC,UAAU,GAAG,KAAKzB,YAAL,CAAkBwB,CAAlB,CAAnB;AACAC,QAAAA,UAAU,CAACC,MAAX,CAAkB;AAChBf,UAAAA,MAAM,EAAEA,MAAM,CAACgB,MAAP,CAAc,UAAAC,KAAK;AAAA,mBAAIA,KAAK,CAACjC,KAAN,CAAYkC,aAAZ,KAA8B,KAAlC;AAAA,WAAnB,CADQ;AAEhBjB,UAAAA,SAAS,EAATA,SAFgB;AAGhBC,UAAAA,gBAAgB,EAAhBA,gBAHgB;AAIhBC,UAAAA,KAAK,EAALA,KAJgB;AAKhBgB,UAAAA,WAAW,EAAE;AACXC,YAAAA,aAAa,EAAEP,CADJ;AAEXvB,YAAAA,cAAc,EAAE,KAAKA,cAFV;AAGXc,YAAAA,cAAc,EAAdA;AAHW;AALG,SAAlB;AAWAQ,QAAAA,UAAU,CAACjB,IAAX,CAAgBmB,UAAU,CAACO,SAA3B;AACD;;AAED,aAAO;AACLT,QAAAA,UAAU,EAAVA,UADK;AAELtB,QAAAA,cAAc,EAAE,KAAKA,cAFhB;AAGLF,QAAAA,WAAW,EAAE,KAAKA,WAHb;AAILgB,QAAAA,cAAc,EAAdA;AAJK,OAAP;AAMD;;;kCAEaa,K,EAAO;AAAA,UACZhC,YADY,GACI,IADJ,CACZA,YADY;;AAEnB,UAAME,WAAW,GAAG,KAAKmC,wBAAL,CAA8BL,KAA9B,CAApB;;AACA,UAAM/B,iBAAiB,GAAG,KAAKqC,8BAAL,CAAoCN,KAApC,CAA1B;;AACA,aAAO;AACLO,QAAAA,YAAY,EAAE;AAACvC,UAAAA,YAAY,EAAZA,YAAD;AAAeC,UAAAA,iBAAiB,EAAjBA,iBAAf;AAAkCC,UAAAA,WAAW,EAAXA;AAAlC;AADT,OAAP;AAGD;;;8BAES;AAAA;AAAA;AAAA;;AAAA;AACR,6BAAyB,KAAKE,YAA9B,8HAA4C;AAAA,cAAjCyB,UAAiC;AAC1CA,UAAAA,UAAU,UAAV;AACD;AAHO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAIR,WAAKzB,YAAL,CAAkBiB,MAAlB,GAA2B,CAA3B;;AAEA,UAAI,KAAKhB,cAAT,EAAyB;AACvB,aAAKA,cAAL;AACA,aAAKA,cAAL,GAAsB,IAAtB;AACD;;AAED,UAAI,KAAKd,MAAL,IAAe,KAAKe,cAAxB,EAAwC;AACtC,aAAKA,cAAL,CAAoBkC,mBAApB,CAAwCjD,MAAxC;AACA,aAAKe,cAAL,GAAsB,IAAtB;AACD;AACF;;;yCAEoB;AACnB,UAAMmC,aAAa,GAAG,EAAtB;AADmB;AAAA;AAAA;;AAAA;AAEnB,8BAAoB,KAAKxC,iBAAzB,mIAA4C;AAAA,cAAjCY,KAAiC;AAC1C,cAAM6B,UAAU,GAAG,IAAIvD,OAAJ,GAAcwD,MAAd,CAAqB;AACtCC,YAAAA,GAAG,EAAE,IAAIxD,OAAJ,CAAYyB,KAAK,CAACjB,SAAlB,EAA6BiD,MAA7B;AADiC,WAArB,CAAnB;AAIAJ,UAAAA,aAAa,CAAC/B,IAAd,CAAmBgC,UAAnB;AACD;AARkB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AASnB,aAAOD,aAAP;AACD;;;wCAEmB3B,E,EAAI;AACtB,WAAK,IAAIc,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAK3B,iBAAL,CAAuBoB,MAA3C,EAAmDO,CAAC,EAApD,EAAwD;AACtD,aAAKxB,YAAL,CAAkBM,IAAlB,CAAuB,IAAIrB,UAAJ,CAAeyB,EAAf,CAAvB;AACD;AACF;;;0CAEqB;AAAA,UACbd,YADa,GACmC,IADnC,CACbA,YADa;AAAA,UACCE,WADD,GACmC,IADnC,CACCA,WADD;AAAA,UACcD,iBADd,GACmC,IADnC,CACcA,iBADd;;AAEpB,UAAI,CAACD,YAAD,IAAiBE,WAAW,CAACmB,MAAZ,KAAuB,CAAxC,IAA6CpB,iBAAiB,CAACoB,MAAlB,KAA6B,CAA9E,EAAiF;AAC/E,aAAKrB,YAAL,GAAoB,IAAIlB,YAAJ,CAAiBU,2BAAjB,CAApB;AACA,aAAKS,iBAAL,CAAuBS,IAAvB,CAA4B,IAAIzB,gBAAJ,CAAqBU,+BAA+B,CAAC,CAAD,CAApD,CAA5B;AACA,aAAKM,iBAAL,CAAuBS,IAAvB,CAA4B,IAAIzB,gBAAJ,CAAqBU,+BAA+B,CAAC,CAAD,CAApD,CAA5B;AACD;AACF;;;6CAEwBqC,K,EAAO;AAC9B,UAAMc,oBAAoB,GAAG,EAA7B;;AAEA,WAAK,IAAIlB,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAK1B,WAAL,CAAiBmB,MAArC,EAA6CO,CAAC,EAA9C,EAAkD;AAChD,YAAMmB,UAAU,GAAG,KAAK7C,WAAL,CAAiB0B,CAAjB,CAAnB;AACAkB,QAAAA,oBAAoB,CAACpC,IAArB,CAA0BqC,UAAU,CAACC,iBAAX,CAA6B;AAAChB,UAAAA,KAAK,EAALA;AAAD,SAA7B,CAA1B;AACD;;AACD,aAAOc,oBAAP;AACD;;;mDAE8Bd,K,EAAO;AACpC,UAAMiB,0BAA0B,GAAG,EAAnC;;AAEA,WAAK,IAAIrB,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAK3B,iBAAL,CAAuBoB,MAA3C,EAAmDO,CAAC,EAApD,EAAwD;AACtD,YAAMsB,gBAAgB,GAAG,KAAKjD,iBAAL,CAAuB2B,CAAvB,CAAzB;AACAqB,QAAAA,0BAA0B,CAACvC,IAA3B,CAAgCwC,gBAAgB,CAACF,iBAAjB,CAAmC;AAAChB,UAAAA,KAAK,EAALA;AAAD,SAAnC,CAAhC;AACD;;AACD,aAAOiB,0BAAP;AACD;;;;EA7JyC/D,M;;SAAvBY,c","sourcesContent":["import {AmbientLight, Texture2D, ProgramManager} from '@luma.gl/core';\nimport DirectionalLight from './directional-light';\nimport Effect from '../../lib/effect';\nimport {Matrix4, Vector3} from 'math.gl';\nimport ShadowPass from '../../passes/shadow-pass';\nimport {default as shadow} from '../../shaderlib/shadow/shadow';\n\nconst DEFAULT_AMBIENT_LIGHT_PROPS = {color: [255, 255, 255], intensity: 1.0};\nconst DEFAULT_DIRECTIONAL_LIGHT_PROPS = [\n  {\n    color: [255, 255, 255],\n    intensity: 1.0,\n    direction: [-1, -3, -1]\n  },\n  {\n    color: [255, 255, 255],\n    intensity: 0.9,\n    direction: [1, 8, -2.5]\n  }\n];\nconst DEFAULT_SHADOW_COLOR = [0, 0, 0, 200 / 255];\n\n// Class to manage ambient, point and directional light sources in deck\nexport default class LightingEffect extends Effect {\n  constructor(props) {\n    super(props);\n    this.ambientLight = null;\n    this.directionalLights = [];\n    this.pointLights = [];\n\n    this.shadowColor = DEFAULT_SHADOW_COLOR;\n    this.shadowPasses = [];\n    this.dummyShadowMap = null;\n    this.shadow = false;\n    this.programManager = null;\n\n    for (const key in props) {\n      const lightSource = props[key];\n\n      switch (lightSource.type) {\n        case 'ambient':\n          this.ambientLight = lightSource;\n          break;\n\n        case 'directional':\n          this.directionalLights.push(lightSource);\n          break;\n\n        case 'point':\n          this.pointLights.push(lightSource);\n          break;\n        default:\n      }\n    }\n    this._applyDefaultLights();\n\n    this.shadow = this.directionalLights.some(light => light.shadow);\n  }\n\n  prepare(gl, {layers, viewports, onViewportActive, views}) {\n    if (!this.shadow) return {};\n\n    // create light matrix every frame to make sure always updated from light source\n    const shadowMatrices = this._createLightMatrix();\n\n    if (this.shadowPasses.length === 0) {\n      this._createShadowPasses(gl);\n    }\n    if (!this.programManager) {\n      // TODO - support multiple contexts\n      this.programManager = ProgramManager.getDefaultProgramManager(gl);\n      if (shadow) {\n        this.programManager.addDefaultModule(shadow);\n      }\n    }\n\n    if (!this.dummyShadowMap) {\n      this.dummyShadowMap = new Texture2D(gl, {\n        width: 1,\n        height: 1\n      });\n    }\n\n    const shadowMaps = [];\n\n    for (let i = 0; i < this.shadowPasses.length; i++) {\n      const shadowPass = this.shadowPasses[i];\n      shadowPass.render({\n        layers: layers.filter(layer => layer.props.shadowEnabled !== false),\n        viewports,\n        onViewportActive,\n        views,\n        effectProps: {\n          shadowLightId: i,\n          dummyShadowMap: this.dummyShadowMap,\n          shadowMatrices\n        }\n      });\n      shadowMaps.push(shadowPass.shadowMap);\n    }\n\n    return {\n      shadowMaps,\n      dummyShadowMap: this.dummyShadowMap,\n      shadowColor: this.shadowColor,\n      shadowMatrices\n    };\n  }\n\n  getParameters(layer) {\n    const {ambientLight} = this;\n    const pointLights = this._getProjectedPointLights(layer);\n    const directionalLights = this._getProjectedDirectionalLights(layer);\n    return {\n      lightSources: {ambientLight, directionalLights, pointLights}\n    };\n  }\n\n  cleanup() {\n    for (const shadowPass of this.shadowPasses) {\n      shadowPass.delete();\n    }\n    this.shadowPasses.length = 0;\n\n    if (this.dummyShadowMap) {\n      this.dummyShadowMap.delete();\n      this.dummyShadowMap = null;\n    }\n\n    if (this.shadow && this.programManager) {\n      this.programManager.removeDefaultModule(shadow);\n      this.programManager = null;\n    }\n  }\n\n  _createLightMatrix() {\n    const lightMatrices = [];\n    for (const light of this.directionalLights) {\n      const viewMatrix = new Matrix4().lookAt({\n        eye: new Vector3(light.direction).negate()\n      });\n\n      lightMatrices.push(viewMatrix);\n    }\n    return lightMatrices;\n  }\n\n  _createShadowPasses(gl) {\n    for (let i = 0; i < this.directionalLights.length; i++) {\n      this.shadowPasses.push(new ShadowPass(gl));\n    }\n  }\n\n  _applyDefaultLights() {\n    const {ambientLight, pointLights, directionalLights} = this;\n    if (!ambientLight && pointLights.length === 0 && directionalLights.length === 0) {\n      this.ambientLight = new AmbientLight(DEFAULT_AMBIENT_LIGHT_PROPS);\n      this.directionalLights.push(new DirectionalLight(DEFAULT_DIRECTIONAL_LIGHT_PROPS[0]));\n      this.directionalLights.push(new DirectionalLight(DEFAULT_DIRECTIONAL_LIGHT_PROPS[1]));\n    }\n  }\n\n  _getProjectedPointLights(layer) {\n    const projectedPointLights = [];\n\n    for (let i = 0; i < this.pointLights.length; i++) {\n      const pointLight = this.pointLights[i];\n      projectedPointLights.push(pointLight.getProjectedLight({layer}));\n    }\n    return projectedPointLights;\n  }\n\n  _getProjectedDirectionalLights(layer) {\n    const projectedDirectionalLights = [];\n\n    for (let i = 0; i < this.directionalLights.length; i++) {\n      const directionalLight = this.directionalLights[i];\n      projectedDirectionalLights.push(directionalLight.getProjectedLight({layer}));\n    }\n    return projectedDirectionalLights;\n  }\n}\n"],"file":"lighting-effect.js"}