{"version":3,"sources":["../../../src/lib/attribute-manager.js"],"names":["Attribute","log","AttributeTransitionManager","LOG_START_END_PRIORITY","LOG_DETAIL_PRIORITY","noop","logFunctions","savedMessages","timeStart","onLog","level","message","onUpdateStart","numInstances","Date","onUpdate","push","onUpdateEnd","id","timeMs","Math","round","time","group","collapsed","groupEnd","AttributeManager","setDefaultLogFunctions","undefined","constructor","gl","stats","timeline","attributes","updateTriggers","accessors","needsRedraw","userData","attributeTransitionManager","Object","seal","finalize","attributeName","delete","getNeedsRedraw","opts","clearRedrawFlags","redraw","setNeedsRedraw","add","updaters","_add","addInstanced","instanced","remove","attributeNameArray","i","length","name","invalidate","triggerName","dataRange","invalidatedAttributes","_invalidateTrigger","invalidateAll","setNeedsUpdate","update","data","bufferLayout","transitions","props","buffers","context","updated","get","attribute","setExternalBuffer","setConstantValue","getAccessor","needsUpdate","_updateAttribute","timeEnd","updateTransition","transitionUpdated","run","getAttributes","getChangedAttributes","clearChangedFlags","changedAttributes","assign","hasAttribute","getAccessors","extraProps","warn","newAttributes","newAttribute","_createAttribute","_mapUpdateTriggersToAttributes","constant","isIndexed","elements","size","value","divisor","triggers","getUpdateTriggers","forEach","keys","join","allocate","now","updateBuffer"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n/* eslint-disable guard-for-in */\nimport Attribute from './attribute';\nimport log from '../utils/log';\n\nimport AttributeTransitionManager from './attribute-transition-manager';\n\nconst LOG_START_END_PRIORITY = 2;\nconst LOG_DETAIL_PRIORITY = 3;\n\nfunction noop() {}\n\n// Default loggers\nconst logFunctions = {\n  savedMessages: null,\n  timeStart: null,\n  onLog: ({level, message}) => {\n    log.log(level, message)();\n  },\n  onUpdateStart: ({level, numInstances}) => {\n    logFunctions.savedMessages = [];\n    logFunctions.timeStart = new Date();\n  },\n  onUpdate: ({level, message}) => {\n    if (logFunctions.savedMessages) {\n      logFunctions.savedMessages.push(message);\n    }\n  },\n  onUpdateEnd: ({level, id, numInstances}) => {\n    const timeMs = Math.round(new Date() - logFunctions.timeStart);\n    const time = `${timeMs}ms`;\n    log.group(level, `Updated attributes for ${numInstances} instances in ${id} in ${time}`, {\n      collapsed: true\n    })();\n    for (const message of logFunctions.savedMessages) {\n      log.log(level, message)();\n    }\n    log.groupEnd(level, `Updated attributes for ${numInstances} instances in ${id} in ${time}`)();\n    logFunctions.savedMessages = null;\n  }\n};\n\nexport default class AttributeManager {\n  /**\n   * Sets log functions to help trace or time attribute updates.\n   * Default logging uses deck logger.\n   *\n   * `onLog` is called for each attribute.\n   *\n   * To enable detailed control of timming and e.g. hierarchical logging,\n   * hooks are also provided for update start and end.\n   *\n   * @param {Object} [opts]\n   * @param {String} [onLog=] - called to print\n   * @param {String} [onUpdateStart=] - called before update() starts\n   * @param {String} [onUpdateEnd=] - called after update() ends\n   */\n  static setDefaultLogFunctions({onLog, onUpdateStart, onUpdate, onUpdateEnd} = {}) {\n    if (onLog !== undefined) {\n      logFunctions.onLog = onLog || noop;\n    }\n    if (onUpdateStart !== undefined) {\n      logFunctions.onUpdateStart = onUpdateStart || noop;\n    }\n    if (onUpdate !== undefined) {\n      logFunctions.onUpdate = onUpdate || noop;\n    }\n    if (onUpdateEnd !== undefined) {\n      logFunctions.onUpdateEnd = onUpdateEnd || noop;\n    }\n  }\n\n  /**\n   * @classdesc\n   * Automated attribute generation and management. Suitable when a set of\n   * vertex shader attributes are generated by iteration over a data array,\n   * and updates to these attributes are needed either when the data itself\n   * changes, or when other data relevant to the calculations change.\n   *\n   * - First the application registers descriptions of its dynamic vertex\n   *   attributes using AttributeManager.add().\n   * - Then, when any change that affects attributes is detected by the\n   *   application, the app will call AttributeManager.invalidate().\n   * - Finally before it renders, it calls AttributeManager.update() to\n   *   ensure that attributes are automatically rebuilt if anything has been\n   *   invalidated.\n   *\n   * The application provided update functions describe how attributes\n   * should be updated from a data array and are expected to traverse\n   * that data array (or iterable) and fill in the attribute's typed array.\n   *\n   * Note that the attribute manager intentionally does not do advanced\n   * change detection, but instead makes it easy to build such detection\n   * by offering the ability to \"invalidate\" each attribute separately.\n   */\n  constructor(gl, {id = 'attribute-manager', stats, timeline} = {}) {\n    this.id = id;\n    this.gl = gl;\n\n    this.attributes = {};\n\n    this.updateTriggers = {};\n    this.accessors = {};\n    this.needsRedraw = true;\n\n    this.userData = {};\n    this.stats = stats;\n\n    this.attributeTransitionManager = new AttributeTransitionManager(gl, {\n      id: `${id}-transitions`,\n      timeline\n    });\n\n    // For debugging sanity, prevent uninitialized members\n    Object.seal(this);\n  }\n\n  finalize() {\n    for (const attributeName in this.attributes) {\n      this.attributes[attributeName].delete();\n    }\n    this.attributeTransitionManager.finalize();\n  }\n\n  // Returns the redraw flag, optionally clearing it.\n  // Redraw flag will be set if any attributes attributes changed since\n  // flag was last cleared.\n  //\n  // @param {String} [clearRedrawFlags=false] - whether to clear the flag\n  // @return {false|String} - reason a redraw is needed.\n  getNeedsRedraw(opts = {clearRedrawFlags: false}) {\n    const redraw = this.needsRedraw;\n    this.needsRedraw = this.needsRedraw && !opts.clearRedrawFlags;\n    return redraw && this.id;\n  }\n\n  // Sets the redraw flag.\n  // @param {Boolean} redraw=true\n  // @return {AttributeManager} - for chaining\n  setNeedsRedraw(redraw = true) {\n    this.needsRedraw = true;\n    return this;\n  }\n\n  // Adds attributes\n  add(attributes, updaters) {\n    this._add(attributes, updaters);\n  }\n\n  // Adds attributes\n  addInstanced(attributes, updaters) {\n    this._add(attributes, updaters, {instanced: 1});\n  }\n\n  /**\n   * Removes attributes\n   * Takes an array of attribute names and delete them from\n   * the attribute map if they exists\n   *\n   * @example\n   * attributeManager.remove(['position']);\n   *\n   * @param {Object} attributeNameArray - attribute name array (see above)\n   */\n  remove(attributeNameArray) {\n    for (let i = 0; i < attributeNameArray.length; i++) {\n      const name = attributeNameArray[i];\n      if (this.attributes[name] !== undefined) {\n        this.attributes[name].delete();\n        delete this.attributes[name];\n      }\n    }\n  }\n\n  // Marks an attribute for update\n  invalidate(triggerName, dataRange) {\n    const invalidatedAttributes = this._invalidateTrigger(triggerName, dataRange);\n    // For performance tuning\n    logFunctions.onLog({\n      level: LOG_DETAIL_PRIORITY,\n      message: `invalidated attributes ${invalidatedAttributes} (${triggerName}) for ${this.id}`\n    });\n  }\n\n  invalidateAll(dataRange) {\n    for (const attributeName in this.attributes) {\n      this.attributes[attributeName].setNeedsUpdate(attributeName, dataRange);\n    }\n    // For performance tuning\n    logFunctions.onLog({\n      level: LOG_DETAIL_PRIORITY,\n      message: `invalidated all attributes for ${this.id}`\n    });\n  }\n\n  // Ensure all attribute buffers are updated from props or data.\n  update({\n    data,\n    numInstances,\n    bufferLayout,\n    transitions,\n    props = {},\n    buffers = {},\n    context = {}\n  } = {}) {\n    // keep track of whether some attributes are updated\n    let updated = false;\n\n    logFunctions.onUpdateStart({level: LOG_START_END_PRIORITY, id: this.id, numInstances});\n    if (this.stats) {\n      this.stats.get('Update Attributes').timeStart();\n    }\n\n    for (const attributeName in this.attributes) {\n      const attribute = this.attributes[attributeName];\n\n      if (\n        attribute.setExternalBuffer(\n          buffers[attributeName] || (data.attributes && data.attributes[attributeName])\n        )\n      ) {\n        // Attribute is using external buffer from the props\n      } else if (attribute.setConstantValue(props[attribute.getAccessor()])) {\n        // Attribute is using generic value from the props\n      } else if (attribute.needsUpdate()) {\n        updated = true;\n        this._updateAttribute({\n          attribute,\n          numInstances,\n          bufferLayout,\n          data,\n          props,\n          context\n        });\n      }\n\n      this.needsRedraw |= attribute.needsRedraw();\n    }\n\n    if (updated) {\n      // Only initiate alloc/update (and logging) if actually needed\n      logFunctions.onUpdateEnd({level: LOG_START_END_PRIORITY, id: this.id, numInstances});\n    }\n\n    if (this.stats) {\n      this.stats.get('Update Attributes').timeEnd();\n    }\n\n    this.attributeTransitionManager.update({\n      attributes: this.attributes,\n      numInstances,\n      transitions\n    });\n  }\n\n  // Update attribute transition to the current timestamp\n  // Returns `true` if any transition is in progress\n  updateTransition() {\n    const {attributeTransitionManager} = this;\n    const transitionUpdated = attributeTransitionManager.run();\n    this.needsRedraw = this.needsRedraw || transitionUpdated;\n    return transitionUpdated;\n  }\n\n  /**\n   * Returns all attribute descriptors\n   * Note: Format matches luma.gl Model/Program.setAttributes()\n   * @return {Object} attributes - descriptors\n   */\n  getAttributes() {\n    return this.attributes;\n  }\n\n  /**\n   * Returns changed attribute descriptors\n   * This indicates which WebGLBuffers need to be updated\n   * @return {Object} attributes - descriptors\n   */\n  getChangedAttributes(opts = {clearChangedFlags: false}) {\n    const {attributes, attributeTransitionManager} = this;\n\n    const changedAttributes = Object.assign({}, attributeTransitionManager.getAttributes());\n\n    for (const attributeName in attributes) {\n      const attribute = attributes[attributeName];\n      if (attribute.needsRedraw(opts) && !attributeTransitionManager.hasAttribute(attributeName)) {\n        changedAttributes[attributeName] = attribute;\n      }\n    }\n\n    return changedAttributes;\n  }\n\n  // PROTECTED METHODS - Only to be used by collaborating classes, not by apps\n\n  // Returns object containing all accessors as keys, with non-null values\n  // @return {Object} - accessors object\n  getAccessors() {\n    return this.updateTriggers;\n  }\n\n  // PRIVATE METHODS\n\n  // Used to register an attribute\n  _add(attributes, updaters, extraProps = {}) {\n    if (updaters) {\n      log.warn('AttributeManager.add({updaters}) - updater map no longer supported')();\n    }\n\n    const newAttributes = {};\n\n    for (const attributeName in attributes) {\n      const attribute = attributes[attributeName];\n\n      // Initialize the attribute descriptor, with WebGL and metadata fields\n      const newAttribute = this._createAttribute(attributeName, attribute, extraProps);\n\n      newAttributes[attributeName] = newAttribute;\n    }\n\n    Object.assign(this.attributes, newAttributes);\n\n    this._mapUpdateTriggersToAttributes();\n  }\n  /* eslint-enable max-statements */\n\n  _createAttribute(name, attribute, extraProps) {\n    const props = {\n      id: name,\n      // Luma fields\n      constant: attribute.constant || false,\n      isIndexed: attribute.isIndexed || attribute.elements,\n      size: (attribute.elements && 1) || attribute.size,\n      value: attribute.value || null,\n      divisor: attribute.instanced || extraProps.instanced ? 1 : attribute.divisor\n    };\n\n    return new Attribute(this.gl, Object.assign({}, attribute, props));\n  }\n\n  // build updateTrigger name to attribute name mapping\n  _mapUpdateTriggersToAttributes() {\n    const triggers = {};\n\n    for (const attributeName in this.attributes) {\n      const attribute = this.attributes[attributeName];\n      attribute.getUpdateTriggers().forEach(triggerName => {\n        if (!triggers[triggerName]) {\n          triggers[triggerName] = [];\n        }\n        triggers[triggerName].push(attributeName);\n      });\n    }\n\n    this.updateTriggers = triggers;\n  }\n\n  _invalidateTrigger(triggerName, dataRange) {\n    const {attributes, updateTriggers} = this;\n    const invalidatedAttributes = updateTriggers[triggerName];\n\n    if (invalidatedAttributes) {\n      invalidatedAttributes.forEach(name => {\n        const attribute = attributes[name];\n        if (attribute) {\n          attribute.setNeedsUpdate(attribute.id, dataRange);\n        }\n      });\n    } else {\n      let message = `invalidating non-existent trigger ${triggerName} for ${this.id}\\n`;\n      message += `Valid triggers: ${Object.keys(attributes).join(', ')}`;\n      log.warn(message, invalidatedAttributes)();\n    }\n    return invalidatedAttributes;\n  }\n\n  _updateAttribute(opts) {\n    const {attribute, numInstances} = opts;\n\n    if (attribute.allocate(numInstances)) {\n      logFunctions.onUpdate({\n        level: LOG_DETAIL_PRIORITY,\n        message: `${attribute.id} allocated ${numInstances}`,\n        id: this.id\n      });\n    }\n\n    // Calls update on any buffers that need update\n    const timeStart = Date.now();\n\n    const updated = attribute.updateBuffer(opts);\n    if (updated) {\n      this.needsRedraw = true;\n\n      const timeMs = Math.round(Date.now() - timeStart);\n      logFunctions.onUpdate({\n        level: LOG_DETAIL_PRIORITY,\n        message: `${attribute.id} updated ${numInstances} in ${timeMs}ms`\n      });\n    }\n  }\n}\n"],"file":"attribute-manager.js"}