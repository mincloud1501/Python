{"version":3,"sources":["../../../src/viewports/viewport.js"],"names":["log","createMat4","extractCameraVectors","getFrustumPlanes","Matrix4","Vector3","equals","mat4","getDistanceScales","getMeterZoom","lngLatToWorld","worldToLngLat","worldToPixels","pixelsToWorld","assert","DEGREES_TO_RADIANS","Math","PI","IDENTITY","ZERO_VECTOR","DEFAULT_ZOOM","Viewport","constructor","opts","id","x","y","width","height","displayName","_frustumPlanes","_initViewMatrix","_initProjectionMatrix","_initPixelMatrices","bind","project","unproject","projectPosition","unprojectPosition","projectFlat","unprojectFlat","getMatrices","viewport","scale","projectionMatrix","viewMatrix","xyz","topLeft","worldPosition","coord","pixelProjectionMatrix","y2","length","targetZ","z","targetZWorld","distanceScales","pixelsPerMeter","pixelUnprojectionMatrix","X","Y","Z","Number","isFinite","metersPerPixel","isGeospatial","coordinateOrigin","longitude","latitude","highPrecision","modelMatrix","modelViewProjectionMatrix","viewProjectionMatrix","multiply","invert","matrices","Object","assign","containsPixel","near","far","fovyRadians","aspect","projectionProps","position","cameraPosition","direction","cameraDirection","up","cameraUp","right","cameraRight","getCameraPosition","getCameraDirection","getCameraUp","_createProjectionMatrix","orthographic","focalDistance","fovy","perspective","zoom","log2","pow","meterOffset","transformVector","center","_getCenterInWorld","viewMatrixUncentered","multiplyRight","translate","negate","center2d","pixelPosition","add","fovyDegrees","orthographicFocalDistance","radians","vpm","viewMatrixInverse","eye","viewportMatrix","warn"],"mappings":"AAoBA,OAAOA,GAAP,MAAgB,cAAhB;AACA,SAAQC,UAAR,EAAoBC,oBAApB,EAA0CC,gBAA1C,QAAiE,qBAAjE;AAEA,SAAQC,OAAR,EAAiBC,OAAjB,EAA0BC,MAA1B,QAAuC,SAAvC;AACA,OAAO,KAAKC,IAAZ,MAAsB,gBAAtB;AAEA,SACEC,iBADF,EAEEC,YAFF,EAGEC,aAHF,EAIEC,aAJF,EAKEC,aALF,EAMEC,aANF,QAOO,2BAPP;AASA,OAAOC,MAAP,MAAmB,iBAAnB;AAEA,MAAMC,kBAAkB,GAAGC,IAAI,CAACC,EAAL,GAAU,GAArC;AAEA,MAAMC,QAAQ,GAAGjB,UAAU,EAA3B;AAEA,MAAMkB,WAAW,GAAG,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAApB;AAEA,MAAMC,YAAY,GAAG,CAArB;AAEA,eAAe,MAAMC,QAAN,CAAe;AAQ5BC,EAAAA,WAAW,CAACC,IAAI,GAAG,EAAR,EAAY;AACrB,UAAM;AACJC,MAAAA,EAAE,GAAG,IADD;AAGJC,MAAAA,CAAC,GAAG,CAHA;AAIJC,MAAAA,CAAC,GAAG,CAJA;AAKJC,MAAAA,KAAK,GAAG,CALJ;AAMJC,MAAAA,MAAM,GAAG;AANL,QAOFL,IAPJ;AASA,SAAKC,EAAL,GAAUA,EAAE,IAAI,KAAKF,WAAL,CAAiBO,WAAvB,IAAsC,UAAhD;AAEA,SAAKJ,CAAL,GAASA,CAAT;AACA,SAAKC,CAAL,GAASA,CAAT;AAEA,SAAKC,KAAL,GAAaA,KAAK,IAAI,CAAtB;AACA,SAAKC,MAAL,GAAcA,MAAM,IAAI,CAAxB;AACA,SAAKE,cAAL,GAAsB,EAAtB;;AAEA,SAAKC,eAAL,CAAqBR,IAArB;;AACA,SAAKS,qBAAL,CAA2BT,IAA3B;;AACA,SAAKU,kBAAL;;AAGA,SAAK3B,MAAL,GAAc,KAAKA,MAAL,CAAY4B,IAAZ,CAAiB,IAAjB,CAAd;AACA,SAAKC,OAAL,GAAe,KAAKA,OAAL,CAAaD,IAAb,CAAkB,IAAlB,CAAf;AACA,SAAKE,SAAL,GAAiB,KAAKA,SAAL,CAAeF,IAAf,CAAoB,IAApB,CAAjB;AACA,SAAKG,eAAL,GAAuB,KAAKA,eAAL,CAAqBH,IAArB,CAA0B,IAA1B,CAAvB;AACA,SAAKI,iBAAL,GAAyB,KAAKA,iBAAL,CAAuBJ,IAAvB,CAA4B,IAA5B,CAAzB;AACA,SAAKK,WAAL,GAAmB,KAAKA,WAAL,CAAiBL,IAAjB,CAAsB,IAAtB,CAAnB;AACA,SAAKM,aAAL,GAAqB,KAAKA,aAAL,CAAmBN,IAAnB,CAAwB,IAAxB,CAArB;AACA,SAAKO,WAAL,GAAmB,KAAKA,WAAL,CAAiBP,IAAjB,CAAsB,IAAtB,CAAnB;AACD;;AAID5B,EAAAA,MAAM,CAACoC,QAAD,EAAW;AACf,QAAI,EAAEA,QAAQ,YAAYrB,QAAtB,CAAJ,EAAqC;AACnC,aAAO,KAAP;AACD;;AAED,WACEqB,QAAQ,CAACf,KAAT,KAAmB,KAAKA,KAAxB,IACAe,QAAQ,CAACd,MAAT,KAAoB,KAAKA,MADzB,IAEAc,QAAQ,CAACC,KAAT,KAAmB,KAAKA,KAFxB,IAGArC,MAAM,CAACoC,QAAQ,CAACE,gBAAV,EAA4B,KAAKA,gBAAjC,CAHN,IAIAtC,MAAM,CAACoC,QAAQ,CAACG,UAAV,EAAsB,KAAKA,UAA3B,CALR;AAQD;;AAcDV,EAAAA,OAAO,CAACW,GAAD,EAAM;AAACC,IAAAA,OAAO,GAAG;AAAX,MAAmB,EAAzB,EAA6B;AAClC,UAAMC,aAAa,GAAG,KAAKX,eAAL,CAAqBS,GAArB,CAAtB;AACA,UAAMG,KAAK,GAAGrC,aAAa,CAACoC,aAAD,EAAgB,KAAKE,qBAArB,CAA3B;AAEA,UAAM,CAACzB,CAAD,EAAIC,CAAJ,IAASuB,KAAf;AACA,UAAME,EAAE,GAAGJ,OAAO,GAAGrB,CAAH,GAAO,KAAKE,MAAL,GAAcF,CAAvC;AACA,WAAOoB,GAAG,CAACM,MAAJ,KAAe,CAAf,GAAmB,CAAC3B,CAAD,EAAI0B,EAAJ,CAAnB,GAA6B,CAAC1B,CAAD,EAAI0B,EAAJ,EAAQF,KAAK,CAAC,CAAD,CAAb,CAApC;AACD;;AAYDb,EAAAA,SAAS,CAACU,GAAD,EAAM;AAACC,IAAAA,OAAO,GAAG,IAAX;AAAiBM,IAAAA;AAAjB,MAA4B,EAAlC,EAAsC;AAC7C,UAAM,CAAC5B,CAAD,EAAIC,CAAJ,EAAO4B,CAAP,IAAYR,GAAlB;AAEA,UAAMK,EAAE,GAAGJ,OAAO,GAAGrB,CAAH,GAAO,KAAKE,MAAL,GAAcF,CAAvC;AACA,UAAM6B,YAAY,GAAGF,OAAO,IAAIA,OAAO,GAAG,KAAKG,cAAL,CAAoBC,cAApB,CAAmC,CAAnC,CAA1C;AACA,UAAMR,KAAK,GAAGpC,aAAa,CAAC,CAACY,CAAD,EAAI0B,EAAJ,EAAQG,CAAR,CAAD,EAAa,KAAKI,uBAAlB,EAA2CH,YAA3C,CAA3B;AACA,UAAM,CAACI,CAAD,EAAIC,CAAJ,EAAOC,CAAP,IAAY,KAAKvB,iBAAL,CAAuBW,KAAvB,CAAlB;;AAEA,QAAIa,MAAM,CAACC,QAAP,CAAgBT,CAAhB,CAAJ,EAAwB;AACtB,aAAO,CAACK,CAAD,EAAIC,CAAJ,EAAOC,CAAP,CAAP;AACD;;AACD,WAAOC,MAAM,CAACC,QAAP,CAAgBV,OAAhB,IAA2B,CAACM,CAAD,EAAIC,CAAJ,EAAOP,OAAP,CAA3B,GAA6C,CAACM,CAAD,EAAIC,CAAJ,CAApD;AACD;;AAKDvB,EAAAA,eAAe,CAACS,GAAD,EAAM;AACnB,UAAM,CAACa,CAAD,EAAIC,CAAJ,IAAS,KAAKrB,WAAL,CAAiBO,GAAjB,CAAf;AACA,UAAMe,CAAC,GAAG,CAACf,GAAG,CAAC,CAAD,CAAH,IAAU,CAAX,IAAgB,KAAKU,cAAL,CAAoBC,cAApB,CAAmC,CAAnC,CAA1B;AACA,WAAO,CAACE,CAAD,EAAIC,CAAJ,EAAOC,CAAP,CAAP;AACD;;AAEDvB,EAAAA,iBAAiB,CAACQ,GAAD,EAAM;AACrB,UAAM,CAACa,CAAD,EAAIC,CAAJ,IAAS,KAAKpB,aAAL,CAAmBM,GAAnB,CAAf;AACA,UAAMe,CAAC,GAAG,CAACf,GAAG,CAAC,CAAD,CAAH,IAAU,CAAX,IAAgB,KAAKU,cAAL,CAAoBQ,cAApB,CAAmC,CAAnC,CAA1B;AACA,WAAO,CAACL,CAAD,EAAIC,CAAJ,EAAOC,CAAP,CAAP;AACD;;AAWDtB,EAAAA,WAAW,CAACO,GAAD,EAAMH,KAAK,GAAG,KAAKA,KAAnB,EAA0B;AACnC,QAAI,KAAKsB,YAAT,EAAuB;AACrB,aAAOvD,aAAa,CAACoC,GAAD,EAAMH,KAAN,CAApB;AACD;;AACD,UAAM;AAACc,MAAAA;AAAD,QAAmB,KAAKD,cAA9B;AACA,WAAO,CAACV,GAAG,CAAC,CAAD,CAAH,GAASW,cAAc,CAAC,CAAD,CAAxB,EAA6BX,GAAG,CAAC,CAAD,CAAH,GAASW,cAAc,CAAC,CAAD,CAApD,CAAP;AACD;;AAUDjB,EAAAA,aAAa,CAACM,GAAD,EAAMH,KAAK,GAAG,KAAKA,KAAnB,EAA0B;AACrC,QAAI,KAAKsB,YAAT,EAAuB;AACrB,aAAOtD,aAAa,CAACmC,GAAD,EAAMH,KAAN,CAApB;AACD;;AACD,UAAM;AAACqB,MAAAA;AAAD,QAAmB,KAAKR,cAA9B;AACA,WAAO,CAACV,GAAG,CAAC,CAAD,CAAH,GAASkB,cAAc,CAAC,CAAD,CAAxB,EAA6BlB,GAAG,CAAC,CAAD,CAAH,GAASkB,cAAc,CAAC,CAAD,CAApD,CAAP;AACD;;AAEDxD,EAAAA,iBAAiB,CAAC0D,gBAAgB,GAAG,IAApB,EAA0B;AACzC,QAAIA,gBAAJ,EAAsB;AACpB,aAAO1D,iBAAiB,CAAC;AACvB2D,QAAAA,SAAS,EAAED,gBAAgB,CAAC,CAAD,CADJ;AAEvBE,QAAAA,QAAQ,EAAEF,gBAAgB,CAAC,CAAD,CAFH;AAGvBvB,QAAAA,KAAK,EAAE,KAAKA,KAHW;AAIvB0B,QAAAA,aAAa,EAAE;AAJQ,OAAD,CAAxB;AAMD;;AACD,WAAO,KAAKb,cAAZ;AACD;;AAEDf,EAAAA,WAAW,CAAC;AAAC6B,IAAAA,WAAW,GAAG;AAAf,MAAuB,EAAxB,EAA4B;AACrC,QAAIC,yBAAyB,GAAG,KAAKC,oBAArC;AACA,QAAItB,qBAAqB,GAAG,KAAKA,qBAAjC;AACA,QAAIQ,uBAAuB,GAAG,KAAKA,uBAAnC;;AAEA,QAAIY,WAAJ,EAAiB;AACfC,MAAAA,yBAAyB,GAAGhE,IAAI,CAACkE,QAAL,CAAc,EAAd,EAAkB,KAAKD,oBAAvB,EAA6CF,WAA7C,CAA5B;AACApB,MAAAA,qBAAqB,GAAG3C,IAAI,CAACkE,QAAL,CAAc,EAAd,EAAkB,KAAKvB,qBAAvB,EAA8CoB,WAA9C,CAAxB;AACAZ,MAAAA,uBAAuB,GAAGnD,IAAI,CAACmE,MAAL,CAAY,EAAZ,EAAgBxB,qBAAhB,CAA1B;AACD;;AAED,UAAMyB,QAAQ,GAAGC,MAAM,CAACC,MAAP,CAAc;AAC7BN,MAAAA,yBAD6B;AAE7BC,MAAAA,oBAAoB,EAAE,KAAKA,oBAFE;AAG7B3B,MAAAA,UAAU,EAAE,KAAKA,UAHY;AAI7BD,MAAAA,gBAAgB,EAAE,KAAKA,gBAJM;AAO7BM,MAAAA,qBAP6B;AAQ7BQ,MAAAA,uBAR6B;AAU7B/B,MAAAA,KAAK,EAAE,KAAKA,KAViB;AAW7BC,MAAAA,MAAM,EAAE,KAAKA,MAXgB;AAY7Be,MAAAA,KAAK,EAAE,KAAKA;AAZiB,KAAd,CAAjB;AAeA,WAAOgC,QAAP;AACD;;AAEDG,EAAAA,aAAa,CAAC;AAACrD,IAAAA,CAAD;AAAIC,IAAAA,CAAJ;AAAOC,IAAAA,KAAK,GAAG,CAAf;AAAkBC,IAAAA,MAAM,GAAG;AAA3B,GAAD,EAAgC;AAC3C,WACEH,CAAC,GAAG,KAAKA,CAAL,GAAS,KAAKE,KAAlB,IACA,KAAKF,CAAL,GAASA,CAAC,GAAGE,KADb,IAEAD,CAAC,GAAG,KAAKA,CAAL,GAAS,KAAKE,MAFlB,IAGA,KAAKF,CAAL,GAASA,CAAC,GAAGE,MAJf;AAMD;;AAGDzB,EAAAA,gBAAgB,GAAG;AACjB,QAAI,KAAK2B,cAAL,CAAoBiD,IAAxB,EAA8B;AAC5B,aAAO,KAAKjD,cAAZ;AACD;;AAED,UAAM;AAACiD,MAAAA,IAAD;AAAOC,MAAAA,GAAP;AAAYC,MAAAA,WAAZ;AAAyBC,MAAAA;AAAzB,QAAmC,KAAKC,eAA9C;AAEAP,IAAAA,MAAM,CAACC,MAAP,CACE,KAAK/C,cADP,EAEE3B,gBAAgB,CAAC;AACf+E,MAAAA,MADe;AAEfH,MAAAA,IAFe;AAGfC,MAAAA,GAHe;AAIfC,MAAAA,WAJe;AAKfG,MAAAA,QAAQ,EAAE,KAAKC,cALA;AAMfC,MAAAA,SAAS,EAAE,KAAKC,eAND;AAOfC,MAAAA,EAAE,EAAE,KAAKC,QAPM;AAQfC,MAAAA,KAAK,EAAE,KAAKC;AARG,KAAD,CAFlB;AAcA,WAAO,KAAK7D,cAAZ;AACD;;AAID8D,EAAAA,iBAAiB,GAAG;AAClB,WAAO,KAAKP,cAAZ;AACD;;AAEDQ,EAAAA,kBAAkB,GAAG;AACnB,WAAO,KAAKN,eAAZ;AACD;;AAEDO,EAAAA,WAAW,GAAG;AACZ,WAAO,KAAKL,QAAZ;AACD;;AAIDM,EAAAA,uBAAuB,CAAC;AAACC,IAAAA,YAAD;AAAef,IAAAA,WAAf;AAA4BC,IAAAA,MAA5B;AAAoCe,IAAAA,aAApC;AAAmDlB,IAAAA,IAAnD;AAAyDC,IAAAA;AAAzD,GAAD,EAAgE;AACrFlE,IAAAA,MAAM,CAACgD,MAAM,CAACC,QAAP,CAAgBkB,WAAhB,CAAD,CAAN;AACA,WAAOe,YAAY,GACf,IAAI5F,OAAJ,GAAc4F,YAAd,CAA2B;AAACE,MAAAA,IAAI,EAAEjB,WAAP;AAAoBC,MAAAA,MAApB;AAA4Be,MAAAA,aAA5B;AAA2ClB,MAAAA,IAA3C;AAAiDC,MAAAA;AAAjD,KAA3B,CADe,GAEf,IAAI5E,OAAJ,GAAc+F,WAAd,CAA0B;AAACD,MAAAA,IAAI,EAAEjB,WAAP;AAAoBC,MAAAA,MAApB;AAA4BH,MAAAA,IAA5B;AAAkCC,MAAAA;AAAlC,KAA1B,CAFJ;AAGD;;AAGDjD,EAAAA,eAAe,CAACR,IAAD,EAAO;AACpB,UAAM;AAEJsB,MAAAA,UAAU,GAAG3B,QAFT;AAIJiD,MAAAA,SAAS,GAAG,IAJR;AAKJC,MAAAA,QAAQ,GAAG,IALP;AAMJgC,MAAAA,IAAI,GAAG,IANH;AAQJhB,MAAAA,QAAQ,GAAG,IARP;AASJd,MAAAA,WAAW,GAAG,IATV;AAUJ2B,MAAAA,aAAa,GAAG,CAVZ;AAYJzC,MAAAA,cAAc,GAAG;AAZb,QAaFjC,IAbJ;AAgBA,SAAK0C,YAAL,GAAoBH,MAAM,CAACC,QAAP,CAAgBK,QAAhB,KAA6BN,MAAM,CAACC,QAAP,CAAgBI,SAAhB,CAAjD;AAEA,SAAKiC,IAAL,GAAYA,IAAZ;;AACA,QAAI,CAACtC,MAAM,CAACC,QAAP,CAAgB,KAAKqC,IAArB,CAAL,EAAiC;AAC/B,WAAKA,IAAL,GAAY,KAAKnC,YAAL,GACRxD,YAAY,CAAC;AAAC2D,QAAAA;AAAD,OAAD,CAAZ,GAA2BpD,IAAI,CAACqF,IAAL,CAAUJ,aAAV,CADnB,GAER7E,YAFJ;AAGD;;AACD,UAAMuB,KAAK,GAAG3B,IAAI,CAACsF,GAAL,CAAS,CAAT,EAAY,KAAKF,IAAjB,CAAd;AACA,SAAKzD,KAAL,GAAaA,KAAb;AAGA,SAAKa,cAAL,GAAsB,KAAKS,YAAL,GAClBzD,iBAAiB,CAAC;AAAC4D,MAAAA,QAAD;AAAWD,MAAAA,SAAX;AAAsBxB,MAAAA,KAAK,EAAE,KAAKA;AAAlC,KAAD,CADC,GAElBa,cAAc,IAAI;AAChBC,MAAAA,cAAc,EAAE,CAACd,KAAD,EAAQA,KAAR,EAAeA,KAAf,CADA;AAEhBqB,MAAAA,cAAc,EAAE,CAAC,IAAIrB,KAAL,EAAY,IAAIA,KAAhB,EAAuB,IAAIA,KAA3B;AAFA,KAFtB;AAOA,SAAKsD,aAAL,GAAqBA,aAArB;AAEA,SAAKzC,cAAL,CAAoBQ,cAApB,GAAqC,IAAI3D,OAAJ,CAAY,KAAKmD,cAAL,CAAoBQ,cAAhC,CAArC;AACA,SAAKR,cAAL,CAAoBC,cAApB,GAAqC,IAAIpD,OAAJ,CAAY,KAAKmD,cAAL,CAAoBC,cAAhC,CAArC;AAEA,SAAK2B,QAAL,GAAgBjE,WAAhB;AACA,SAAKoF,WAAL,GAAmBpF,WAAnB;;AACA,QAAIiE,QAAJ,EAAc;AAEZ,WAAKA,QAAL,GAAgBA,QAAhB;AACA,WAAKd,WAAL,GAAmBA,WAAnB;AACA,WAAKiC,WAAL,GAAmBjC,WAAW,GAAGA,WAAW,CAACkC,eAAZ,CAA4BpB,QAA5B,CAAH,GAA2CA,QAAzE;AACD;;AAED,QAAI,KAAKnB,YAAT,EAAuB;AAErB,WAAKE,SAAL,GAAiBA,SAAjB;AACA,WAAKC,QAAL,GAAgBA,QAAhB;AACA,WAAKqC,MAAL,GAAc,KAAKC,iBAAL,CAAuB;AAACvC,QAAAA,SAAD;AAAYC,QAAAA;AAAZ,OAAvB,CAAd;AAGA,WAAKuC,oBAAL,GAA4BpG,IAAI,CAACoC,KAAL,CAAW,EAAX,EAAeE,UAAf,EAA2B,CAAC,CAAD,EAAI,CAAC,CAAL,EAAQ,CAAR,CAA3B,CAA5B;AACD,KARD,MAQO;AACL,WAAK4D,MAAL,GAAcrB,QAAQ,GAAG,KAAK/C,eAAL,CAAqB+C,QAArB,CAAH,GAAoC,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAA1D;AACA,WAAKuB,oBAAL,GAA4B9D,UAA5B;AACD;;AAED,SAAKA,UAAL,GAAkB,IAAIzC,OAAJ,GAEfwG,aAFe,CAED,KAAKD,oBAFJ,EAIfE,SAJe,CAIL,IAAIxG,OAAJ,CAAY,KAAKoG,MAAL,IAAetF,WAA3B,EAAwC2F,MAAxC,EAJK,CAAlB;AAKD;;AAGDJ,EAAAA,iBAAiB,CAAC;AAACvC,IAAAA,SAAD;AAAYC,IAAAA;AAAZ,GAAD,EAAwB;AACvC,UAAM;AAACmC,MAAAA,WAAD;AAAc5D,MAAAA,KAAd;AAAqBa,MAAAA;AAArB,QAAuC,IAA7C;AAGA,UAAMuD,QAAQ,GAAG,KAAKxE,WAAL,CAAiB,CAAC4B,SAAD,EAAYC,QAAZ,CAAjB,EAAwCzB,KAAxC,CAAjB;AACA,UAAM8D,MAAM,GAAG,IAAIpG,OAAJ,CAAY0G,QAAQ,CAAC,CAAD,CAApB,EAAyBA,QAAQ,CAAC,CAAD,CAAjC,EAAsC,CAAtC,CAAf;;AAEA,QAAIR,WAAJ,EAAiB;AACf,YAAMS,aAAa,GAAG,IAAI3G,OAAJ,CAAYkG,WAAZ,EAEnB5D,KAFmB,CAEba,cAAc,CAACC,cAFF,CAAtB;AAGAgD,MAAAA,MAAM,CAACQ,GAAP,CAAWD,aAAX;AACD;;AAED,WAAOP,MAAP;AACD;;AAEDzE,EAAAA,qBAAqB,CAACT,IAAD,EAAO;AAC1B,UAAM;AAEJqB,MAAAA,gBAAgB,GAAG,IAFf;AAKJoD,MAAAA,YAAY,GAAG,KALX;AAMJf,MAAAA,WANI;AAOJiC,MAAAA,WAPI;AAQJhB,MAAAA,IARI;AASJnB,MAAAA,IAAI,GAAG,GATH;AAUJC,MAAAA,GAAG,GAAG,IAVF;AAWJiB,MAAAA,aAAa,GAAG,CAXZ;AAYJkB,MAAAA;AAZI,QAaF5F,IAbJ;AAeA,UAAM6F,OAAO,GAAGnC,WAAW,IAAI,CAACiC,WAAW,IAAIhB,IAAf,IAAuB,EAAxB,IAA8BnF,kBAA7D;AAEA,SAAKoE,eAAL,GAAuB;AACrBa,MAAAA,YADqB;AAErBf,MAAAA,WAAW,EAAEmC,OAFQ;AAGrBlC,MAAAA,MAAM,EAAE,KAAKvD,KAAL,GAAa,KAAKC,MAHL;AAIrBqE,MAAAA,aAAa,EAAEkB,yBAAyB,IAAIlB,aAJvB;AAKrBlB,MAAAA,IALqB;AAMrBC,MAAAA;AANqB,KAAvB;AASA,SAAKpC,gBAAL,GAAwBA,gBAAgB,IAAI,KAAKmD,uBAAL,CAA6B,KAAKZ,eAAlC,CAA5C;AACD;;AAEDlD,EAAAA,kBAAkB,GAAG;AAGnB,UAAMoF,GAAG,GAAGpH,UAAU,EAAtB;AACAM,IAAAA,IAAI,CAACkE,QAAL,CAAc4C,GAAd,EAAmBA,GAAnB,EAAwB,KAAKzE,gBAA7B;AACArC,IAAAA,IAAI,CAACkE,QAAL,CAAc4C,GAAd,EAAmBA,GAAnB,EAAwB,KAAKxE,UAA7B;AACA,SAAK2B,oBAAL,GAA4B6C,GAA5B;AAKA,SAAKC,iBAAL,GAAyB/G,IAAI,CAACmE,MAAL,CAAY,EAAZ,EAAgB,KAAK7B,UAArB,KAAoC,KAAKA,UAAlE;AAGA,UAAM;AAAC0E,MAAAA,GAAD;AAAMjC,MAAAA,SAAN;AAAiBE,MAAAA,EAAjB;AAAqBE,MAAAA;AAArB,QAA8BxF,oBAAoB,CAAC;AACvD2C,MAAAA,UAAU,EAAE,KAAKA,UADsC;AAEvDyE,MAAAA,iBAAiB,EAAE,KAAKA;AAF+B,KAAD,CAAxD;AAIA,SAAKjC,cAAL,GAAsBkC,GAAtB;AACA,SAAKhC,eAAL,GAAuBD,SAAvB;AACA,SAAKG,QAAL,GAAgBD,EAAhB;AACA,SAAKG,WAAL,GAAmBD,KAAnB;AAeA,UAAM8B,cAAc,GAAGvH,UAAU,EAAjC;AACA,UAAMiD,qBAAqB,GAAGjD,UAAU,EAAxC;AACAM,IAAAA,IAAI,CAACoC,KAAL,CAAW6E,cAAX,EAA2BA,cAA3B,EAA2C,CAAC,KAAK7F,KAAL,GAAa,CAAd,EAAiB,CAAC,KAAKC,MAAN,GAAe,CAAhC,EAAmC,CAAnC,CAA3C;AACArB,IAAAA,IAAI,CAACsG,SAAL,CAAeW,cAAf,EAA+BA,cAA/B,EAA+C,CAAC,CAAD,EAAI,CAAC,CAAL,EAAQ,CAAR,CAA/C;AACAjH,IAAAA,IAAI,CAACkE,QAAL,CAAcvB,qBAAd,EAAqCsE,cAArC,EAAqD,KAAKhD,oBAA1D;AACA,SAAKtB,qBAAL,GAA6BA,qBAA7B;AACA,SAAKsE,cAAL,GAAsBA,cAAtB;AAEA,SAAK9D,uBAAL,GAA+BnD,IAAI,CAACmE,MAAL,CAAYzE,UAAU,EAAtB,EAA0B,KAAKiD,qBAA/B,CAA/B;;AACA,QAAI,CAAC,KAAKQ,uBAAV,EAAmC;AACjC1D,MAAAA,GAAG,CAACyH,IAAJ,CAAS,qCAAT;AAED;AACF;;AAla2B;AAqa9BpG,QAAQ,CAACQ,WAAT,GAAuB,UAAvB","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport log from '../utils/log';\nimport {createMat4, extractCameraVectors, getFrustumPlanes} from '../utils/math-utils';\n\nimport {Matrix4, Vector3, equals} from 'math.gl';\nimport * as mat4 from 'gl-matrix/mat4';\n\nimport {\n  getDistanceScales,\n  getMeterZoom,\n  lngLatToWorld,\n  worldToLngLat,\n  worldToPixels,\n  pixelsToWorld\n} from 'viewport-mercator-project';\n\nimport assert from '../utils/assert';\n\nconst DEGREES_TO_RADIANS = Math.PI / 180;\n\nconst IDENTITY = createMat4();\n\nconst ZERO_VECTOR = [0, 0, 0];\n\nconst DEFAULT_ZOOM = 0;\n\nexport default class Viewport {\n  /**\n   * @classdesc\n   * Manages coordinate system transformations for deck.gl.\n   *\n   * Note: The Viewport is immutable in the sense that it only has accessors.\n   * A new viewport instance should be created if any parameters have changed.\n   */\n  constructor(opts = {}) {\n    const {\n      id = null,\n      // Window width/height in pixels (for pixel projection)\n      x = 0,\n      y = 0,\n      width = 1,\n      height = 1\n    } = opts;\n\n    this.id = id || this.constructor.displayName || 'viewport';\n\n    this.x = x;\n    this.y = y;\n    // Silently allow apps to send in w,h = 0,0\n    this.width = width || 1;\n    this.height = height || 1;\n    this._frustumPlanes = {};\n\n    this._initViewMatrix(opts);\n    this._initProjectionMatrix(opts);\n    this._initPixelMatrices();\n\n    // Bind methods for easy access\n    this.equals = this.equals.bind(this);\n    this.project = this.project.bind(this);\n    this.unproject = this.unproject.bind(this);\n    this.projectPosition = this.projectPosition.bind(this);\n    this.unprojectPosition = this.unprojectPosition.bind(this);\n    this.projectFlat = this.projectFlat.bind(this);\n    this.unprojectFlat = this.unprojectFlat.bind(this);\n    this.getMatrices = this.getMatrices.bind(this);\n  }\n\n  // Two viewports are equal if width and height are identical, and if\n  // their view and projection matrices are (approximately) equal.\n  equals(viewport) {\n    if (!(viewport instanceof Viewport)) {\n      return false;\n    }\n\n    return (\n      viewport.width === this.width &&\n      viewport.height === this.height &&\n      viewport.scale === this.scale &&\n      equals(viewport.projectionMatrix, this.projectionMatrix) &&\n      equals(viewport.viewMatrix, this.viewMatrix)\n    );\n    // TODO - check distance scales?\n  }\n\n  /**\n   * Projects xyz (possibly latitude and longitude) to pixel coordinates in window\n   * using viewport projection parameters\n   * - [longitude, latitude] to [x, y]\n   * - [longitude, latitude, Z] => [x, y, z]\n   * Note: By default, returns top-left coordinates for canvas/SVG type render\n   *\n   * @param {Array} lngLatZ - [lng, lat] or [lng, lat, Z]\n   * @param {Object} opts - options\n   * @param {Object} opts.topLeft=true - Whether projected coords are top left\n   * @return {Array} - [x, y] or [x, y, z] in top left coords\n   */\n  project(xyz, {topLeft = true} = {}) {\n    const worldPosition = this.projectPosition(xyz);\n    const coord = worldToPixels(worldPosition, this.pixelProjectionMatrix);\n\n    const [x, y] = coord;\n    const y2 = topLeft ? y : this.height - y;\n    return xyz.length === 2 ? [x, y2] : [x, y2, coord[2]];\n  }\n\n  /**\n   * Unproject pixel coordinates on screen onto world coordinates,\n   * (possibly [lon, lat]) on map.\n   * - [x, y] => [lng, lat]\n   * - [x, y, z] => [lng, lat, Z]\n   * @param {Array} xyz -\n   * @param {Object} opts - options\n   * @param {Object} opts.topLeft=true - Whether origin is top left\n   * @return {Array|null} - [lng, lat, Z] or [X, Y, Z]\n   */\n  unproject(xyz, {topLeft = true, targetZ} = {}) {\n    const [x, y, z] = xyz;\n\n    const y2 = topLeft ? y : this.height - y;\n    const targetZWorld = targetZ && targetZ * this.distanceScales.pixelsPerMeter[2];\n    const coord = pixelsToWorld([x, y2, z], this.pixelUnprojectionMatrix, targetZWorld);\n    const [X, Y, Z] = this.unprojectPosition(coord);\n\n    if (Number.isFinite(z)) {\n      return [X, Y, Z];\n    }\n    return Number.isFinite(targetZ) ? [X, Y, targetZ] : [X, Y];\n  }\n\n  // NON_LINEAR PROJECTION HOOKS\n  // Used for web meractor projection\n\n  projectPosition(xyz) {\n    const [X, Y] = this.projectFlat(xyz);\n    const Z = (xyz[2] || 0) * this.distanceScales.pixelsPerMeter[2];\n    return [X, Y, Z];\n  }\n\n  unprojectPosition(xyz) {\n    const [X, Y] = this.unprojectFlat(xyz);\n    const Z = (xyz[2] || 0) * this.distanceScales.metersPerPixel[2];\n    return [X, Y, Z];\n  }\n\n  /**\n   * Project [lng,lat] on sphere onto [x,y] on 512*512 Mercator Zoom 0 tile.\n   * Performs the nonlinear part of the web mercator projection.\n   * Remaining projection is done with 4x4 matrices which also handles\n   * perspective.\n   * @param {Array} lngLat - [lng, lat] coordinates\n   *   Specifies a point on the sphere to project onto the map.\n   * @return {Array} [x,y] coordinates.\n   */\n  projectFlat(xyz, scale = this.scale) {\n    if (this.isGeospatial) {\n      return lngLatToWorld(xyz, scale);\n    }\n    const {pixelsPerMeter} = this.distanceScales;\n    return [xyz[0] * pixelsPerMeter[0], xyz[1] * pixelsPerMeter[1]];\n  }\n\n  /**\n   * Unproject world point [x,y] on map onto {lat, lon} on sphere\n   * @param {object|Vector} xy - object with {x,y} members\n   *  representing point on projected map plane\n   * @return {GeoCoordinates} - object with {lat,lon} of point on sphere.\n   *   Has toArray method if you need a GeoJSON Array.\n   *   Per cartographic tradition, lat and lon are specified as degrees.\n   */\n  unprojectFlat(xyz, scale = this.scale) {\n    if (this.isGeospatial) {\n      return worldToLngLat(xyz, scale);\n    }\n    const {metersPerPixel} = this.distanceScales;\n    return [xyz[0] * metersPerPixel[0], xyz[1] * metersPerPixel[1]];\n  }\n\n  getDistanceScales(coordinateOrigin = null) {\n    if (coordinateOrigin) {\n      return getDistanceScales({\n        longitude: coordinateOrigin[0],\n        latitude: coordinateOrigin[1],\n        scale: this.scale,\n        highPrecision: true\n      });\n    }\n    return this.distanceScales;\n  }\n\n  getMatrices({modelMatrix = null} = {}) {\n    let modelViewProjectionMatrix = this.viewProjectionMatrix;\n    let pixelProjectionMatrix = this.pixelProjectionMatrix;\n    let pixelUnprojectionMatrix = this.pixelUnprojectionMatrix;\n\n    if (modelMatrix) {\n      modelViewProjectionMatrix = mat4.multiply([], this.viewProjectionMatrix, modelMatrix);\n      pixelProjectionMatrix = mat4.multiply([], this.pixelProjectionMatrix, modelMatrix);\n      pixelUnprojectionMatrix = mat4.invert([], pixelProjectionMatrix);\n    }\n\n    const matrices = Object.assign({\n      modelViewProjectionMatrix,\n      viewProjectionMatrix: this.viewProjectionMatrix,\n      viewMatrix: this.viewMatrix,\n      projectionMatrix: this.projectionMatrix,\n\n      // project/unproject between pixels and world\n      pixelProjectionMatrix,\n      pixelUnprojectionMatrix,\n\n      width: this.width,\n      height: this.height,\n      scale: this.scale\n    });\n\n    return matrices;\n  }\n\n  containsPixel({x, y, width = 1, height = 1}) {\n    return (\n      x < this.x + this.width &&\n      this.x < x + width &&\n      y < this.y + this.height &&\n      this.y < y + height\n    );\n  }\n\n  // Extract frustum planes in common space\n  getFrustumPlanes() {\n    if (this._frustumPlanes.near) {\n      return this._frustumPlanes;\n    }\n\n    const {near, far, fovyRadians, aspect} = this.projectionProps;\n\n    Object.assign(\n      this._frustumPlanes,\n      getFrustumPlanes({\n        aspect,\n        near,\n        far,\n        fovyRadians,\n        position: this.cameraPosition,\n        direction: this.cameraDirection,\n        up: this.cameraUp,\n        right: this.cameraRight\n      })\n    );\n\n    return this._frustumPlanes;\n  }\n\n  // EXPERIMENTAL METHODS\n\n  getCameraPosition() {\n    return this.cameraPosition;\n  }\n\n  getCameraDirection() {\n    return this.cameraDirection;\n  }\n\n  getCameraUp() {\n    return this.cameraUp;\n  }\n\n  // INTERNAL METHODS\n\n  _createProjectionMatrix({orthographic, fovyRadians, aspect, focalDistance, near, far}) {\n    assert(Number.isFinite(fovyRadians));\n    return orthographic\n      ? new Matrix4().orthographic({fovy: fovyRadians, aspect, focalDistance, near, far})\n      : new Matrix4().perspective({fovy: fovyRadians, aspect, near, far});\n  }\n\n  /* eslint-disable complexity, max-statements */\n  _initViewMatrix(opts) {\n    const {\n      // view matrix\n      viewMatrix = IDENTITY,\n\n      longitude = null, // Anchor: lng lat zoom makes viewport work w/ geospatial coordinate systems\n      latitude = null,\n      zoom = null,\n\n      position = null, // Anchor position offset (in meters for geospatial viewports)\n      modelMatrix = null, // A model matrix to be applied to position, to match the layer props API\n      focalDistance = 1, // Only needed for orthographic views\n\n      distanceScales = null\n    } = opts;\n\n    // Check if we have a geospatial anchor\n    this.isGeospatial = Number.isFinite(latitude) && Number.isFinite(longitude);\n\n    this.zoom = zoom;\n    if (!Number.isFinite(this.zoom)) {\n      this.zoom = this.isGeospatial\n        ? getMeterZoom({latitude}) + Math.log2(focalDistance)\n        : DEFAULT_ZOOM;\n    }\n    const scale = Math.pow(2, this.zoom);\n    this.scale = scale;\n\n    // Calculate distance scales if lng/lat/zoom are provided\n    this.distanceScales = this.isGeospatial\n      ? getDistanceScales({latitude, longitude, scale: this.scale})\n      : distanceScales || {\n          pixelsPerMeter: [scale, scale, scale],\n          metersPerPixel: [1 / scale, 1 / scale, 1 / scale]\n        };\n\n    this.focalDistance = focalDistance;\n\n    this.distanceScales.metersPerPixel = new Vector3(this.distanceScales.metersPerPixel);\n    this.distanceScales.pixelsPerMeter = new Vector3(this.distanceScales.pixelsPerMeter);\n\n    this.position = ZERO_VECTOR;\n    this.meterOffset = ZERO_VECTOR;\n    if (position) {\n      // Apply model matrix if supplied\n      this.position = position;\n      this.modelMatrix = modelMatrix;\n      this.meterOffset = modelMatrix ? modelMatrix.transformVector(position) : position;\n    }\n\n    if (this.isGeospatial) {\n      // Determine camera center\n      this.longitude = longitude;\n      this.latitude = latitude;\n      this.center = this._getCenterInWorld({longitude, latitude});\n\n      // Flip Y to match the orientation of the Mercator plane\n      this.viewMatrixUncentered = mat4.scale([], viewMatrix, [1, -1, 1]);\n    } else {\n      this.center = position ? this.projectPosition(position) : [0, 0, 0];\n      this.viewMatrixUncentered = viewMatrix;\n    }\n    // Make a centered version of the matrix for projection modes without an offset\n    this.viewMatrix = new Matrix4()\n      // Apply the uncentered view matrix\n      .multiplyRight(this.viewMatrixUncentered)\n      // And center it\n      .translate(new Vector3(this.center || ZERO_VECTOR).negate());\n  }\n  /* eslint-enable complexity, max-statements */\n\n  _getCenterInWorld({longitude, latitude}) {\n    const {meterOffset, scale, distanceScales} = this;\n\n    // Make a centered version of the matrix for projection modes without an offset\n    const center2d = this.projectFlat([longitude, latitude], scale);\n    const center = new Vector3(center2d[0], center2d[1], 0);\n\n    if (meterOffset) {\n      const pixelPosition = new Vector3(meterOffset)\n        // Convert to pixels in current zoom\n        .scale(distanceScales.pixelsPerMeter);\n      center.add(pixelPosition);\n    }\n\n    return center;\n  }\n\n  _initProjectionMatrix(opts) {\n    const {\n      // Projection matrix\n      projectionMatrix = null,\n\n      // Projection matrix parameters, used if projectionMatrix not supplied\n      orthographic = false,\n      fovyRadians,\n      fovyDegrees,\n      fovy,\n      near = 0.1, // Distance of near clipping plane\n      far = 1000, // Distance of far clipping plane\n      focalDistance = 1, // Only needed for orthographic views\n      orthographicFocalDistance\n    } = opts;\n\n    const radians = fovyRadians || (fovyDegrees || fovy || 75) * DEGREES_TO_RADIANS;\n\n    this.projectionProps = {\n      orthographic,\n      fovyRadians: radians,\n      aspect: this.width / this.height,\n      focalDistance: orthographicFocalDistance || focalDistance,\n      near,\n      far\n    };\n\n    this.projectionMatrix = projectionMatrix || this._createProjectionMatrix(this.projectionProps);\n  }\n\n  _initPixelMatrices() {\n    // Note: As usual, matrix operations should be applied in \"reverse\" order\n    // since vectors will be multiplied in from the right during transformation\n    const vpm = createMat4();\n    mat4.multiply(vpm, vpm, this.projectionMatrix);\n    mat4.multiply(vpm, vpm, this.viewMatrix);\n    this.viewProjectionMatrix = vpm;\n\n    // console.log('VPM', this.viewMatrix, this.projectionMatrix, this.viewProjectionMatrix);\n\n    // Calculate inverse view matrix\n    this.viewMatrixInverse = mat4.invert([], this.viewMatrix) || this.viewMatrix;\n\n    // Decompose camera directions\n    const {eye, direction, up, right} = extractCameraVectors({\n      viewMatrix: this.viewMatrix,\n      viewMatrixInverse: this.viewMatrixInverse\n    });\n    this.cameraPosition = eye;\n    this.cameraDirection = direction;\n    this.cameraUp = up;\n    this.cameraRight = right;\n\n    // console.log(this.cameraPosition, this.cameraDirection, this.cameraUp);\n\n    /*\n     * Builds matrices that converts preprojected lngLats to screen pixels\n     * and vice versa.\n     * Note: Currently returns bottom-left coordinates!\n     * Note: Starts with the GL projection matrix and adds steps to the\n     *       scale and translate that matrix onto the window.\n     * Note: WebGL controls clip space to screen projection with gl.viewport\n     *       and does not need this step.\n     */\n\n    // matrix for conversion from world location to screen (pixel) coordinates\n    const viewportMatrix = createMat4(); // matrix from NDC to viewport.\n    const pixelProjectionMatrix = createMat4(); // matrix from world space to viewport.\n    mat4.scale(viewportMatrix, viewportMatrix, [this.width / 2, -this.height / 2, 1]);\n    mat4.translate(viewportMatrix, viewportMatrix, [1, -1, 0]);\n    mat4.multiply(pixelProjectionMatrix, viewportMatrix, this.viewProjectionMatrix);\n    this.pixelProjectionMatrix = pixelProjectionMatrix;\n    this.viewportMatrix = viewportMatrix;\n\n    this.pixelUnprojectionMatrix = mat4.invert(createMat4(), this.pixelProjectionMatrix);\n    if (!this.pixelUnprojectionMatrix) {\n      log.warn('Pixel project matrix not invertible')();\n      // throw new Error('Pixel project matrix not invertible');\n    }\n  }\n}\n\nViewport.displayName = 'Viewport';\n"],"file":"viewport.js"}