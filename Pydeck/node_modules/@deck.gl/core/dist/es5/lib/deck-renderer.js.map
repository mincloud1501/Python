{"version":3,"sources":["../../../src/lib/deck-renderer.js"],"names":["LOG_PRIORITY_DRAW","DeckRenderer","gl","layerFilter","drawPickingColors","drawLayersPass","DrawLayersPass","pickLayersPass","PickLayersPass","renderCount","_needsRedraw","screenBuffer","offscreenBuffer","lastPostProcessEffect","props","setProps","layers","viewports","activateViewport","views","redrawReason","clearCanvas","effects","pass","stats","layerPass","effectProps","prepareEffects","onViewportActive","outputBuffer","Framebuffer","getDefaultFramebuffer","renderStats","render","postRender","log","priority","forEach","status","logRenderStats","opts","clearRedrawFlags","redraw","params","effect","Object","assign","prepare","PostProcessEffect","prepareRenderBuffers","resize","inputBuffer","target","totalCount","visibleCount","compositeCount","pickableCount","primitiveCount","hiddenCount","message","get","add"],"mappings":"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","sourcesContent":["import log from '../utils/log';\nimport DrawLayersPass from '../passes/draw-layers-pass';\nimport PickLayersPass from '../passes/pick-layers-pass';\nimport PostProcessEffect from '../effects/post-process-effect';\nimport {Framebuffer} from '@luma.gl/core';\n\nconst LOG_PRIORITY_DRAW = 2;\n\nexport default class DeckRenderer {\n  constructor(gl) {\n    this.gl = gl;\n    this.layerFilter = null;\n    this.drawPickingColors = false;\n    this.drawLayersPass = new DrawLayersPass(gl);\n    this.pickLayersPass = new PickLayersPass(gl);\n    this.renderCount = 0;\n    this._needsRedraw = 'Initial render';\n    this.screenBuffer = null;\n    this.offscreenBuffer = null;\n    this.lastPostProcessEffect = null;\n  }\n\n  setProps(props) {\n    if ('layerFilter' in props) {\n      if (this.layerFilter !== props.layerFilter) {\n        this.layerFilter = props.layerFilter;\n        this._needsRedraw = 'layerFilter changed';\n      }\n    }\n\n    if ('drawPickingColors' in props) {\n      if (this.drawPickingColors !== props.drawPickingColors) {\n        this.drawPickingColors = props.drawPickingColors;\n        this._needsRedraw = 'drawPickingColors changed';\n      }\n    }\n\n    const {layerFilter} = this;\n\n    this.drawLayersPass.setProps({\n      layerFilter\n    });\n    this.pickLayersPass.setProps({\n      layerFilter\n    });\n  }\n\n  renderLayers({\n    layers,\n    viewports,\n    activateViewport,\n    views,\n    redrawReason = 'unknown reason',\n    clearCanvas = true,\n    effects = [],\n    pass,\n    stats\n  }) {\n    const layerPass = this.drawPickingColors ? this.pickLayersPass : this.drawLayersPass;\n    const effectProps = this.prepareEffects({\n      layers,\n      viewports,\n      onViewportActive: activateViewport,\n      views,\n      effects\n    });\n    const outputBuffer = this.lastPostProcessEffect\n      ? this.screenBuffer\n      : Framebuffer.getDefaultFramebuffer(this.gl);\n\n    const renderStats = layerPass.render({\n      layers,\n      viewports,\n      views,\n      onViewportActive: activateViewport,\n      redrawReason,\n      clearCanvas,\n      effects,\n      effectProps,\n      outputBuffer\n    });\n\n    this.postRender(effects);\n\n    this.renderCount++;\n\n    if (log.priority >= LOG_PRIORITY_DRAW) {\n      renderStats.forEach(status => {\n        this.logRenderStats({status, pass, redrawReason, stats, renderStats});\n      });\n    }\n  }\n\n  needsRedraw(opts = {clearRedrawFlags: false}) {\n    const redraw = this._needsRedraw;\n    if (opts.clearRedrawFlags) {\n      this._needsRedraw = false;\n    }\n    return redraw;\n  }\n\n  finalize() {\n    if (this.screenBuffer) {\n      this.screenBuffer.delete();\n      this.screenBuffer = null;\n    }\n    if (this.offscreenBuffer) {\n      this.offscreenBuffer.delete();\n      this.offscreenBuffer = null;\n    }\n  }\n\n  // Private\n  prepareEffects(params) {\n    const {effects} = params;\n    const effectProps = {};\n    this.lastPostProcessEffect = null;\n\n    for (const effect of effects) {\n      Object.assign(effectProps, effect.prepare(this.gl, params));\n      if (effect instanceof PostProcessEffect) {\n        this.lastPostProcessEffect = effect;\n      }\n    }\n\n    if (this.lastPostProcessEffect) {\n      this.prepareRenderBuffers();\n    }\n\n    return effectProps;\n  }\n\n  prepareRenderBuffers() {\n    if (!this.screenBuffer) {\n      this.screenBuffer = new Framebuffer(this.gl);\n    }\n    this.screenBuffer.resize();\n\n    if (!this.offscreenBuffer) {\n      this.offscreenBuffer = new Framebuffer(this.gl);\n    }\n    this.offscreenBuffer.resize();\n  }\n\n  postRender(effects) {\n    let params = {inputBuffer: this.screenBuffer, outputBuffer: this.offscreenBuffer, target: null};\n    for (const effect of effects) {\n      if (effect instanceof PostProcessEffect) {\n        if (effect === this.lastPostProcessEffect) {\n          Object.assign(params, {target: Framebuffer.getDefaultFramebuffer(this.gl)});\n          params = effect.render(params);\n          break;\n        }\n        params = effect.render(params);\n      }\n    }\n  }\n\n  logRenderStats({renderStats, pass, redrawReason, stats}) {\n    const {totalCount, visibleCount, compositeCount, pickableCount} = renderStats;\n    const primitiveCount = totalCount - compositeCount;\n    const hiddenCount = primitiveCount - visibleCount;\n\n    let message = '';\n    message += `RENDER #${this.renderCount} \\\n${visibleCount} (of ${totalCount} layers) to ${pass} because ${redrawReason} `;\n    if (log.priority > LOG_PRIORITY_DRAW) {\n      message += `\\\n(${hiddenCount} hidden, ${compositeCount} composite ${pickableCount} pickable)`;\n    }\n\n    log.log(LOG_PRIORITY_DRAW, message)();\n\n    if (stats) {\n      stats.get('Redraw Layers').add(visibleCount);\n    }\n  }\n}\n"],"file":"deck-renderer.js"}