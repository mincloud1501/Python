!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t(require("deck"),require("luma"));else if("function"==typeof define&&define.amd)define(["deck","luma"],t);else{var n="object"==typeof exports?t(require("deck"),require("luma")):t(e.deck,e.luma);for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(window,(function(e,t){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=11)}([function(e,t){e.exports=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}},function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t){function n(t){return e.exports=n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},n(t)}e.exports=n},function(e,t){function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}e.exports=function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}},function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t,n){var r=n(10),i=n(14);e.exports=function(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?i(e):t}},function(e,t,n){var r=n(16);e.exports=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&r(e,t)}},function(e,t,n){var r=n(15);function i(t,n,o){return"undefined"!=typeof Reflect&&Reflect.get?e.exports=i=Reflect.get:e.exports=i=function(e,t,n){var i=r(e,t);if(i){var o=Object.getOwnPropertyDescriptor(i,t);return o.get?o.get.call(n):o.value}},i(t,n,o||t)}e.exports=i},function(e,t,n){var r=n(17),i=n(18),o=n(19);e.exports=function(e,t){return r(e)||i(e,t)||o()}},function(e,t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(t){return"function"==typeof Symbol&&"symbol"===n(Symbol.iterator)?e.exports=r=function(e){return n(e)}:e.exports=r=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":n(e)},r(t)}e.exports=r},function(e,t,n){(function(t){const r=n(20),i=("undefined"==typeof window?t:window).deck||{};if(!i.LineLayer)throw new Error("@deck.gl/layers is not found");Object.assign(r.experimental,i.experimental),e.exports=Object.assign(i,r)}).call(this,n(13))},,function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t){e.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}},function(e,t,n){var r=n(3);e.exports=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=r(e)););return e}},function(e,t){function n(t,r){return e.exports=n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},n(t,r)}e.exports=n},function(e,t){e.exports=function(e){if(Array.isArray(e))return e}},function(e,t){e.exports=function(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],r=!0,i=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(i)throw o}}return n}}},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}},function(e,t,n){"use strict";n.r(t);var r=n(5),i=n.n(r),o=n(4),a=n.n(o),s=n(6),u=n.n(s),l=n(3),c=n.n(l),g=n(8),h=n.n(g),f=n(7),d=n.n(f),v=n(1),p=[[255,255,178],[254,217,118],[254,178,76],[253,141,60],[240,59,32],[189,0,38]];function m(e){var t,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Float32Array;if(Number.isFinite(e[0]))t=new r(e);else{t=new r(4*e.length);for(var i=0,o=0;o<e.length;o++){var a=e[o];t[i++]=a[0],t[i++]=a[1],t[i++]=a[2],t[i++]=Number.isFinite(a[3])?a[3]:255}}if(n)for(var s=0;s<t.length;s++)t[s]/=255;return t}var y=n(0),x=n.n(y),S=n(9),b=n.n(S),w=n(2);function M(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],r=!0,i=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(i)throw o}}return n}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var C=1e-6,P="undefined"!=typeof Float32Array?Float32Array:Array;Math.random;Math.PI;function T(e,t,n){var r=t[0],i=t[1],o=t[2],a=t[3];return e[0]=n[0]*r+n[4]*i+n[8]*o+n[12]*a,e[1]=n[1]*r+n[5]*i+n[9]*o+n[13]*a,e[2]=n[2]*r+n[6]*i+n[10]*o+n[14]*a,e[3]=n[3]*r+n[7]*i+n[11]*o+n[15]*a,e}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var A,k;A=new P(4),P!=Float32Array&&(A[0]=0,A[1]=0,A[2]=0,A[3]=0),k=A;function E(e,t){var n=T([],t,e);return function(e,t,n){e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n}(n,n,1/n[3]),n}function O(e,t,n){var r=t[0],i=t[1],o=t[2],a=t[3],s=t[4],u=t[5],l=t[6],c=t[7],g=t[8],h=t[9],f=t[10],d=t[11],v=t[12],p=t[13],m=t[14],y=t[15],x=n[0],S=n[1],b=n[2],w=n[3];return e[0]=x*r+S*s+b*g+w*v,e[1]=x*i+S*u+b*h+w*p,e[2]=x*o+S*l+b*f+w*m,e[3]=x*a+S*c+b*d+w*y,x=n[4],S=n[5],b=n[6],w=n[7],e[4]=x*r+S*s+b*g+w*v,e[5]=x*i+S*u+b*h+w*p,e[6]=x*o+S*l+b*f+w*m,e[7]=x*a+S*c+b*d+w*y,x=n[8],S=n[9],b=n[10],w=n[11],e[8]=x*r+S*s+b*g+w*v,e[9]=x*i+S*u+b*h+w*p,e[10]=x*o+S*l+b*f+w*m,e[11]=x*a+S*c+b*d+w*y,x=n[12],S=n[13],b=n[14],w=n[15],e[12]=x*r+S*s+b*g+w*v,e[13]=x*i+S*u+b*h+w*p,e[14]=x*o+S*l+b*f+w*m,e[15]=x*a+S*c+b*d+w*y,e}function D(e,t,n){var r,i,o,a,s,u,l,c,g,h,f,d,v=n[0],p=n[1],m=n[2];return t===e?(e[12]=t[0]*v+t[4]*p+t[8]*m+t[12],e[13]=t[1]*v+t[5]*p+t[9]*m+t[13],e[14]=t[2]*v+t[6]*p+t[10]*m+t[14],e[15]=t[3]*v+t[7]*p+t[11]*m+t[15]):(r=t[0],i=t[1],o=t[2],a=t[3],s=t[4],u=t[5],l=t[6],c=t[7],g=t[8],h=t[9],f=t[10],d=t[11],e[0]=r,e[1]=i,e[2]=o,e[3]=a,e[4]=s,e[5]=u,e[6]=l,e[7]=c,e[8]=g,e[9]=h,e[10]=f,e[11]=d,e[12]=r*v+s*p+g*m+t[12],e[13]=i*v+u*p+h*m+t[13],e[14]=o*v+l*p+f*m+t[14],e[15]=a*v+c*p+d*m+t[15]),e}function _(e,t,n){var r=n[0],i=n[1],o=n[2];return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*o,e[9]=t[9]*o,e[10]=t[10]*o,e[11]=t[11]*o,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function z(e,t,n){var r=Math.sin(n),i=Math.cos(n),o=t[4],a=t[5],s=t[6],u=t[7],l=t[8],c=t[9],g=t[10],h=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=o*i+l*r,e[5]=a*i+c*r,e[6]=s*i+g*r,e[7]=u*i+h*r,e[8]=l*i-o*r,e[9]=c*i-a*r,e[10]=g*i-s*r,e[11]=h*i-u*r,e}function N(e,t,n){var r=Math.sin(n),i=Math.cos(n),o=t[0],a=t[1],s=t[2],u=t[3],l=t[4],c=t[5],g=t[6],h=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*i+l*r,e[1]=a*i+c*r,e[2]=s*i+g*r,e[3]=u*i+h*r,e[4]=l*i-o*r,e[5]=c*i-a*r,e[6]=g*i-s*r,e[7]=h*i-u*r,e}function j(e,t,n,r,i){var o,a=1/Math.tan(t/2);return e[0]=a/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=i&&i!==1/0?(o=1/(r-i),e[10]=(i+r)*o,e[14]=2*i*r*o):(e[10]=-1,e[14]=-2*r),e}function F(e,t,n,r){var i,o,a,s,u,l,c,g,h,f,d=t[0],v=t[1],p=t[2],m=r[0],y=r[1],x=r[2],S=n[0],b=n[1],w=n[2];return Math.abs(d-S)<C&&Math.abs(v-b)<C&&Math.abs(p-w)<C?function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}(e):(c=d-S,g=v-b,h=p-w,i=y*(h*=f=1/Math.hypot(c,g,h))-x*(g*=f),o=x*(c*=f)-m*h,a=m*g-y*c,(f=Math.hypot(i,o,a))?(i*=f=1/f,o*=f,a*=f):(i=0,o=0,a=0),s=g*a-h*o,u=h*i-c*a,l=c*o-g*i,(f=Math.hypot(s,u,l))?(s*=f=1/f,u*=f,l*=f):(s=0,u=0,l=0),e[0]=i,e[1]=s,e[2]=c,e[3]=0,e[4]=o,e[5]=u,e[6]=g,e[7]=0,e[8]=a,e[9]=l,e[10]=h,e[11]=0,e[12]=-(i*d+o*v+a*p),e[13]=-(s*d+u*v+l*p),e[14]=-(c*d+g*v+h*p),e[15]=1,e)}!function(){var e=function(){var e=new P(2);return P!=Float32Array&&(e[0]=0,e[1]=0),e}()}();!function(){var e=function(){var e=new P(3);return P!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}()}();function L(e,t){if(!e)throw new Error(t||"viewport-mercator-project: assertion failed.")}Math.PI;function R(e,t){var n=M(e,3),r=n[0],i=n[1],o=n[2],a=void 0===o?0:o;return L(Number.isFinite(r)&&Number.isFinite(i)&&Number.isFinite(a)),E(t,[r,i,a,1])}var B,I,W={SUM:1,MEAN:2,MIN:3,MAX:4};function U(e,t){return e+t}function G(e,t){return t>e?t:e}function V(e,t){return t<e?t:e}function Y(e,t){switch(W[e.toUpperCase()]||W.SUM){case W.MIN:return function(e){return function(e,t){var n=e.map(t).filter(Number.isFinite);return n.length?n.reduce(V,1/0):null}(e,t)};case W.SUM:return function(e){return function(e,t){var n=e.map(t).filter(Number.isFinite);return n.length?n.reduce(U,0):null}(e,t)};case W.MEAN:return function(e){return function(e,t){var n=e.map(t).filter(Number.isFinite);return n.length?n.reduce(U,0)/n.length:null}(e,t)};case W.MAX:return function(e){return function(e,t){var n=e.map(t).filter(Number.isFinite);return n.length?n.reduce(G,-1/0):null}(e,t)};default:return null}}var X,q={dataChanged:!0,viewportChanged:!0,cellSizeChanged:!0},H={changeFlags:q,projectPoints:!1,useGPU:!0,fp64:!1,viewport:null,gridTransformMatrix:null,createBufferObjects:!0},K=[32775,32774],Z=[32776,32774],Q=[32776,32775],J=(B={},x()(B,W.SUM,32774),x()(B,W.MEAN,32774),x()(B,W.MIN,K),x()(B,W.MAX,Z),B),$={size:1,operation:W.SUM,needMin:!1,needMax:!1,combineMaxMin:!1},ee=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],te=(I={},x()(I,10240,9728),x()(I,10241,9728),"#define SHADER_NAME gpu-aggregation-to-grid-vs\n\nattribute vec2 positions;\nattribute vec3 weights;\nuniform vec2 windowSize;\nuniform vec2 cellSize;\nuniform vec2 gridSize;\nuniform mat4 uProjectionMatrix;\nuniform bool projectPoints;\n\nvarying vec3 vWeights;\n\nvec2 project_to_pixel(vec4 pos) {\n  vec4 result =  uProjectionMatrix * pos;\n  return result.xy/result.w;\n}\n\nvoid main(void) {\n\n  vWeights = weights;\n\n  vec4 windowPos = vec4(positions, 0, 1.);\n  if (projectPoints) {\n    windowPos = project_position_to_clipspace(vec3(positions, 0), vec2(0, 0), vec3(0, 0, 0));\n  }\n\n  vec2 pos = project_to_pixel(windowPos);\n  pos = floor(pos / cellSize);\n  pos = (pos * (2., 2.) / (gridSize)) - (1., 1.);\n  vec2 offset = 1.0 / gridSize;\n  pos = pos + offset;\n\n  gl_Position = vec4(pos, 0.0, 1.0);\n}\n"),ne="#define SHADER_NAME gpu-aggregation-to-grid-vs-64\n\nattribute vec2 positions;\nattribute vec2 positions64xyLow;\nattribute vec3 weights;\nuniform vec2 windowSize;\nuniform vec2 cellSize;\nuniform vec2 gridSize;\nuniform vec2 uProjectionMatrixFP64[16];\nuniform bool projectPoints;\n\nvarying vec3 vWeights;\n\nvoid project_to_pixel(vec2 pos, vec2 pos64xyLow, out vec2 pixelXY64[2]) {\n\n  vec2 result64[4];\n  vec2 position64[4];\n  position64[0] = vec2(pos.x, pos64xyLow.x);\n  position64[1] = vec2(pos.y, pos64xyLow.y);\n  position64[2] = vec2(0., 0.);\n  position64[3] = vec2(1., 0.);\n  mat4_vec4_mul_fp64(uProjectionMatrixFP64, position64,\n  result64);\n\n  pixelXY64[0] = div_fp64(result64[0], result64[3]);\n  pixelXY64[1] = div_fp64(result64[1], result64[3]);\n}\n\nvoid main(void) {\n\n  vWeights = weights;\n\n  vec2 windowPos = positions;\n  vec2 windowPos64xyLow = positions64xyLow;\n  if (projectPoints) {\n    vec2 projectedXY[2];\n    project_position_fp64(windowPos, windowPos64xyLow, projectedXY);\n    windowPos.x = projectedXY[0].x;\n    windowPos.y = projectedXY[1].x;\n    windowPos64xyLow.x = projectedXY[0].y;\n    windowPos64xyLow.y = projectedXY[1].y;\n  }\n\n  vec2 pixelXY64[2];\n  project_to_pixel(windowPos, windowPos64xyLow, pixelXY64);\n  vec2 gridXY64[2];\n  gridXY64[0] = div_fp64(pixelXY64[0], vec2(cellSize.x, 0));\n  gridXY64[1] = div_fp64(pixelXY64[1], vec2(cellSize.y, 0));\n  float x = floor(gridXY64[0].x);\n  float y = floor(gridXY64[1].x);\n  vec2 pos = vec2(x, y);\n  pos = (pos * (2., 2.) / (gridSize)) - (1., 1.);\n  vec2 offset = 1.0 / gridSize;\n  pos = pos + offset;\n\n  gl_Position = vec4(pos, 0.0, 1.0);\n}\n",re="#define SHADER_NAME gpu-aggregation-to-grid-fs\n\nprecision highp float;\n\nvarying vec3 vWeights;\n\nvoid main(void) {\n  gl_FragColor = vec4(vWeights, 1.0);\n}\n",ie=(X={},x()(X,10240,9728),x()(X,10241,9728),X);function oe(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.width,r=void 0===n?1:n,i=t.height,o=void 0===i?1:i,a=t.data,s=void 0===a?null:a,u=t.unpackFlipY,l=void 0===u||u,c=t.parameters,g=void 0===c?ie:c;return new w.Texture2D(e,{data:s,format:Object(w.isWebGL2)(e)?34836:6408,type:5126,border:0,mipmaps:!1,parameters:g,dataFormat:6408,width:r,height:o,unpackFlipY:l})}function ae(e,t){var n=t.id,r=t.width,i=void 0===r?1:r,o=t.height,a=void 0===o?1:o,s=t.texture;return new w.Framebuffer(e,{id:n,width:i,height:a,attachments:x()({},36064,s)})}function se(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return!e||e.length<t?new Float32Array(t).fill(n):e}var ue=w.fp64.fp64ifyMatrix4,le=["aggregationBuffer","maxMinBuffer","minBuffer","maxBuffer"],ce={maxData:"maxBuffer",minData:"minBuffer",maxMinData:"maxMinBuffer"},ge=[w.FEATURES.WEBGL2,w.FEATURES.COLOR_ATTACHMENT_RGBA32F,w.FEATURES.BLEND_EQUATION_MINMAX,w.FEATURES.FLOAT_BLEND,w.FEATURES.TEXTURE_FLOAT],he=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i()(this,e),this.id=n.id||"gpu-grid-aggregator",this.gl=t,this.state={weights:null,gridPositions:null,positionsBuffer:null,positions64xyLowBuffer:null,vertexCount:0,fp64:null,useGPU:null,numCol:0,numRow:0,windowSize:null,cellSize:null,weightAttributes:{},textures:{},meanTextures:{},buffers:{},framebuffers:{},maxMinFramebuffers:{},minFramebuffers:{},maxFramebuffers:{},equations:{},resources:{},results:{}},this._hasGPUSupport=Object(w.isWebGL2)(t)&&Object(w.hasFeatures)(this.gl,w.FEATURES.BLEND_EQUATION_MINMAX,w.FEATURES.COLOR_ATTACHMENT_RGBA32F,w.FEATURES.TEXTURE_FLOAT)}return a()(e,null,[{key:"getAggregationData",value:function(e){var t=e.aggregationData,n=e.maxData,r=e.minData,i=e.maxMinData,o=4*e.pixelIndex,a={};return t&&(a.cellCount=t[o+3],a.cellWeight=t[o]),i?(a.maxCellWieght=i[0],a.minCellWeight=i[3]):(n&&(a.maxCellWieght=n[0],a.totalCount=n[3]),r&&(a.minCellWeight=r[0],a.totalCount=n[3])),a}},{key:"getCellData",value:function(e){for(var t=e.countsData,n=e.size,r=void 0===n?1:n,i=t.length/4,o=new Float32Array(i*r),a=new Uint32Array(i),s=0;s<i;s++){for(var u=0;u<r;u++)o[s*r+u]=t[4*s+u];a[s]=t[4*s+3]}return{cellCounts:a,cellWeights:o}}},{key:"isSupported",value:function(e){return Object(w.hasFeatures)(e,ge)}}]),a()(e,[{key:"delete",value:function(){var e=this.gridAggregationModel,t=this.allAggregationModel,n=this.meanTransform,r=this.state,i=r.positionsBuffer,o=r.positions64xyLowBuffer,a=r.textures,s=r.framebuffers,u=r.maxMinFramebuffers,l=r.minFramebuffers,c=r.maxFramebuffers,g=r.meanTextures,h=r.resources;e&&e.delete(),t&&t.delete(),n&&n.delete(),i&&i.delete(),o&&o.delete(),this.deleteResources([s,a,u,l,c,g,h])}},{key:"run",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.setState({results:{}});var t=this.getAggregationParams(e);this.updateGridSize(t);var n=t.useGPU;return this._hasGPUSupport&&n?this.runAggregationOnGPU(t):(n&&v.log.warn("GPUGridAggregator: GPU Aggregation not supported, falling back to CPU")(),this.runAggregationOnCPU(t))}},{key:"getData",value:function(e){var t={},n=this.state.results;for(var r in n[e].aggregationData||(n[e].aggregationData=n[e].aggregationBuffer.getData()),t.aggregationData=n[e].aggregationData,ce){var i=ce[r];(n[e][r]||n[e][i])&&(n[e][r]=n[e][r]||n[e][i].getData(),t[r]=n[e][r])}return t}},{key:"deleteResources",value:function(e){(e=Array.isArray(e)?e:[e]).forEach((function(e){for(var t in e)e[t].delete()}))}},{key:"getAggregationParams",value:function(e){var t=Object.assign({},H,e),n=t.useGPU,r=t.gridTransformMatrix,i=t.viewport,o=t.weights,a=t.projectPoints,s=t.cellSize;return this.state.useGPU!==n&&(t.changeFlags=Object.assign({},t.changeFlags,q)),!s||this.state.cellSize&&this.state.cellSize[0]===s[0]&&this.state.cellSize[1]===s[1]||(t.changeFlags.cellSizeChanged=!0,this.setState({cellSize:s})),this.validateProps(t,e),this.setState({useGPU:n}),t.gridTransformMatrix=(a?i.viewportMatrix:r)||ee,o&&(t.weights=this.normalizeWeightParams(o),this.setState({weights:t.weights})),t}},{key:"normalizeWeightParams",value:function(e){var t={};for(var n in e)t[n]=Object.assign({},$,e[n]);return t}},{key:"setState",value:function(e){Object.assign(this.state,e)}},{key:"shouldTransformToGrid",value:function(e){var t=e.projectPoints,n=e.changeFlags;return!!(!this.state.gridPositions||n.dataChanged||t&&n.viewportChanged)}},{key:"updateGridSize",value:function(e){var t=e.viewport,n=e.cellSize,r=e.width||t.width,i=e.height||t.height,o=Math.ceil(r/n[0]),a=Math.ceil(i/n[1]);this.setState({numCol:o,numRow:a,windowSize:[r,i]})}},{key:"validateProps",value:function(e,t){var n=e.changeFlags,r=e.projectPoints,i=e.gridTransformMatrix;v.log.assert(n.dataChanged||n.viewportChanged||n.cellSizeChanged),v.log.assert(!n.dataChanged||t.positions&&t.weights&&(!t.projectPositions||t.viewport)&&t.cellSize),v.log.assert(!n.cellSizeChanged||t.cellSize),v.log.assert(!(n.viewportChanged&&r)||t.viewport),r&&i&&v.log.warn("projectPoints is true, gridTransformMatrix is ignored")()}},{key:"calculateAggregationData",value:function(e){var t=e.weights,n=e.results,r=e.cellIndex,i=e.posIndex;for(var o in t){for(var a=t[o],s=a.values,u=a.size,l=a.operation,c=n[o].aggregationData,g=0;g<u;g++){var h=r+g,f=s[3*i+g];if(0===c[r+3])c[h]=f;else switch(l){case W.SUM:case W.MEAN:c[h]+=f;break;case W.MIN:c[h]=Math.min(c[h],f);break;case W.MAX:c[h]=Math.max(c[h],f);break;default:v.log.assert(!1)}}c[r+3]++}}},{key:"calculateMeanMaxMinData",value:function(e){var t=e.validCellIndices,n=e.results,r=e.weights;t.forEach((function(e){for(var t in n){for(var i=r[t],o=i.size,a=i.needMin,s=i.needMax,u=i.operation,l=n[t],c=l.aggregationData,g=l.minData,h=l.maxData,f=l.maxMinData,d=a||s,v=u===W.MEAN,p=a&&s&&r[t].combineMaxMin,m=c[e+4-1],y=0;y<o&&(d||v);y++){var x=e+y,S=c[x];v&&(c[x]/=m,S=c[x]),p?f[y]=Math.max(f[y],S):(a&&(g[y]=Math.min(g[y],S)),s&&(h[y]=Math.max(h[y],S)))}p?f[3]=Math.min(f[3],c[e+0]):(a&&(g[3]+=m),s&&(h[3]+=m))}}))}},{key:"initCPUResults",value:function(e){var t=e.weights||this.state.weights,n=this.state,r=n.numCol,i=n.numRow,o={};for(var a in t){var s=t[a],u=s.aggregationData,l=s.minData,c=s.maxData,g=s.maxMinData,h=t[a],f=h.needMin,d=h.needMax,v=f&&d&&t[a].combineMaxMin;u=se(u,r*i*4),v?((g=se(g,4)).fill(-1/0,0,3),g[3]=1/0):(f&&((l=se(l,4,1/0))[3]=0),d&&((c=se(c,4,-1/0))[3]=0)),o[a]=Object.assign({},t[a],{aggregationData:u,minData:l,maxData:c,maxMinData:g})}return o}},{key:"runAggregationOnCPU",value:function(e){var t,n,r=e.positions,i=e.cellSize,o=e.gridTransformMatrix,a=e.viewport,s=e.projectPoints,u=e.weights,l=this.state,c=l.numCol,g=l.numRow,h=this.initCPUResults(e),f=this.shouldTransformToGrid(e),d=[0,0,0];v.log.assert(f||e.changeFlags.cellSizeChanged),f?(n=r.length/2,t=new Float64Array(r.length),this.setState({gridPositions:t})):(t=this.state.gridPositions,u=this.state.weights,n=t.length/2);for(var p=new Set,m=0;m<n;m++){var y=void 0,x=void 0;if(f){if(d[0]=r[2*m],d[1]=r[2*m+1],s){var S=a.project(d),w=b()(S,2);y=w[0],x=w[1]}else{var M=R(d,o),C=b()(M,2);y=C[0],x=C[1]}t[2*m]=y,t[2*m+1]=x}else y=t[2*m],x=t[2*m+1];var P=Math.floor(y/i[0]),T=Math.floor(x/i[1]);if(P>=0&&P<c&&T>=0&&T<g){var A=4*(P+T*c);p.add(A),this.calculateAggregationData({weights:u,results:h,cellIndex:A,posIndex:m})}}return this.calculateMeanMaxMinData({validCellIndices:p,results:h,weights:u}),this.updateAggregationBuffers(e,h),this.setState({results:h}),h}},{key:"_uploadResultsToGPU",value:function(e){var t=e.gl,n=e.bufferName,r=e.textureName,i=e.id,o=e.data,a=e.result,s=this.state.resources,u="cpu-result-".concat(i,"-").concat(n);if(a[n]=a[n]||s[u],a[n]?a[n].setData({data:o}):(s[u]=new w.Buffer(t,o),a[n]=s[u]),r){var l=this._getMinMaxTexture("".concat(i,"-textureName"));l.setImageData({data:o}),a[r]=l}}},{key:"updateAggregationBuffers",value:function(e,t){if(e.createBufferObjects){var n=e.weights||this.state.weights;for(var r in t){var i=t[r],o=i.aggregationData,a=i.minData,s=i.maxData,u=i.maxMinData,l=n[r],c=l.needMin,g=l.needMax,h=c&&g&&n[r].combineMaxMin;this._uploadResultsToGPU({gl:this.gl,bufferName:"aggregationBuffer",id:r,data:o,result:t[r]}),h?this._uploadResultsToGPU({gl:this.gl,bufferName:"maxMinBuffer",textureName:"maxMinTexture",id:r,data:u,result:t[r]}):(c&&this._uploadResultsToGPU({gl:this.gl,bufferName:"minBuffer",textureName:"minTexture",id:r,data:a,result:t[r]}),g&&this._uploadResultsToGPU({gl:this.gl,bufferName:"maxBuffer",textureName:"maxTexture",id:r,data:s,result:t[r]}))}}}},{key:"getAggregateData",value:function(e){var t={},n=this.state,r=n.textures,i=n.framebuffers,o=n.maxMinFramebuffers,a=n.minFramebuffers,s=n.maxFramebuffers,u=n.weights,l=n.resources;for(var c in u){t[c]={};var g=u[c],h=g.needMin,f=g.needMax,d=g.combineMaxMin;t[c].aggregationTexture=r[c],t[c].aggregationBuffer=Object(w.readPixelsToBuffer)(i[c],{target:u[c].aggregationBuffer,sourceType:5126}),h&&f&&d?(t[c].maxMinBuffer=Object(w.readPixelsToBuffer)(o[c],{target:u[c].maxMinBuffer,sourceType:5126}),t[c].maxMinTexture=l["".concat(c,"-maxMinTexture")]):(h&&(t[c].minBuffer=Object(w.readPixelsToBuffer)(a[c],{target:u[c].minBuffer,sourceType:5126}),t[c].minTexture=l["".concat(c,"-minTexture")]),f&&(t[c].maxBuffer=Object(w.readPixelsToBuffer)(s[c],{target:u[c].maxBuffer,sourceType:5126}),t[c].maxTexture=l["".concat(c,"-maxTexture")]))}return this.trackGPUResultBuffers(t,u),t}},{key:"getAggregationModel",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.gl;return new w.Model(t,{id:"Gird-Aggregation-Model",vs:e?ne:te,fs:re,modules:e?[v.project64]:["project32"],vertexCount:0,drawMode:0})}},{key:"getAllAggregationModel",value:function(){var e=this.gl,t=this.state,n=t.numCol,r=t.numRow;return new w.Model(e,{id:"All-Aggregation-Model",vs:"#version 300 es\n#define SHADER_NAME gpu-aggregation-all-vs-64\n\nin vec2 position;\nuniform ivec2 gridSize;\nout vec2 vTextureCoord;\n\nvoid main(void) {\n  vec2 pos = vec2(-1.0, -1.0);\n  vec2 offset = 1.0 / vec2(gridSize);\n  pos = pos + offset;\n\n  gl_Position = vec4(pos, 0.0, 1.0);\n\n  int yIndex = gl_InstanceID / gridSize[0];\n  int xIndex = gl_InstanceID - (yIndex * gridSize[0]);\n\n  vec2 yIndexFP64 = vec2(float(yIndex), 0.);\n  vec2 xIndexFP64 = vec2(float(xIndex), 0.);\n  vec2 gridSizeYFP64 = vec2(gridSize[1], 0.);\n  vec2 gridSizeXFP64 = vec2(gridSize[0], 0.);\n\n  vec2 texCoordXFP64 = div_fp64(yIndexFP64, gridSizeYFP64);\n  vec2 texCoordYFP64 = div_fp64(xIndexFP64, gridSizeXFP64);\n\n  vTextureCoord = vec2(texCoordYFP64.x, texCoordXFP64.x);\n  gl_PointSize = 1.0;\n}\n",fs:"#version 300 es\n#define SHADER_NAME gpu-aggregation-all-fs\n\nprecision highp float;\n\nin vec2 vTextureCoord;\nuniform sampler2D uSampler;\nuniform bool combineMaxMin;\nout vec4 fragColor;\nvoid main(void) {\n  vec4 textureColor = texture(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n  if (textureColor.a == 0.) {\n    discard;\n  }\n  fragColor.rgb = textureColor.rgb;\n  fragColor.a = combineMaxMin ? textureColor.r : textureColor.a;\n}\n",modules:[w.fp64],vertexCount:1,drawMode:0,isInstanced:!0,instanceCount:n*r,attributes:{position:[0,0]}})}},{key:"getMeanTransform",value:function(e){return this.meanTransform?this.meanTransform.update(e):this.meanTransform=new w.Transform(this.gl,Object.assign({},{vs:"#define SHADER_NAME gpu-aggregation-transform-mean-vs\nattribute vec4 aggregationValues;\nvarying vec4 meanValues;\n\nvoid main()\n{\n  bool isCellValid = bool(aggregationValues.w > 0.);\n  meanValues.xyz = isCellValid ? aggregationValues.xyz/aggregationValues.w : vec3(0, 0, 0);\n  meanValues.w = aggregationValues.w;\n}\n",_targetTextureVarying:"meanValues"},e)),this.meanTransform}},{key:"renderAggregateData",value:function(e){var t=e.cellSize,n=e.viewport,r=e.gridTransformMatrix,i=e.projectPoints,o=this.state,a=o.numCol,s=o.numRow,u=o.windowSize,l=o.maxMinFramebuffers,c=o.minFramebuffers,g=o.maxFramebuffers,h=o.weights,f=[a,s],d={blend:!0,depthTest:!1,blendFunc:[1,1]},v={viewport:n},p={windowSize:u,cellSize:t,gridSize:f,uProjectionMatrix:r,uProjectionMatrixFP64:ue(r),projectPoints:i};for(var m in h){var y=h[m],x=y.needMin,S=y.needMax,b=x&&S&&h[m].combineMaxMin;this.renderToWeightsTexture({id:m,parameters:d,moduleSettings:v,uniforms:p,gridSize:f}),b?this.renderToMaxMinTexture({id:m,parameters:Object.assign({},d,{blendEquation:Q}),gridSize:f,minOrMaxFb:l[m],clearParams:{clearColor:[0,0,0,3402823466e29]},combineMaxMin:b}):(x&&this.renderToMaxMinTexture({id:m,parameters:Object.assign({},d,{blendEquation:K}),gridSize:f,minOrMaxFb:c[m],clearParams:{clearColor:[3402823466e29,3402823466e29,3402823466e29,0]},combineMaxMin:b}),S&&this.renderToMaxMinTexture({id:m,parameters:Object.assign({},d,{blendEquation:Z}),gridSize:f,minOrMaxFb:g[m],combineMaxMin:b}))}}},{key:"renderToMaxMinTexture",value:function(e){var t=e.id,n=e.parameters,r=e.gridSize,i=e.minOrMaxFb,o=e.combineMaxMin,a=e.clearParams,s=void 0===a?{}:a,u=this.state.framebuffers,l=this.gl,c=this.allAggregationModel;i.bind(),l.viewport(0,0,r[0],r[1]),Object(w.withParameters)(l,s,(function(){l.clear(16384)})),c.draw({parameters:n,uniforms:{uSampler:u[t].texture,gridSize:r,combineMaxMin:o}}),i.unbind()}},{key:"renderToWeightsTexture",value:function(e){var t=e.id,n=e.parameters,r=e.moduleSettings,i=e.uniforms,o=e.gridSize,a=this.state,s=a.framebuffers,u=a.equations,l=a.weightAttributes,c=a.weights,g=this.gl,h=this.gridAggregationModel,f=c[t].operation;s[t].bind(),g.viewport(0,0,o[0],o[1]);var d=f===W.MIN?[3402823466e29,3402823466e29,3402823466e29,0]:[0,0,0,0];Object(w.withParameters)(g,{clearColor:d},(function(){g.clear(16384)}));var v={weights:l[t]};if(h.draw({parameters:Object.assign({},n,{blendEquation:u[t]}),moduleSettings:r,uniforms:i,attributes:v}),s[t].unbind(),f===W.MEAN){var p=this.state,m=p.meanTextures,y=p.textures,S={_sourceTextures:{aggregationValues:m[t]},_targetTexture:y[t],elementCount:y[t].width*y[t].height};this.getMeanTransform(S).run({parameters:{blend:!1,depthTest:!1}}),s[t].attach(x()({},36064,y[t]))}}},{key:"runAggregationOnGPU",value:function(e){this.updateModels(e),this.setupFramebuffers(e),this.renderAggregateData(e);var t=this.getAggregateData(e);return this.setState({results:t}),t}},{key:"setupFramebuffers",value:function(e){var t=this.state,n=t.numCol,r=t.numRow,i=t.textures,o=t.framebuffers,a=t.maxMinFramebuffers,s=t.minFramebuffers,u=t.maxFramebuffers,l=t.meanTextures,c=t.equations,g=t.weights,h={width:n,height:r};for(var f in g){var d=g[f],v=d.needMin,p=d.needMax,m=d.combineMaxMin,y=d.operation;i[f]=g[f].aggregationTexture||i[f]||oe(this.gl,{id:"".concat(f,"-texture"),width:n,height:r}),i[f].resize(h);var S=i[f];y===W.MEAN&&(l[f]=l[f]||oe(this.gl,{id:"".concat(f,"-mean-texture"),width:n,height:r}),l[f].resize(h),S=l[f]),o[f]?o[f].attach(x()({},36064,S)):o[f]=ae(this.gl,{id:"".concat(f,"-fb"),width:n,height:r,texture:S}),o[f].resize(h),c[f]=J[y],(v||p)&&(v&&p&&m?a[f]||(S=this._getMinMaxTexture("".concat(f,"-maxMinTexture")),a[f]=ae(this.gl,{id:"".concat(f,"-maxMinFb"),texture:S})):(v&&(s[f]||(S=this._getMinMaxTexture("".concat(f,"-minTexture")),s[f]=ae(this.gl,{id:"".concat(f,"-minFb"),texture:S}))),p&&(u[f]||(S=this._getMinMaxTexture("".concat(f,"-maxTexture")),u[f]=ae(this.gl,{id:"".concat(f,"-maxFb"),texture:S})))))}}},{key:"_getMinMaxTexture",value:function(e){var t=this.state.resources;return t[e]||(t[e]=oe(this.gl,{id:"resourceName"})),t[e]}},{key:"setupModels",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.gridAggregationModel&&this.gridAggregationModel.delete(),this.gridAggregationModel=this.getAggregationModel(e),this.allAggregationModel||(this.allAggregationModel=this.getAllAggregationModel())}},{key:"setupWeightAttributes",value:function(e){var t=this.state,n=t.weightAttributes,r=t.vertexCount,i=t.weights,o=t.resources;for(var a in i){var s=i[a].values;if(Array.isArray(s)||s.constructor===Float32Array){v.log.assert(s.length/3===r);var u=Array.isArray(s)?new Float32Array(s):s;n[a]instanceof w.Buffer?n[a].setData(u):(o["".concat(a,"-buffer")]=new w.Buffer(this.gl,u),n[a]=o["".concat(a,"-buffer")])}else v.log.assert(s instanceof w.Buffer),n[a]=s}}},{key:"trackGPUResultBuffers",value:function(e,t){var n=this.state.resources;for(var r in e)if(e[r]){var i=!0,o=!1,a=void 0;try{for(var s,u=le[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var l=s.value;if(e[r][l]&&t[r][l]!==e[r][l]){var c="gpu-result-".concat(r,"-").concat(l);n[c]&&n[c].delete(),n[c]=e[r][l]}}}catch(e){o=!0,a=e}finally{try{i||null==u.return||u.return()}finally{if(o)throw a}}}}},{key:"updateModels",value:function(e){var t=this.gl,n=e.positions,r=e.positions64xyLow,i=e.changeFlags,o=this.state,a=o.numCol,s=o.numRow,u={},l=!1;if(e.fp64!==this.state.fp64&&(this.setupModels(e.fp64),this.setState({fp64:e.fp64}),l=!0),i.dataChanged||!this.state.positionsBuffer){var c=this.state,g=c.positionsBuffer,h=c.positions64xyLowBuffer;g&&g.delete(),h&&h.delete();var f=n.length/2;g=new w.Buffer(t,new Float32Array(n)),h=new w.Buffer(t,{data:new Float32Array(r),accessor:{size:2}}),this.setState({positionsBuffer:g,positions64xyLowBuffer:h,vertexCount:f}),this.setupWeightAttributes(e),l=!0}if(l){var d=this.state,v=d.vertexCount,p=d.positionsBuffer,m=d.positions64xyLowBuffer;u.positions=p,e.fp64&&(u.positions64xyLow=m),this.gridAggregationModel.setVertexCount(v),this.gridAggregationModel.setAttributes(u)}(i.cellSizeChanged||i.viewportChanged)&&this.allAggregationModel.setInstanceCount(a*s)}}]),e}(),fe=v.experimental.count,de=[0,0,0,0],ve=[0,255,0,255],pe=["minColor","maxColor","colorRange","colorDomain"],me={cellSizePixels:{value:100,min:1},cellMarginPixels:{value:2,min:0,max:5},colorDomain:null,colorRange:p,getPosition:{type:"accessor",value:function(e){return e.position}},getWeight:{type:"accessor",value:function(e){return[1,0,0]}},gpuAggregation:!0,aggregation:"SUM"},ye=function(e){function t(){return i()(this,t),u()(this,c()(t).apply(this,arguments))}return d()(t,e),a()(t,[{key:"getShaders",value:function(){return h()(c()(t.prototype),"getShaders",this).call(this,{vs:"#define SHADER_NAME screen-grid-layer-vertex-shader\n#define RANGE_COUNT 6\n\nattribute vec3 positions;\nattribute vec3 instancePositions;\nattribute vec4 instanceCounts;\nattribute vec3 instancePickingColors;\n\nuniform float opacity;\nuniform vec3 cellScale;\nuniform vec4 minColor;\nuniform vec4 maxColor;\nuniform vec4 colorRange[RANGE_COUNT];\nuniform vec2 colorDomain;\nuniform bool shouldUseMinMax;\nuniform sampler2D maxTexture;\n\nvarying vec4 vColor;\nvarying float vSampleCount;\n\nvec4 quantizeScale(vec2 domain, vec4 range[RANGE_COUNT], float value) {\n  vec4 outColor = vec4(0., 0., 0., 0.);\n  if (value >= domain.x && value <= domain.y) {\n    float domainRange = domain.y - domain.x;\n    if (domainRange <= 0.) {\n      outColor = colorRange[0];\n    } else {\n      float rangeCount = float(RANGE_COUNT);\n      float rangeStep = domainRange / rangeCount;\n      float idx = floor((value - domain.x) / rangeStep);\n      idx = clamp(idx, 0., rangeCount - 1.);\n      int intIdx = int(idx);\n      outColor = colorRange[intIdx];\n    }\n  }\n  outColor = outColor / 255.;\n  return outColor;\n}\n\nvoid main(void) {\n  vSampleCount = instanceCounts.a;\n\n  float weight = instanceCounts.r;\n  float maxWeight = texture2D(maxTexture, vec2(0.5)).r;\n\n  float step = weight / maxWeight;\n  vec4 minMaxColor = mix(minColor, maxColor, step) / 255.;\n\n  vec2 domain = colorDomain;\n  float domainMaxValid = float(colorDomain.y != 0.);\n  domain.y = mix(maxWeight, colorDomain.y, domainMaxValid);\n  vec4 rangeColor = quantizeScale(domain, colorRange, weight);\n\n  float rangeMinMax = float(shouldUseMinMax);\n  vec4 color = mix(rangeColor, minMaxColor, rangeMinMax);\n  vColor = vec4(color.rgb, color.a * opacity);\n  picking_setPickingColor(instancePickingColors);\n\n  gl_Position = vec4(instancePositions + positions * cellScale, 1.);\n}\n",fs:"#define SHADER_NAME screen-grid-layer-fragment-shader\n\nprecision highp float;\n\nvarying vec4 vColor;\nvarying float vSampleCount;\n\nvoid main(void) {\n  if (vSampleCount <= 0.0) {\n    discard;\n  }\n  gl_FragColor = vColor;\n\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n",modules:["picking"]})}},{key:"initializeState",value:function(){var e=this.getAttributeManager(),t=this.context.gl;if(!Object(w.hasFeatures)(t,[w.FEATURES.TEXTURE_FLOAT]))return this.setState({supported:!1}),void v.log.error("ScreenGridLayer: ".concat(this.id," is not supported on this browser"))();e.addInstanced({instancePositions:{size:3,update:this.calculateInstancePositions},instanceCounts:{size:4,transition:!0,accessor:["getPosition","getWeight"],update:this.calculateInstanceCounts,noAlloc:!0}});var n={id:"".concat(this.id,"-aggregator")},r={color:{size:1,operation:W.SUM,needMax:!0}};this.setState({supported:!0,model:this._getModel(t),gpuGridAggregator:new he(t,n),weights:r})}},{key:"shouldUpdateState",value:function(e){var t=e.changeFlags;return this.state.supported&&t.somethingChanged}},{key:"updateState",value:function(e){h()(c()(t.prototype),"updateState",this).call(this,e),this._updateUniforms(e),e.changeFlags.dataChanged&&this._processData();var n=this._getAggregationChangeFlags(e);n&&((n.cellSizeChanged||n.viewportChanged)&&this._updateGridParams(),this.state.pointCount>0&&this._updateAggregation(n))}},{key:"finalizeState",value:function(){h()(c()(t.prototype),"finalizeState",this).call(this);var e=this.state,n=e.aggregationBuffer,r=e.maxBuffer,i=e.gpuGridAggregator,o=e.maxTexture;i.delete(),n&&n.delete(),r&&r.delete(),o&&o.delete()}},{key:"draw",value:function(e){var t=e.uniforms;if(this.state.supported){var n=this.props.parameters,r=void 0===n?{}:n,i=this.props.minColor||de,o=this.props.maxColor||ve,a=this.props.colorDomain||[1,0],s=this.state,u=s.model,l=s.cellScale,c=s.shouldUseMinMax,g=s.colorRange,h={minColor:i,maxColor:o,maxTexture:s.maxTexture,cellScale:l,colorRange:g,colorDomain:a,shouldUseMinMax:c};t=Object.assign(h,t),u.draw({uniforms:t,parameters:Object.assign({depthTest:!1,depthMask:!1},r)})}}},{key:"calculateInstancePositions",value:function(e,t){for(var n=t.numInstances,r=this.context.viewport,i=r.width,o=r.height,a=this.props.cellSizePixels,s=this.state.numCol,u=e.value,l=e.size,c=0;c<n;c++){var g=c%s,h=Math.floor(c/s);u[c*l+0]=g*a/i*2-1,u[c*l+1]=1-h*a/o*2,u[c*l+2]=0}}},{key:"calculateInstanceCounts",value:function(e,t){t.numInstances;var n=this.state.aggregationBuffer;e.update({buffer:n})}},{key:"getPickingInfo",value:function(e){var t=e.info,n=(e.mode,t.index);if(n>=0){var r=this.state.gpuGridAggregator.getData("color");t.object=he.getAggregationData(Object.assign({pixelIndex:n},r))}return t}},{key:"_getAggregationChangeFlags",value:function(e){var t=e.oldProps,n=e.props,r=e.changeFlags,i=n.cellSizePixels!==t.cellSizePixels||n.cellMarginPixels!==t.cellMarginPixels,o=r.dataChanged||n.aggregation!==t.aggregation,a=r.viewportChanged;return i||o||a?{cellSizeChanged:i,dataChanged:o,viewportChanged:a}:null}},{key:"_getModel",value:function(e){return new w.Model(e,Object.assign({},this.getShaders(),{id:this.props.id,geometry:new w.Geometry({drawMode:6,attributes:{positions:new Float32Array([0,0,0,1,0,0,1,1,0,0,1,0])}}),isInstanced:!0}))}},{key:"_processData",value:function(){var e=this.props,t=e.data,n=e.getPosition,r=e.getWeight,i=fe(t),o=new Float64Array(2*i),a=new Float32Array(3*i),s=this.state.weights,u=Object(v.createIterable)(t),l=u.iterable,c=u.objectInfo,g=!0,h=!1,f=void 0;try{for(var d,p=l[Symbol.iterator]();!(g=(d=p.next()).done);g=!0){var m=d.value;c.index++;var y=n(m,c),x=r(m,c),S=c.index;o[2*S]=y[0],o[2*S+1]=y[1],Array.isArray(x)?(a[3*S]=x[0],a[3*S+1]=x[1],a[3*S+2]=x[2]):a[3*S]=x}}catch(e){h=!0,f=e}finally{try{g||null==p.return||p.return()}finally{if(h)throw f}}s.color.values=a,this.setState({positions:o,pointCount:i})}},{key:"_shouldUseMinMax",value:function(){var e=this.props,t=e.minColor,n=e.maxColor,r=e.colorDomain,i=e.colorRange;return t||n?(v.log.deprecated("ScreenGridLayer props: minColor and maxColor","colorRange, colorDomain")(),!0):!r&&!i}},{key:"_updateAggregation",value:function(e){var t=this.getAttributeManager(),n=this.props,r=n.cellSizePixels,i=n.gpuAggregation,o=this.state,a=o.positions,s=o.weights,u=this.context.viewport;s.color.operation=W[this.props.aggregation.toUpperCase()]||W.SUM;var l=!1,c=null;this.context.viewport instanceof v.WebMercatorViewport?l=!0:(l=!1,c=u.pixelProjectionMatrix);var g=this.state.gpuGridAggregator.run({positions:a,weights:s,cellSize:[r,r],viewport:u,changeFlags:e,useGPU:i,projectPoints:l,gridTransformMatrix:c});t.invalidate("instanceCounts"),this.setState({maxTexture:g.color.maxTexture})}},{key:"_updateUniforms",value:function(e){var t=e.oldProps,n=e.props,r=e.changeFlags,i={};if(pe.some((function(e){return t[e]!==n[e]}))&&(i.shouldUseMinMax=this._shouldUseMinMax()),t.colorRange!==n.colorRange&&(i.colorRange=m(n.colorRange)),t.cellMarginPixels!==n.cellMarginPixels||t.cellSizePixels!==n.cellSizePixels||r.viewportChanged){var o=this.context.viewport,a=o.width,s=o.height,u=this.props,l=u.cellSizePixels,c=u.cellMarginPixels,g=l>c?c:0;i.cellScale=new Float32Array([(l-g)/a*2,-(l-g)/s*2,1])}this.setState(i)}},{key:"_updateGridParams",value:function(){this.getAttributeManager().invalidateAll();var e=this.context.viewport,t=e.width,n=e.height,r=this.props.cellSizePixels,i=this.context.gl,o=Math.ceil(t/r),a=Math.ceil(n/r),s=o*a,u=4*s*4,l=this.state.aggregationBuffer;l&&l.delete(),l=new w.Buffer(i,{byteLength:u,accessor:{size:4,type:5126,divisor:1}}),this.state.weights.color.aggregationBuffer=l,this.setState({numCol:o,numRow:a,numInstances:s,aggregationBuffer:l})}}]),t}(v.Layer);ye.layerName="ScreenGridLayer",ye.defaultProps=me;var xe=6378e3;function Se(e){var t=function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0,i=1/0,o=-1/0,a=Object(v.createIterable)(t),s=a.iterable,u=a.objectInfo,l=!0,c=!1,g=void 0;try{for(var h,f=s[Symbol.iterator]();!(l=(h=f.next()).done);l=!0){var d=h.value;u.index++,e=r(d,u)[1],Number.isFinite(e)&&(i=e<i?e:i,o=e>o?e:o)}}catch(e){c=!0,g=e}finally{try{l||null==f.return||f.return()}finally{if(c)throw g}}var p=function(e,t){var n=(a=e,a/xe*(180/Math.PI)),r=(i=t,o=e,o/xe*(180/Math.PI)/Math.cos(i*Math.PI/180));var i,o;var a;return{yOffset:n,xOffset:r}}(n,(i+o)/2);if(p.xOffset<=0||p.yOffset<=0)return{gridHash:{},gridOffset:p};var m={};u.index=-1;var y=!0,x=!1,S=void 0;try{for(var w,M=s[Symbol.iterator]();!(y=(w=M.next()).done);y=!0){var C=w.value;u.index++;var P=r(C,u),T=b()(P,2),A=T[0],k=T[1];if(Number.isFinite(k)&&Number.isFinite(A)){var E=Math.floor((k+90)/p.yOffset),O=Math.floor((A+180)/p.xOffset),D="".concat(E,"-").concat(O);m[D]=m[D]||{count:0,points:[]},m[D].count+=1,m[D].points.push(C)}}}catch(e){x=!0,S=e}finally{try{y||null==M.return||M.return()}finally{if(x)throw S}}return{gridHash:m,gridOffset:p}}(e.data,e.cellSize,e.getPosition),n=t.gridHash,r=t.gridOffset;return{gridHash:n,gridOffset:r,data:function(e,t){return Object.keys(e).reduce((function(n,r,i){var o=r.split("-"),a=parseInt(o[0],10),s=parseInt(o[1],10);return n.push(Object.assign({index:i,position:[t.xOffset*s-180,t.yOffset*a-90]},e[r])),n}),[])}(n,r)}}var be=n(10),we=n.n(be),Me=function(e){return e.length},Ce=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Me;i()(this,e),this.sortedBins=this.getSortedBins(t,n),this.maxCount=this.getMaxCount(),this.binMap=this.getBinMap()}return a()(e,[{key:"getSortedBins",value:function(e,t){return e.reduce((function(e,n,r){var i=t(n.points);return null!=i&&e.push({i:Number.isFinite(n.index)?n.index:r,value:i,counts:n.points.length}),e}),[]).sort((function(e,t){return e.value-t.value}))}},{key:"getValueRange",value:function(e){var t=b()(e,2),n=t[0],r=t[1],i=this.sortedBins.length;if(!i)return[0,0];var o=Math.ceil(n/100*(i-1)),a=Math.floor(r/100*(i-1));return[this.sortedBins[o].value,this.sortedBins[a].value]}},{key:"getMaxCount",value:function(){var e=0;return this.sortedBins.forEach((function(t){return e=e>t.counts?e:t.counts})),e}},{key:"getBinMap",value:function(){return this.sortedBins.reduce((function(e,t){return Object.assign(e,x()({},t.i,t))}),{})}}]),e}();function Pe(e,t,n){return(n-e[0])/(e[1]-e[0])*(t[1]-t[0])+t[0]}function Te(e,t,n){var r=e[1]-e[0];if(r<=0)return v.log.warn("quantizeScale: invalid domain, returning range[0]")(),t[0];var i=r/t.length,o=Math.floor((n-e[0])/i);return t[Math.max(Math.min(o,t.length-1),0)]}function Ae(e,t,n){function r(r){return n(e,t,r)}return r.domain=function(){return e},r.range=function(){return t},r}function ke(e,t){return Ae(e,t,Te)}function Ee(e,t){return Ae(e,t,Pe)}function Oe(e,t){return e-t}function De(e,t){var n=e.length;if(t<=0||n<2)return e[0];if(t>=1)return e[n-1];var r=(n-1)*t,i=Math.floor(r),o=e[i];return o+(e[i+1]-o)*(r-i)}function _e(e,t,n){return t[function(e,t){for(var n=0,r=e.length;n<r;){var i=n+r>>>1;Oe(e[i],t)>0?r=i:n=i+1}return n}(e,n)]}function ze(e,t){for(var n=e.sort(Oe),r=0,i=Math.max(1,t.length),o=new Array(i-1);++r<i;)o[r-1]=De(n,r/i);return function(e){return _e(o,t,e)}}function Ne(e,t){var n=new Map,r=[],i=!0,o=!1,a=void 0;try{for(var s,u=e[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var l=s.value,c="".concat(l);n.has(c)||n.set(c,r.push(l))}}catch(e){o=!0,a=e}finally{try{i||null==u.return||u.return()}finally{if(o)throw a}}return function(e){return function(e,t,n,r){var i="".concat(r),o=t.get(i);return void 0===o&&(o=e.push(r),t.set(i,o)),n[(o-1)%n.length]}(r,n,t,e)}}function je(){}var Fe=["getBins","getDomain","getScaleFunc"],Le=[{key:"fillColor",accessor:"getFillColor",pickingInfo:"colorValue",getBins:{triggers:{value:{prop:"getColorValue",updateTrigger:"getColorValue"},weight:{prop:"getColorWeight",updateTrigger:"getColorWeight"},aggregation:{prop:"colorAggregation"}}},getDomain:{triggers:{lowerPercentile:{prop:"lowerPercentile"},upperPercentile:{prop:"upperPercentile"}},onSet:{props:"onSetColorDomain"}},getScaleFunc:{triggers:{domain:{prop:"colorDomain"},range:{prop:"colorRange"},scaleType:{prop:"colorScaleType"}}},nullValue:[0,0,0,0]},{key:"elevation",accessor:"getElevation",pickingInfo:"elevationValue",getBins:{triggers:{value:{prop:"getElevationValue",updateTrigger:"getElevationValue"},weight:{prop:"getElevationWeight",updateTrigger:"getElevationWeight"},aggregation:{prop:"elevationAggregation"}}},getDomain:{triggers:{lowerPercentile:{prop:"elevationLowerPercentile"},upperPercentile:{prop:"elevationUpperPercentile"}},onSet:{props:"onSetElevationDomain"}},getScaleFunc:{triggers:{domain:{prop:"elevationDomain"},range:{prop:"elevationRange"},scaleType:{prop:"elevationScaleType"}}},nullValue:-1}],Re=function(e){return e.cellSize},Be=function(){function e(t){i()(this,e),this.state={layerData:{},dimensions:{}},this.changeFlags={},this.dimensionUpdaters={},this._getCellSize=t.getCellSize||Re,this._getAggregator=t.getAggregator,this._addDimension(t.dimensions||Le)}return a()(e,[{key:"updateState",value:function(e,t){var n=e.oldProps,r=e.props,i=e.changeFlags;this.updateGetValueFuncs(n,r,i);var o=this.needsReProjectPoints(n,r,i);i.dataChanged||o?this.getAggregatedData(r,t):(this.getDimensionChanges(n,r,i)||[]).forEach((function(e){return"function"==typeof e&&e()}));return this.state}},{key:"setState",value:function(e){this.state=Object.assign({},this.state,e)}},{key:"setDimensionState",value:function(e,t){this.setState({dimensions:Object.assign({},this.state.dimensions,x()({},e,Object.assign({},this.state.dimensions[e],t)))})}},{key:"normalizeResult",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e.hexagons?Object.assign({data:e.hexagons},e):e.layerData?Object.assign({data:e.layerData},e):e}},{key:"getAggregatedData",value:function(e,t){var n=this._getAggregator(e)(e,t);this.setState({layerData:this.normalizeResult(n)}),this.changeFlags={layerData:!0},this.getSortedBins(e)}},{key:"updateGetValueFuncs",value:function(e,t,n){for(var r in this.dimensionUpdaters){var i=this.dimensionUpdaters[r].getBins.triggers,o=i.value,a=i.weight,s=i.aggregation,u=t[o.prop];this.needUpdateDimensionStep(this.dimensionUpdaters[r].getBins,e,t,n)&&null===u&&(u=Y(t[s.prop],t[a.prop])),u&&this.setDimensionState(r,{getValue:u})}}},{key:"needsReProjectPoints",value:function(e,t,n){return this._getCellSize(e)!==this._getCellSize(t)||this._getAggregator(e)!==this._getAggregator(t)||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getPosition)}},{key:"addDimension",value:function(e){this._addDimension(e)}},{key:"_addDimension",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];t.forEach((function(t){var n=t.key;e.dimensionUpdaters[n]=e.getDimensionUpdaters(t),e.state.dimensions[n]={getValue:null,domain:null,sortedBins:null,scaleFunc:je}}))}},{key:"getDimensionUpdaters",value:function(e){var t=e.key,n=e.accessor,r=e.pickingInfo,i=e.getBins,o=e.getDomain,a=e.getScaleFunc,s=e.nullValue;return{key:t,accessor:n,pickingInfo:r,getBins:Object.assign({updater:this.getDimensionSortedBins},i),getDomain:Object.assign({updater:this.getDimensionValueDomain},o),getScaleFunc:Object.assign({updater:this.getDimensionScale},a),attributeAccessor:this.getSubLayerDimensionAttribute(t,s)}}},{key:"needUpdateDimensionStep",value:function(e,t,n,r){return Object.values(e.triggers).some((function(e){return e.updateTrigger?r.updateTriggersChanged&&(r.updateTriggersChanged.all||r.updateTriggersChanged[e.updateTrigger]):t[e.prop]!==n[e.prop]}))}},{key:"getDimensionChanges",value:function(e,t,n){var r=this,i=[],o=function(o){var a=Fe.find((function(i){return r.needUpdateDimensionStep(r.dimensionUpdaters[o][i],e,t,n)}));a&&i.push(r.dimensionUpdaters[o][a].updater.bind(r,t,r.dimensionUpdaters[o]))};for(var a in this.dimensionUpdaters)o(a);return i.length?i:null}},{key:"getUpdateTriggers",value:function(e){var t=this,n=e.updateTriggers||{},r={},i=function(i){var o=t.dimensionUpdaters[i].accessor;r[o]={},Fe.forEach((function(a){Object.values(t.dimensionUpdaters[i][a].triggers).forEach((function(t){var i=t.prop,a=t.updateTrigger;if(a){var s=n[a];"object"!==we()(s)||Array.isArray(s)?void 0!==s&&(r[o][i]=s):Object.assign(r[o],s)}else r[o][i]=e[i]}))}))};for(var o in this.dimensionUpdaters)i(o);return r}},{key:"getScaleFunctionByScaleType",value:function(e){switch(e){case"quantize":return ke;case"linear":return Ee;case"quantile":return ze;case"ordinal":return Ne;default:return ke}}},{key:"getSortedBins",value:function(e){for(var t in this.dimensionUpdaters)this.getDimensionSortedBins(e,this.dimensionUpdaters[t])}},{key:"getDimensionSortedBins",value:function(e,t){var n=t.key,r=this.state.dimensions[n].getValue,i=new Ce(this.state.layerData.data||[],r);this.setDimensionState(n,{sortedBins:i}),this.getDimensionValueDomain(e,t)}},{key:"getDimensionValueDomain",value:function(e,t){var n=t.getDomain,r=t.key,i=n.triggers,o=i.lowerPercentile,a=i.upperPercentile,s=n.onSet,u=this.state.dimensions[r].sortedBins.getValueRange([e[o.prop],e[a.prop]]);"object"===we()(s)&&"function"==typeof e[s.props]&&e[s.props](u),this.setDimensionState(r,{valueDomain:u}),this.getDimensionScale(e,t)}},{key:"getDimensionScale",value:function(e,t){var n=t.key,r=t.getScaleFunc.triggers,i=r.domain,o=r.range,a=r.scaleType,s=e[o.prop],u=e[i.prop]||this.state.dimensions[n].valueDomain,l=this.getScaleFunctionByScaleType(e[a.prop])(u,s);this.setDimensionState(n,{scaleFunc:l})}},{key:"getSubLayerDimensionAttribute",value:function(e,t){var n=this;return function(r){var i=n.state.dimensions[e],o=i.sortedBins,a=i.scaleFunc,s=o.binMap[r.index]&&o.binMap[r.index].value,u=a.domain();return s>=u[0]&&s<=u[u.length-1]?a(s):t}}},{key:"getSubLayerAccessors",value:function(e){var t={};for(var n in this.dimensionUpdaters){t[this.dimensionUpdaters[n].accessor]=this.getSubLayerDimensionAttribute(e,n)}return t}},{key:"getPickingInfo",value:function(e){var t=e.info,n=null;if(t.picked&&t.index>-1){var r=this.state.layerData.data[t.index],i={};for(var o in this.dimensionUpdaters){var a=this.dimensionUpdaters[o].pickingInfo,s=this.state.dimensions[o].sortedBins,u=s.binMap[r.index]&&s.binMap[r.index].value;i[a]=u}n=Object.assign(i,r)}return Object.assign(t,{picked:Boolean(n),object:n})}},{key:"getAccessor",value:function(e){return this.dimensionUpdaters.hasOwnProperty(e)?this.dimensionUpdaters[e].attributeAccessor:je}}],[{key:"defaultDimensions",value:function(){return Le}}]),e}();function Ie(){}var We={colorDomain:null,colorRange:p,getColorValue:{type:"accessor",value:null},getColorWeight:{type:"accessor",value:function(e){return 1}},colorAggregation:"SUM",lowerPercentile:{type:"number",min:0,max:100,value:0},upperPercentile:{type:"number",min:0,max:100,value:100},colorScaleType:"quantize",onSetColorDomain:Ie,elevationDomain:null,elevationRange:[0,1e3],getElevationValue:{type:"accessor",value:null},getElevationWeight:{type:"accessor",value:function(e){return 1}},elevationAggregation:"SUM",elevationLowerPercentile:{type:"number",min:0,max:100,value:0},elevationUpperPercentile:{type:"number",min:0,max:100,value:100},elevationScale:{type:"number",min:0,value:1},elevationScaleType:"linear",onSetElevationDomain:Ie,gridAggregator:Se,cellSize:{type:"number",min:0,max:1e3,value:1e3},coverage:{type:"number",min:0,max:1,value:1},getPosition:{type:"accessor",value:function(e){return e.position}},extruded:!1,material:new w.PhongMaterial},Ue=function(e){function t(){return i()(this,t),u()(this,c()(t).apply(this,arguments))}return d()(t,e),a()(t,[{key:"initializeState",value:function(){var e=new Be({getAggregator:function(e){return e.gridAggregator},getCellSize:function(e){return e.cellSize}});this.state={cpuAggregator:e,aggregatorState:e.state}}},{key:"updateState",value:function(e){var t=e.oldProps,n=e.props,r=e.changeFlags;this.setState({aggregatorState:this.state.cpuAggregator.updateState({oldProps:t,props:n,changeFlags:r},this.context.viewport)})}},{key:"getPickingInfo",value:function(e){var t=e.info;return this.state.cpuAggregator.getPickingInfo({info:t})}},{key:"_onGetSublayerColor",value:function(e){return this.state.cpuAggregator.getAccessor("fillColor")(e)}},{key:"_onGetSublayerElevation",value:function(e){return this.state.cpuAggregator.getAccessor("elevation")(e)}},{key:"_getSublayerUpdateTriggers",value:function(){return this.state.cpuAggregator.getUpdateTriggers(this.props)}},{key:"renderLayers",value:function(){var e=this.props,t=e.elevationScale,n=e.extruded,r=e.cellSize,i=e.coverage,o=e.material,a=e.transitions,s=this.state.cpuAggregator,u=this.getSubLayerClass("grid-cell",v.GridCellLayer),l=this._getSublayerUpdateTriggers();return new u({cellSize:r,coverage:i,material:o,elevationScale:t,extruded:n,getFillColor:this._onGetSublayerColor.bind(this),getElevation:this._onGetSublayerElevation.bind(this),transitions:a&&{getFillColor:a.getColorValue||a.getColorWeight,getElevation:a.getElevationValue||a.getElevationWeight}},this.getSubLayerProps({id:"grid-cell",updateTriggers:l}),{data:s.state.layerData.data})}}]),t}(v.CompositeLayer);Ue.layerName="CPUGridLayer",Ue.defaultProps=We;var Ge=Math.PI/3,Ve=[0,Ge,2*Ge,3*Ge,4*Ge,5*Ge];function Ye(e){return e[0]}function Xe(e){return e[1]}var qe=function(){var e,t,n,r=0,i=0,o=1,a=1,s=Ye,u=Xe;function l(e){var r,i={},o=[],a=e.length;for(r=0;r<a;++r)if(!isNaN(c=+s.call(null,l=e[r],r,e))&&!isNaN(g=+u.call(null,l,r,e))){var l,c,g,h=Math.round(g/=n),f=Math.round(c=c/t-(1&h)/2),d=g-h;if(3*Math.abs(d)>1){var v=c-f,p=f+(c<f?-1:1)/2,m=h+(g<h?-1:1),y=c-p,x=g-m;v*v+d*d>y*y+x*x&&(f=p+(1&h?1:-1)/2,h=m)}var S=f+"-"+h,b=i[S];b?b.push(l):(o.push(b=i[S]=[l]),b.x=(f+(1&h)/2)*t,b.y=h*n)}return o}function c(e){var t=0,n=0;return Ve.map((function(r){var i=Math.sin(r)*e,o=-Math.cos(r)*e,a=i-t,s=o-n;return t=i,n=o,[a,s]}))}return l.hexagon=function(t){return"m"+c(null==t?e:+t).join("l")+"z"},l.centers=function(){for(var s=[],u=Math.round(i/n),l=Math.round(r/t),c=u*n;c<a+e;c+=n,++u)for(var g=l*t+(1&u)*t/2;g<o+t/2;g+=t)s.push([g,c]);return s},l.mesh=function(){var t=c(e).slice(0,4).join("l");return l.centers().map((function(e){return"M"+e+"m"+t})).join("")},l.x=function(e){return arguments.length?(s=e,l):s},l.y=function(e){return arguments.length?(u=e,l):u},l.radius=function(r){return arguments.length?(t=2*(e=+r)*Math.sin(Ge),n=1.5*e,l):e},l.size=function(e){return arguments.length?(r=i=0,o=+e[0],a=+e[1],l):[o-r,a-i]},l.extent=function(e){return arguments.length?(r=+e[0][0],i=+e[0][1],o=+e[1][0],a=+e[1][1],l):[[r,i],[o,a]]},l.radius(1)};function He(){}var Ke={colorDomain:null,colorRange:p,getColorValue:{type:"accessor",value:null},getColorWeight:{type:"accessor",value:function(e){return 1}},colorAggregation:"SUM",lowerPercentile:{type:"number",value:0,min:0,max:100},upperPercentile:{type:"number",value:100,min:0,max:100},colorScaleType:"quantize",onSetColorDomain:He,elevationDomain:null,elevationRange:[0,1e3],getElevationValue:{type:"accessor",value:null},getElevationWeight:{type:"accessor",value:function(e){return 1}},elevationAggregation:"SUM",elevationLowerPercentile:{type:"number",value:0,min:0,max:100},elevationUpperPercentile:{type:"number",value:100,min:0,max:100},elevationScale:{type:"number",min:0,value:1},elevationScaleType:"linear",onSetElevationDomain:He,radius:{type:"number",value:1e3,min:1},coverage:{type:"number",min:0,max:1,value:1},extruded:!1,hexagonAggregator:function(e,t){var n=e.data,r=e.radius,i=e.getPosition,o=function(e,t){var n=t.getDistanceScales().pixelsPerMeter;return e*n[0]}(r,t),a=[],s=Object(v.createIterable)(n),u=s.iterable,l=s.objectInfo,c=!0,g=!1,h=void 0;try{for(var f,d=u[Symbol.iterator]();!(c=(f=d.next()).done);c=!0){var p=f.value;l.index++;var m=i(p,l);Number.isFinite(m[0])&&Number.isFinite(m[1])?a.push(Object.assign({screenCoord:t.projectFlat(m)},p)):v.log.warn("HexagonLayer: invalid position")()}}catch(e){g=!0,h=e}finally{try{c||null==d.return||d.return()}finally{if(g)throw h}}return{hexagons:qe().radius(o).x((function(e){return e.screenCoord[0]})).y((function(e){return e.screenCoord[1]}))(a).map((function(e,n){return{position:t.unprojectFlat([e.x,e.y]),points:e,index:n}}))}},getPosition:{type:"accessor",value:function(e){return e.position}},material:new w.PhongMaterial},Ze=function(e){function t(){return i()(this,t),u()(this,c()(t).apply(this,arguments))}return d()(t,e),a()(t,[{key:"initializeState",value:function(){var e=new Be({getAggregator:function(e){return e.hexagonAggregator},getCellSize:function(e){return e.radius}});this.state={cpuAggregator:e,aggregatorState:e.state}}},{key:"updateState",value:function(e){var t=e.oldProps,n=e.props,r=e.changeFlags,i=this.state.cpuAggregator,o=i.state.layerData;if(this.setState({aggregatorState:i.updateState({oldProps:t,props:n,changeFlags:r},this.context.viewport)}),o!==i.state.layerData){var a=i.state.layerData.hexagonVertices;this.updateRadiusAngle(a)}}},{key:"updateRadiusAngle",value:function(e){var t=this.props.radius,n=90;if(Array.isArray(e)){e.length<6&&v.log.error("HexagonCellLayer: hexagonVertices needs to be an array of 6 points")();var r=e[0],i=e[3],o=this.context.viewport.getDistanceScales().pixelsPerMeter,a=this.projectFlat(r),s=this.projectFlat(i),u=a[0]-s[0],l=a[1]-s[1],c=Math.sqrt(u*u+l*l);n=Math.acos(u/c)*-Math.sign(l)/Math.PI*180+90,t=c/2/o[0]}this.setState({angle:n,radius:t})}},{key:"getPickingInfo",value:function(e){var t=e.info;return this.state.cpuAggregator.getPickingInfo({info:t})}},{key:"_onGetSublayerColor",value:function(e){return this.state.cpuAggregator.getAccessor("fillColor")(e)}},{key:"_onGetSublayerElevation",value:function(e){return this.state.cpuAggregator.getAccessor("elevation")(e)}},{key:"_getSublayerUpdateTriggers",value:function(){return this.state.cpuAggregator.getUpdateTriggers(this.props)}},{key:"renderLayers",value:function(){var e=this.props,t=e.elevationScale,n=e.extruded,r=e.coverage,i=e.material,o=e.transitions,a=this.state,s=a.angle,u=a.radius,l=a.cpuAggregator,c=this.getSubLayerClass("hexagon-cell",v.ColumnLayer),g=this._getSublayerUpdateTriggers();return new c({radius:u,diskResolution:6,elevationScale:t,angle:s,extruded:n,coverage:r,material:i,getFillColor:this._onGetSublayerColor.bind(this),getElevation:this._onGetSublayerElevation.bind(this),transitions:o&&{getFillColor:o.getColorValue||o.getColorWeight,getElevation:o.getElevationValue||o.getElevationWeight}},this.getSubLayerProps({id:"hexagon-cell",updateTriggers:g}),{data:l.state.layerData.data})}}]),t}(v.CompositeLayer);function Qe(e){return(Qe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Je(e){return(Je="function"==typeof Symbol&&"symbol"===Qe(Symbol.iterator)?function(e){return Qe(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":Qe(e)})(e)}function $e(e,t){return($e=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function et(e,t,n){return(et=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&$e(i,n.prototype),i}).apply(null,arguments)}Ze.layerName="HexagonLayer",Ze.defaultProps=Ke;Math.PI,Math.PI;var tt,nt={};function rt(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).precision,n=void 0===t?nt.precision||4:t;return e=function(e){return Math.round(e/nt.EPSILON)*nt.EPSILON}(e),"".concat(parseFloat(e.toPrecision(n)))}function it(e){return Array.isArray(e)||ArrayBuffer.isView(e)&&void 0!==e.length}function ot(e,t,n){var r=nt.EPSILON;n&&(nt.EPSILON=n);try{if(e===t)return!0;if(it(e)&&it(t)){if(e.length!==t.length)return!1;for(var i=0;i<e.length;++i)if(!ot(e[i],t[i]))return!1;return!0}return e&&"object"===Je(e)&&e.equals?e.equals(t):t&&"object"===Je(t)&&t.equals?t.equals(e):Math.abs(e-t)<=nt.EPSILON*Math.max(1,Math.abs(e),Math.abs(t))}finally{nt.EPSILON=r}}nt.EPSILON=1e-12,nt.debug=!1,nt.precision=4,nt.printTypes=!1,nt.printDegrees=!1,nt.printRowMajor=!0;var at={N:[0,.5],E:[.5,0],S:[0,-.5],W:[-.5,0],NE:[.5,.5],NW:[-.5,.5],SE:[.5,-.5],SW:[-.5,-.5]},st=[at.W,at.SW,at.S],ut=[at.S,at.SE,at.E],lt=[at.E,at.NE,at.N],ct=[at.NW,at.W,at.N],gt=[[-.5,1/6],[-.5,-1/6],[-1/6,-.5],[1/6,-.5]],ht=[[-1/6,-.5],[1/6,-.5],[.5,-1/6],[.5,1/6]],ft=[[.5,-1/6],[.5,1/6],[1/6,.5],[-1/6,.5]],dt=[[-.5,1/6],[-.5,-1/6],[1/6,.5],[-1/6,.5]],vt=[at.W,at.SW,at.SE,at.E],pt=[at.S,at.SE,at.NE,at.N],mt=[at.NW,at.W,at.E,at.NE],yt=[at.NW,at.SW,at.S,at.N],xt=[[-.5,1/6],[-.5,-1/6],[.5,-1/6],[.5,1/6]],St=[[-1/6,-.5],[1/6,-.5],[1/6,.5],[-1/6,.5]],bt=[at.NW,at.SW,at.SE,at.NE],wt=[at.NW,at.SW,at.SE,at.E,at.N],Mt=[at.W,at.SW,at.SE,at.NE,at.N],Ct=[at.NW,at.W,at.S,at.SE,at.NE],Pt=[at.NW,at.SW,at.S,at.E,at.NE],Tt=[at.NW,at.W,[.5,-1/6],[.5,1/6],at.N],At=[[-1/6,-.5],[1/6,-.5],at.E,at.NE,at.N],kt=[[-.5,1/6],[-.5,-1/6],at.S,at.SE,at.E],Et=[at.W,at.SW,at.S,[1/6,.5],[-1/6,.5]],Ot=[at.NW,at.W,[-1/6,-.5],[1/6,-.5],at.N],Dt=[[-.5,1/6],[-.5,-1/6],at.E,at.NE,at.N],_t=[at.S,at.SE,at.E,[1/6,.5],[-1/6,.5]],zt=[at.W,at.SW,at.S,[.5,-1/6],[.5,1/6]],Nt=[at.W,at.SW,at.SE,at.E,[1/6,.5],[-1/6,.5]],jt=[[-.5,1/6],[-.5,-1/6],at.S,at.SE,at.NE,at.N],Ft=[at.NW,at.W,[-1/6,-.5],[1/6,-.5],at.E,at.NE],Lt=[at.NW,at.SW,at.S,[.5,-1/6],[.5,1/6],at.N],Rt=[at.W,at.SW,at.S,at.E,at.NE,at.N],Bt=[at.NW,at.W,at.S,at.SE,at.E,at.N],It=[[-.5,1/6],[-.5,-1/6],[-1/6,-.5],[1/6,-.5],at.E,at.NE,at.N],Wt=[at.W,at.SW,at.S,[.5,-1/6],[.5,1/6],[1/6,.5],[-1/6,.5]],Ut=[at.NW,at.W,[-1/6,-.5],[1/6,-.5],[.5,-1/6],[.5,1/6],at.N],Gt=[[-.5,1/6],[-.5,-1/6],at.S,at.SE,at.E,[1/6,.5],[-1/6,.5]],Vt=[[-.5,1/6],[-.5,-1/6],[-1/6,-.5],[1/6,-.5],[.5,-1/6],[.5,1/6],[1/6,.5],[-1/6,.5]],Yt={0:[],1:[[at.W,at.S]],2:[[at.S,at.E]],3:[[at.W,at.E]],4:[[at.N,at.E]],5:{0:[[at.W,at.S],[at.N,at.E]],1:[[at.W,at.N],[at.S,at.E]]},6:[[at.N,at.S]],7:[[at.W,at.N]],8:[[at.W,at.N]],9:[[at.N,at.S]],10:{0:[[at.W,at.N],[at.S,at.E]],1:[[at.W,at.S],[at.N,at.E]]},11:[[at.N,at.E]],12:[[at.W,at.E]],13:[[at.S,at.E]],14:[[at.W,at.S]],15:[]};function Xt(e){return parseInt(e,4)}var qt=(tt={},x()(tt,Xt("0000"),[]),x()(tt,Xt("2222"),[]),x()(tt,Xt("2221"),[st]),x()(tt,Xt("2212"),[ut]),x()(tt,Xt("2122"),[lt]),x()(tt,Xt("1222"),[ct]),x()(tt,Xt("0001"),[st]),x()(tt,Xt("0010"),[ut]),x()(tt,Xt("0100"),[lt]),x()(tt,Xt("1000"),[ct]),x()(tt,Xt("2220"),[gt]),x()(tt,Xt("2202"),[ht]),x()(tt,Xt("2022"),[ft]),x()(tt,Xt("0222"),[dt]),x()(tt,Xt("0002"),[gt]),x()(tt,Xt("0020"),[ht]),x()(tt,Xt("0200"),[ft]),x()(tt,Xt("2000"),[dt]),x()(tt,Xt("0011"),[vt]),x()(tt,Xt("0110"),[pt]),x()(tt,Xt("1100"),[mt]),x()(tt,Xt("1001"),[yt]),x()(tt,Xt("2211"),[vt]),x()(tt,Xt("2112"),[pt]),x()(tt,Xt("1122"),[mt]),x()(tt,Xt("1221"),[yt]),x()(tt,Xt("2200"),[xt]),x()(tt,Xt("2002"),[St]),x()(tt,Xt("0022"),[xt]),x()(tt,Xt("0220"),[St]),x()(tt,Xt("1111"),[bt]),x()(tt,Xt("1211"),[wt]),x()(tt,Xt("2111"),[Mt]),x()(tt,Xt("1112"),[Ct]),x()(tt,Xt("1121"),[Pt]),x()(tt,Xt("1011"),[wt]),x()(tt,Xt("0111"),[Mt]),x()(tt,Xt("1110"),[Ct]),x()(tt,Xt("1101"),[Pt]),x()(tt,Xt("1200"),[Tt]),x()(tt,Xt("0120"),[At]),x()(tt,Xt("0012"),[kt]),x()(tt,Xt("2001"),[Et]),x()(tt,Xt("1022"),[Tt]),x()(tt,Xt("2102"),[At]),x()(tt,Xt("2210"),[kt]),x()(tt,Xt("0221"),[Et]),x()(tt,Xt("1002"),[Ot]),x()(tt,Xt("2100"),[Dt]),x()(tt,Xt("0210"),[_t]),x()(tt,Xt("0021"),[zt]),x()(tt,Xt("1220"),[Ot]),x()(tt,Xt("0122"),[Dt]),x()(tt,Xt("2012"),[_t]),x()(tt,Xt("2201"),[zt]),x()(tt,Xt("0211"),[Nt]),x()(tt,Xt("2110"),[jt]),x()(tt,Xt("1102"),[Ft]),x()(tt,Xt("1021"),[Lt]),x()(tt,Xt("2011"),[Nt]),x()(tt,Xt("0112"),[jt]),x()(tt,Xt("1120"),[Ft]),x()(tt,Xt("1201"),[Lt]),x()(tt,Xt("2101"),[Rt]),x()(tt,Xt("0121"),[Rt]),x()(tt,Xt("1012"),[Bt]),x()(tt,Xt("1210"),[Bt]),x()(tt,Xt("0101"),{0:[st,lt],1:[Rt],2:[Rt]}),x()(tt,Xt("1010"),{0:[ct,ut],1:[Bt],2:[Bt]}),x()(tt,Xt("2121"),{0:[Rt],1:[Rt],2:[st,lt]}),x()(tt,Xt("1212"),{0:[Bt],1:[Bt],2:[ct,ut]}),x()(tt,Xt("2120"),{0:[It],1:[It],2:[gt,lt]}),x()(tt,Xt("2021"),{0:[Wt],1:[Wt],2:[st,ft]}),x()(tt,Xt("1202"),{0:[Ut],1:[Ut],2:[ct,ht]}),x()(tt,Xt("0212"),{0:[Gt],1:[Gt],2:[ut,dt]}),x()(tt,Xt("0102"),{0:[gt,lt],1:[It],2:[It]}),x()(tt,Xt("0201"),{0:[st,ft],1:[Wt],2:[Wt]}),x()(tt,Xt("1020"),{0:[ct,ht],1:[Ut],2:[Ut]}),x()(tt,Xt("2010"),{0:[ut,dt],1:[Gt],2:[Gt]}),x()(tt,Xt("2020"),{0:[dt,ht],1:[Vt],2:[gt,ft]}),x()(tt,Xt("0202"),{0:[ft,gt],1:[Vt],2:[dt,ht]}),tt),Ht={ISO_LINES:1,ISO_BANDS:2},Kt={zIndex:0,zOffset:.005};function Zt(e,t){return Array.isArray(t)?e<t[0]?0:e<t[1]?1:2:e>=t?1:0}function Qt(e){var t=e.cellWeights,n=e.x,r=e.y,i=e.width,o=e.height,a=e.threshold;e.thresholdValue&&(v.log.deprecated("thresholdValue","threshold")(),a=e.thresholdValue);var s=n<0,u=n>=i-1,l=r<0,c=r>=o-1,g=s||u||l||c,h={},f={};s||c?f.top=0:(h.top=t[(r+1)*i+n],f.top=Zt(h.top,a)),u||c?f.topRight=0:(h.topRight=t[(r+1)*i+n+1],f.topRight=Zt(h.topRight,a)),u||l?f.right=0:(h.right=t[r*i+n+1],f.right=Zt(h.right,a)),s||l?f.current=0:(h.current=t[r*i+n],f.current=Zt(h.current,a));var d=f.top,p=f.topRight,m=f.right,y=f.current,x=-1;Number.isFinite(a)&&(x=d<<3|p<<2|m<<1|y),Array.isArray(a)&&(x=d<<6|p<<4|m<<2|y);var S=0;return g||(S=Zt((h.top+h.topRight+h.right+h.current)/4,a)),{code:x,meanCode:S}}function Jt(e){var t=e.gridOrigin,n=e.cellSize,r=e.x,i=e.y,o=e.code,a=e.meanCode,s=e.type,u=void 0===s?Ht.ISO_LINES:s,l=Object.assign({},Kt,e.thresholdData),c=u===Ht.ISO_BANDS?qt[o]:Yt[o];Array.isArray(c)||(c=c[a]);var g=l.zIndex*l.zOffset,h=(r+1)*n[0],f=(i+1)*n[1],d=t[0]+h,v=t[1]+f;if(u===Ht.ISO_BANDS){var p=[];return c.forEach((function(e){var t=[];e.forEach((function(e){var r=d+e[0]*n[0],i=v+e[1]*n[1];t.push([r,i,g])})),p.push(t)})),p}var m=[];return c.forEach((function(e){e.forEach((function(e){var t=d+e[0]*n[0],r=v+e[1]*n[1];m.push([t,r,g])}))})),m}function $t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function en(e,t){return!t||"object"!==Je(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function tn(e){return(tn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function nn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function rn(e,t,n){return t&&nn(e.prototype,t),n&&nn(e,n),e}function on(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&$e(e,t)}function an(e,t,n){if(nt.debug&&!function(e,t){if(e.length!==t)return!1;for(var n=0;n<e.length;++n)if(!Number.isFinite(e[n]))return!1;return!0}(e,t))throw new Error("math.gl: ".concat(""|n," some fields set to invalid numbers'"));return e}var sn={};function un(e,t){sn[e]||(sn[e]=!0,console.warn("".concat(e," has been removed in version ").concat(t,", see upgrade guide for more information")))}function ln(e){var t="function"==typeof Map?new Map:void 0;return(ln=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return et(e,arguments,tn(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),$e(r,e)})(e)}var cn=function(e){function t(){return $t(this,t),en(this,tn(t).apply(this,arguments))}return on(t,e),rn(t,[{key:"toString",value:function(){var e="[";if(nt.printRowMajor){e+="row-major:";for(var t=0;t<this.RANK;++t)for(var n=0;n<this.RANK;++n)e+=" ".concat(this[n*this.RANK+t])}else{e+="column-major:";for(var r=0;r<this.ELEMENTS;++r)e+=" ".concat(this[r])}return e+="]"}},{key:"getElementIndex",value:function(e,t){return t*this.RANK+e}},{key:"getElement",value:function(e,t){return this[t*this.RANK+e]}},{key:"setElement",value:function(e,t,n){return this[t*this.RANK+e]=function(e){if(!Number.isFinite(e))throw new Error("Invalid number ".concat(e));return e}(n),this}},{key:"getColumn",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Array(this.RANK).fill(-0),n=e*this.RANK,r=0;r<this.RANK;++r)t[r]=this[n+r];return t}},{key:"setColumn",value:function(e,t){for(var n=e*this.RANK,r=0;r<this.RANK;++r)this[n+r]=t[r];return this}}]),t}(function(e){function t(){return $t(this,t),en(this,tn(t).apply(this,arguments))}return on(t,e),rn(t,[{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"from",value:function(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}},{key:"fromArray",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=0;n<this.ELEMENTS;++n)this[n]=e[n+t];return this.check()}},{key:"to",value:function(e){return e===this?this:it(e)?this.toArray(e):this.toObject(e)}},{key:"toTarget",value:function(e){return e?this.to(e):this}},{key:"toArray",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=0;n<this.ELEMENTS;++n)e[t+n]=this[n];return e}},{key:"toFloat32Array",value:function(){return new Float32Array(this)}},{key:"toString",value:function(){return this.formatString(nt)}},{key:"formatString",value:function(e){for(var t="",n=0;n<this.ELEMENTS;++n)t+=(n>0?", ":"")+rt(this[n],e);return"".concat(e.printTypes?this.constructor.name:"","[").concat(t,"]")}},{key:"equals",value:function(e){if(!e||this.length!==e.length)return!1;for(var t=0;t<this.ELEMENTS;++t)if(!ot(this[t],e[t]))return!1;return!0}},{key:"exactEquals",value:function(e){if(!e||this.length!==e.length)return!1;for(var t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}},{key:"negate",value:function(){for(var e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}},{key:"lerp",value:function(e,t,n){void 0===n&&(n=t,t=e,e=this);for(var r=0;r<this.ELEMENTS;++r){var i=e[r];this[r]=i+n*(t[r]-i)}return this.check()}},{key:"min",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}},{key:"max",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}},{key:"clamp",value:function(e,t){for(var n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],e[n]),t[n]);return this.check()}},{key:"add",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var r=0,i=t;r<i.length;r++)for(var o=i[r],a=0;a<this.ELEMENTS;++a)this[a]+=o[a];return this.check()}},{key:"subtract",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var r=0,i=t;r<i.length;r++)for(var o=i[r],a=0;a<this.ELEMENTS;++a)this[a]-=o[a];return this.check()}},{key:"scale",value:function(e){if(Array.isArray(e))return this.multiply(e);for(var t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}},{key:"sub",value:function(e){return this.subtract(e)}},{key:"setScalar",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}},{key:"addScalar",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}},{key:"subScalar",value:function(e){return this.addScalar(-e)}},{key:"multiplyScalar",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}},{key:"divideScalar",value:function(e){return this.scale(1/e)}},{key:"clampScalar",value:function(e,t){for(var n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],e),t);return this.check()}},{key:"multiplyByScalar",value:function(e){return this.scale(e)}},{key:"check",value:function(){if(nt.debug&&!this.validate(this))throw new Error("math.gl: ".concat(this.constructor.name," some fields set to invalid numbers'"));return this}},{key:"validate",value:function(){for(var e=this.length===this.ELEMENTS,t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}},{key:"elements",get:function(){return this}}]),t}(ln(Array)));var gn=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),hn=Object.freeze([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),fn=Object.freeze({COL0ROW0:0,COL0ROW1:1,COL0ROW2:2,COL0ROW3:3,COL1ROW0:4,COL1ROW1:5,COL1ROW2:6,COL1ROW3:7,COL2ROW0:8,COL2ROW1:9,COL2ROW2:10,COL2ROW3:11,COL3ROW0:12,COL3ROW1:13,COL3ROW2:14,COL3ROW3:15}),dn={},vn=function(e){function t(e){var n;return $t(this,t),n=en(this,tn(t).call(this,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0)),1===arguments.length&&Array.isArray(e)?n.copy(e):n.identity(),n}return on(t,e),rn(t,[{key:"INDICES",get:function(){return fn}},{key:"ELEMENTS",get:function(){return 16}},{key:"RANK",get:function(){return 4}}],[{key:"IDENTITY",get:function(){return dn.IDENTITY=dn.IDENTITY||Object.freeze(new t(gn)),dn.IDENTITY}},{key:"ZERO",get:function(){return dn.ZERO=dn.ZERO||Object.freeze(new t(hn)),dn.ZERO}}]),rn(t,[{key:"copy",value:function(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}},{key:"set",value:function(e,t,n,r,i,o,a,s,u,l,c,g,h,f,d,v){return this[0]=e,this[1]=t,this[2]=n,this[3]=r,this[4]=i,this[5]=o,this[6]=a,this[7]=s,this[8]=u,this[9]=l,this[10]=c,this[11]=g,this[12]=h,this[13]=f,this[14]=d,this[15]=v,this.check()}},{key:"setRowMajor",value:function(e,t,n,r,i,o,a,s,u,l,c,g,h,f,d,v){return this[0]=e,this[1]=i,this[2]=u,this[3]=h,this[4]=t,this[5]=o,this[6]=l,this[7]=f,this[8]=n,this[9]=a,this[10]=c,this[11]=d,this[12]=r,this[13]=s,this[14]=g,this[15]=v,this.check()}},{key:"toRowMajor",value:function(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}},{key:"identity",value:function(){return this.copy(gn)}},{key:"fromQuaternion",value:function(e){return function(e,t){var n=t[0],r=t[1],i=t[2],o=t[3],a=n+n,s=r+r,u=i+i,l=n*a,c=r*a,g=r*s,h=i*a,f=i*s,d=i*u,v=o*a,p=o*s,m=o*u;e[0]=1-g-d,e[1]=c+m,e[2]=h-p,e[3]=0,e[4]=c-m,e[5]=1-l-d,e[6]=f+v,e[7]=0,e[8]=h+p,e[9]=f-v,e[10]=1-l-g,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(this,e),this.check()}},{key:"frustum",value:function(e){var n=e.left,r=e.right,i=e.bottom,o=e.top,a=e.near,s=e.far;return s===1/0?t._computeInfinitePerspectiveOffCenter(this,n,r,i,o,a):function(e,t,n,r,i,o,a){var s=1/(n-t),u=1/(i-r),l=1/(o-a);e[0]=2*o*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*o*u,e[6]=0,e[7]=0,e[8]=(n+t)*s,e[9]=(i+r)*u,e[10]=(a+o)*l,e[11]=-1,e[12]=0,e[13]=0,e[14]=a*o*2*l,e[15]=0}(this,n,r,i,o,a,s),this.check()}},{key:"lookAt",value:function(e,t,n){if(1===arguments.length){var r=e;e=r.eye,t=r.center,n=r.up}return F(this,e,t=t||[0,0,0],n=n||[0,1,0]),this.check()}},{key:"ortho",value:function(e){var t=e.left,n=e.right,r=e.bottom,i=e.top,o=e.near,a=void 0===o?.1:o,s=e.far;return function(e,t,n,r,i,o,a){var s=1/(t-n),u=1/(r-i),l=1/(o-a);e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*u,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*l,e[11]=0,e[12]=(t+n)*s,e[13]=(i+r)*u,e[14]=(a+o)*l,e[15]=1}(this,t,n,r,i,a,void 0===s?500:s),this.check()}},{key:"orthographic",value:function(e){var n=e.fovy,r=void 0===n?45*Math.PI/180:n,i=e.aspect,o=void 0===i?1:i,a=e.focalDistance,s=void 0===a?1:a,u=e.near,l=void 0===u?.1:u,c=e.far,g=void 0===c?500:c;if(r>2*Math.PI)throw Error("radians");var h=r/2,f=s*Math.tan(h),d=f*o;return(new t).ortho({left:-d,right:d,bottom:-f,top:f,near:l,far:g})}},{key:"perspective",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.fovy,n=e.fov,r=void 0===n?45*Math.PI/180:n,i=e.aspect,o=void 0===i?1:i,a=e.near,s=void 0===a?.1:a,u=e.far,l=void 0===u?500:u;if((t=t||r)>2*Math.PI)throw Error("radians");return j(this,t,o,s,l),this.check()}},{key:"determinant",value:function(){return t=(e=this)[0],n=e[1],r=e[2],i=e[3],o=e[4],a=e[5],s=e[6],u=e[7],l=e[8],c=e[9],g=e[10],h=e[11],f=e[12],d=e[13],v=e[14],p=e[15],(t*a-n*o)*(g*p-h*v)-(t*s-r*o)*(c*p-h*d)+(t*u-i*o)*(c*v-g*d)+(n*s-r*a)*(l*p-h*f)-(n*u-i*a)*(l*v-g*f)+(r*u-i*s)*(l*d-c*f);var e,t,n,r,i,o,a,s,u,l,c,g,h,f,d,v,p}},{key:"getScale",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[-0,-0,-0];return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}},{key:"getTranslation",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[-0,-0,-0];return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}},{key:"getRotation",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this.getScale(t||[-0,-0,-0]),r=1/n[0],i=1/n[1],o=1/n[2];return e[0]=this[0]*r,e[1]=this[1]*i,e[2]=this[2]*o,e[3]=0,e[4]=this[4]*r,e[5]=this[5]*i,e[6]=this[6]*o,e[7]=0,e[8]=this[8]*r,e[9]=this[9]*i,e[10]=this[10]*o,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}},{key:"getRotationMatrix3",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this.getScale(t||[-0,-0,-0]),r=1/n[0],i=1/n[1],o=1/n[2];return e[0]=this[0]*r,e[1]=this[1]*i,e[2]=this[2]*o,e[3]=this[4]*r,e[4]=this[5]*i,e[5]=this[6]*o,e[6]=this[8]*r,e[7]=this[9]*i,e[8]=this[10]*o,e}},{key:"transpose",value:function(){return function(e,t){if(e===t){var n=t[1],r=t[2],i=t[3],o=t[6],a=t[7],s=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=n,e[6]=t[9],e[7]=t[13],e[8]=r,e[9]=o,e[11]=t[14],e[12]=i,e[13]=a,e[14]=s}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15]}(this,this),this.check()}},{key:"invert",value:function(){return function(e,t){var n=t[0],r=t[1],i=t[2],o=t[3],a=t[4],s=t[5],u=t[6],l=t[7],c=t[8],g=t[9],h=t[10],f=t[11],d=t[12],v=t[13],p=t[14],m=t[15],y=n*s-r*a,x=n*u-i*a,S=n*l-o*a,b=r*u-i*s,w=r*l-o*s,M=i*l-o*u,C=c*v-g*d,P=c*p-h*d,T=c*m-f*d,A=g*p-h*v,k=g*m-f*v,E=h*m-f*p,O=y*E-x*k+S*A+b*T-w*P+M*C;O&&(O=1/O,e[0]=(s*E-u*k+l*A)*O,e[1]=(i*k-r*E-o*A)*O,e[2]=(v*M-p*w+m*b)*O,e[3]=(h*w-g*M-f*b)*O,e[4]=(u*T-a*E-l*P)*O,e[5]=(n*E-i*T+o*P)*O,e[6]=(p*S-d*M-m*x)*O,e[7]=(c*M-h*S+f*x)*O,e[8]=(a*k-s*T+l*C)*O,e[9]=(r*T-n*k-o*C)*O,e[10]=(d*w-v*S+m*y)*O,e[11]=(g*S-c*w-f*y)*O,e[12]=(s*P-a*A-u*C)*O,e[13]=(n*A-r*P+i*C)*O,e[14]=(v*x-d*b-p*y)*O,e[15]=(c*b-g*x+h*y)*O)}(this,this),this.check()}},{key:"multiplyLeft",value:function(e){return O(this,e,this),this.check()}},{key:"multiplyRight",value:function(e){return O(this,this,e),this.check()}},{key:"rotateX",value:function(e){return z(this,this,e),this.check()}},{key:"rotateY",value:function(e){return function(e,t,n){var r=Math.sin(n),i=Math.cos(n),o=t[0],a=t[1],s=t[2],u=t[3],l=t[8],c=t[9],g=t[10],h=t[11];t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*i-l*r,e[1]=a*i-c*r,e[2]=s*i-g*r,e[3]=u*i-h*r,e[8]=o*r+l*i,e[9]=a*r+c*i,e[10]=s*r+g*i,e[11]=u*r+h*i}(this,this,e),this.check()}},{key:"rotateZ",value:function(e){return N(this,this,e),this.check()}},{key:"rotateXYZ",value:function(e){var t=M(e,3),n=t[0],r=t[1],i=t[2];return this.rotateX(n).rotateY(r).rotateZ(i)}},{key:"rotateAxis",value:function(e,t){return function(e,t,n,r){var i,o,a,s,u,l,c,g,h,f,d,v,p,m,y,x,S,b,w,M,P,T,A,k,E=r[0],O=r[1],D=r[2],_=Math.hypot(E,O,D);_<C||(E*=_=1/_,O*=_,D*=_,i=Math.sin(n),a=1-(o=Math.cos(n)),s=t[0],u=t[1],l=t[2],c=t[3],g=t[4],h=t[5],f=t[6],d=t[7],v=t[8],p=t[9],m=t[10],y=t[11],x=E*E*a+o,S=O*E*a+D*i,b=D*E*a-O*i,w=E*O*a-D*i,M=O*O*a+o,P=D*O*a+E*i,T=E*D*a+O*i,A=O*D*a-E*i,k=D*D*a+o,e[0]=s*x+g*S+v*b,e[1]=u*x+h*S+p*b,e[2]=l*x+f*S+m*b,e[3]=c*x+d*S+y*b,e[4]=s*w+g*M+v*P,e[5]=u*w+h*M+p*P,e[6]=l*w+f*M+m*P,e[7]=c*w+d*M+y*P,e[8]=s*T+g*A+v*k,e[9]=u*T+h*A+p*k,e[10]=l*T+f*A+m*k,e[11]=c*T+d*A+y*k,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]))}(this,this,e,t),this.check()}},{key:"scale",value:function(e){return Array.isArray(e)?_(this,this,e):_(this,this,[e,e,e]),this.check()}},{key:"translate",value:function(e){return D(this,this,e),this.check()}},{key:"transform",value:function(e,t){return 4===e.length?(an(t=T(t||[-0,-0,-0,-0],e,this),4),t):this.transformAsPoint(e,t)}},{key:"transformAsPoint",value:function(e,t){switch(e.length){case 2:t=function(e,t,n){var r=t[0],i=t[1];return e[0]=n[0]*r+n[4]*i+n[12],e[1]=n[1]*r+n[5]*i+n[13],e}(t||[-0,-0],e,this);break;case 3:t=function(e,t,n){var r=t[0],i=t[1],o=t[2],a=n[3]*r+n[7]*i+n[11]*o+n[15];return a=a||1,e[0]=(n[0]*r+n[4]*i+n[8]*o+n[12])/a,e[1]=(n[1]*r+n[5]*i+n[9]*o+n[13])/a,e[2]=(n[2]*r+n[6]*i+n[10]*o+n[14])/a,e}(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return an(t,e.length),t}},{key:"transformAsVector",value:function(e,t){switch(e.length){case 2:t=function(e,t,n){var r=t[0],i=t[1],o=n[3]*r+n[7]*i||1;return e[0]=(n[0]*r+n[4]*i)/o,e[1]=(n[1]*r+n[5]*i)/o,e}(t||[-0,-0],e,this);break;case 3:t=function(e,t,n){var r=t[0],i=t[1],o=t[2],a=n[3]*r+n[7]*i+n[11]*o||1;return e[0]=(n[0]*r+n[4]*i+n[8]*o)/a,e[1]=(n[1]*r+n[5]*i+n[9]*o)/a,e[2]=(n[2]*r+n[6]*i+n[10]*o)/a,e}(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return an(t,e.length),t}},{key:"makeRotationX",value:function(e){return this.identity().rotateX(e)}},{key:"makeTranslation",value:function(e,t,n){return this.identity().translate([e,t,n])}},{key:"transformPoint",value:function(e,t){return un("Matrix4.transformPoint","3.0"),this.transformAsPoint(e,t)}},{key:"transformVector",value:function(e,t){return un("Matrix4.transformVector","3.0"),this.transformAsPoint(e,t)}},{key:"transformDirection",value:function(e,t){return un("Matrix4.transformDirection","3.0"),this.transformAsVector(e,t)}}],[{key:"_computeInfinitePerspectiveOffCenter",value:function(e,t,n,r,i,o){var a=2*o/(n-t),s=2*o/(i-r),u=(n+t)/(n-t),l=(i+r)/(i-r),c=-2*o;return e[0]=a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=0,e[7]=0,e[8]=u,e[9]=l,e[10]=-1,e[11]=-1,e[12]=0,e[13]=0,e[14]=c,e[15]=0,e}}]),t}(cn),pn=v.experimental.count,mn=w.fp64.fp64LowPart,yn=6378e3;function xn(e){return Number.isFinite(e)?e:0}function Sn(e){var t=e.data,n=e.getPosition,r=e.cellSizeMeters,i=e.gpuGridAggregator,o=e.gpuAggregation,a=e.aggregationFlags,s=e.weightParams,u=e.fp64,l=void 0!==u&&u,c=e.coordinateSystem,g=void 0===c?v.COORDINATE_SYSTEM.LNGLAT:c,h=e.viewport,f=void 0===h?null:h,d=e.boundingBox,p=void 0===d?null:d,m={};a.dataChanged&&(p=(m=function(e,t,n){var r,i,o=pn(e),a=new Float64Array(2*o),s=new Float32Array(2*o),u=1/0,l=-1/0,c=1/0,g=-1/0,h={};for(var f in n)h[f]=Object.assign({},n[f],{values:new Float32Array(3*o)});var d=Object(v.createIterable)(e),p=d.iterable,m=d.objectInfo,y=!0,x=!1,S=void 0;try{for(var b,w=p[Symbol.iterator]();!(y=(b=w.next()).done);y=!0){var M=b.value;m.index++;var C=t(M,m),P=m.index;for(var T in i=C[0],r=C[1],a[2*P]=i,a[2*P+1]=r,s[2*P]=mn(i),s[2*P+1]=mn(r),n){var A=n[T].getWeight(M);Array.isArray(A)?(h[T].values[3*P]=A[0],h[T].values[3*P+1]=A[1],h[T].values[3*P+2]=A[2]):h[T].values[3*P]=A}Number.isFinite(r)&&Number.isFinite(i)&&(u=r<u?r:u,l=r>l?r:l,c=i<c?i:c,g=i>g?i:g)}}catch(e){x=!0,S=e}finally{try{y||null==w.return||w.return()}finally{if(x)throw S}}var k={xMin:xn(c),xMax:xn(g),yMin:xn(u),yMax:xn(l)};return{positions:a,positions64xyLow:s,weights:h,boundingBox:k}}(t,n,s)).boundingBox),v.log.assert(r>0);var y=[r,r],x=[0,0];switch(v.log.assert(g===v.COORDINATE_SYSTEM.LNGLAT||g===v.COORDINATE_SYSTEM.IDENTITY),g){case v.COORDINATE_SYSTEM.LNGLAT:case v.COORDINATE_SYSTEM.LNGLAT_DEPRECATED:var S=function(e,t){var n=e.yMin,r=e.yMax;return function(e,t){var n=(a=e,a/yn*(180/Math.PI)),r=(i=t,o=e,o/yn*(180/Math.PI)/Math.cos(i*Math.PI/180));var i,o;var a;return{yOffset:n,xOffset:r}}(t,(n+r)/2)}(p,r);y=[S.xOffset,S.yOffset],x=[-180,-90];break;case v.COORDINATE_SYSTEM.IDENTITY:x=[-f.width/2,-f.height/2];break;default:v.log.assert(!1)}var b=function(e){var t=e.boundingBox,n=e.cellSize,r=e.worldOrigin,i=t.yMin,o=t.yMax,a=t.xMin,s=t.xMax,u=bn(a-r[0],n[0])+r[0],l=bn(i-r[1],n[1])+r[1],c=(new vn).translate([-1*u,-1*l,0]),g=[u,l],h=s-a+n[0],f=o-i+n[1],d=[Math.ceil(h/n[0]),Math.ceil(f/n[1])];return{gridOrigin:g,gridSize:d,width:h,height:f,gridTransformMatrix:c}}({boundingBox:p,cellSize:y,worldOrigin:x});return{weights:i.run({positions:m.positions,positions64xyLow:m.positions64xyLow,weights:m.weights,cellSize:y,width:b.width,height:b.height,gridTransformMatrix:b.gridTransformMatrix,useGPU:o,changeFlags:a,fp64:l}),gridSize:b.gridSize,gridOrigin:b.gridOrigin,cellSize:y,boundingBox:p}}function bn(e,t){var n=e<0?-1:1,r=n<0?Math.abs(e)+t:Math.abs(e);return(r=Math.floor(r/t)*t)*n}var wn=[255,255,255,255],Mn={cellSize:{type:"number",min:1,max:1e3,value:1e3},getPosition:{type:"accessor",value:function(e){return e.position}},getWeight:{type:"accessor",value:function(e){return 1}},contours:[{threshold:1}],fp64:!1,zOffset:.005},Cn=function(e){function t(){return i()(this,t),u()(this,c()(t).apply(this,arguments))}return d()(t,e),a()(t,[{key:"initializeState",value:function(){var e=this.context.gl,t={id:"".concat(this.id,"-gpu-aggregator")};this.state={contourData:{},gridAggregator:new he(e,t),colorTrigger:0,strokeWidthTrigger:0}}},{key:"updateState",value:function(e){var t=e.oldProps,n=e.props,r=e.changeFlags,i=!1,o=!1,a=this._getAggregationFlags({oldProps:t,props:n,changeFlags:r});a&&(i=!0,this.setState({countsData:null}),this._aggregateData(a)),this._shouldRebuildContours({oldProps:t,props:n})&&(o=!0,this._updateThresholdData(n)),i||o?this._generateContours():this._updateSubLayerTriggers(t,n)}},{key:"finalizeState",value:function(){h()(c()(t.prototype),"finalizeState",this).call(this),this.state.gridAggregator.delete()}},{key:"renderLayers",value:function(){var e=this.state.contourData,t=e.contourSegments,n=e.contourPolygons,r=t&&t.length>0,i=n&&n.length>0;return[r&&new v.LineLayer(this._getLineLayerProps()),i&&new v.SolidPolygonLayer(this._getSolidPolygonLayerProps())]}},{key:"_aggregateData",value:function(e){var t=this.props,n=t.data,r=t.cellSize,i=t.getPosition,o=t.getWeight,a=t.gpuAggregation,s=t.fp64,u=t.coordinateSystem,l=Sn({data:n,cellSizeMeters:r,getPosition:i,weightParams:{count:{getWeight:o}},gpuAggregation:a,gpuGridAggregator:this.state.gridAggregator,fp64:s,coordinateSystem:u,viewport:this.context.viewport,boundingBox:this.state.boundingBox,aggregationFlags:e}),c=l.weights,g=l.gridSize,h=l.gridOrigin,f=l.cellSize,d=l.boundingBox;this.setState({countsData:c.count.aggregationData,countsBuffer:c.count.aggregationBuffer,gridSize:g,gridOrigin:h,cellSize:f,boundingBox:d})}},{key:"_generateContours",value:function(){var e=this.state,t=e.gridSize,n=e.gridOrigin,r=e.cellSize,i=e.thresholdData,o=this.state.countsData;o||(o=this.state.countsBuffer.getData(),this.setState({countsData:o}));var a=function(e){var t=e.thresholdData,n=(e.colors,e.cellWeights),r=e.gridSize,i=e.gridOrigin,o=e.cellSize,a=[],s=[],u=r[0],l=r[1];return t.forEach((function(e,t){for(var r=e.threshold,c=-1;c<u;c++)for(var g=-1;g<l;g++){var h=Qt({cellWeights:n,threshold:r,x:c,y:g,width:u,height:l}),f=h.code,d=h.meanCode,v={gridOrigin:i,cellSize:o,x:c,y:g,width:u,height:l,code:f,meanCode:d,thresholdData:e};if(Array.isArray(r)){v.type=Ht.ISO_BANDS,Jt(v).forEach((function(e){s.push({vertices:e,threshold:r})}))}else{v.type=Ht.ISO_LINES;for(var p=Jt(v),m=0;m<p.length;m+=2)a.push({start:p[m],end:p[m+1],threshold:r})}}})),{contourSegments:a,contourPolygons:s}}({thresholdData:i,cellWeights:he.getCellData({countsData:o}).cellWeights,gridSize:t,gridOrigin:n,cellSize:r});this.setState({contourData:a})}},{key:"_getAggregationFlags",value:function(e){var t=e.oldProps,n=e.props,r=e.changeFlags,i=null;return(r.dataChanged||t.gpuAggregation!==n.gpuAggregation||r.updateTriggersChanged&&(r.updateTriggersChanged.all||r.updateTriggersChanged.getPosition))&&(i=Object.assign({},i,{dataChanged:!0})),t.cellSize!==n.cellSize&&(i=Object.assign({},i,{cellSizeChanged:!0})),i}},{key:"_getLineLayerProps",value:function(){var e=this.state,t=e.colorTrigger,n=e.strokeWidthTrigger;return this.getSubLayerProps({id:"contour-line-layer",data:this.state.contourData.contourSegments,getSourcePosition:function(e){return e.start},getTargetPosition:function(e){return e.end},getColor:this._onGetSublayerColor.bind(this),getWidth:this._onGetSublayerStrokeWidth.bind(this),widthUnits:"pixels",updateTriggers:{getColor:t,getWidth:n}})}},{key:"_getSolidPolygonLayerProps",value:function(){var e=this.state.colorTrigger;return this.getSubLayerProps({id:"contour-solid-polygon-layer",data:this.state.contourData.contourPolygons,getPolygon:function(e){return e.vertices},getFillColor:this._onGetSublayerColor.bind(this),updateTriggers:{getFillColor:e}})}},{key:"_onGetSublayerColor",value:function(e){var t=this.props.contours,n=wn;return t.forEach((function(t){ot(t.threshold,e.threshold)&&(n=t.color||wn)})),n}},{key:"_onGetSublayerStrokeWidth",value:function(e){var t=this.props.contours,n=1;return t.some((function(t){return t.threshold===e.threshold&&(n=t.strokeWidth||1,!0)})),n}},{key:"_shouldRebuildContours",value:function(e){var t=e.oldProps,n=e.props;if(!t.contours||!t.zOffset||t.contours.length!==n.contours.length||t.zOffset!==n.zOffset)return!0;var r=t.contours.map((function(e){return e.threshold})),i=n.contours.map((function(e){return e.threshold}));return i.some((function(e,t){return!ot(i[t],r[t])}))}},{key:"_updateSubLayerTriggers",value:function(e,t){e&&e.contours&&t&&t.contours&&(t.contours.some((function(t,n){return t.color!==e.contours[n].color}))&&this.state.colorTrigger++,t.contours.some((function(t,n){return t.strokeWidth!==e.contours[n].strokeWidth}))&&this.state.strokeWidthTrigger++)}},{key:"_updateThresholdData",value:function(e){var t=e.contours.map((function(t,n){return{threshold:t.threshold,zIndex:t.zIndex||n,zOffset:e.zOffset}}));this.setState({thresholdData:t})}}]),t}(v.CompositeLayer);Cn.layerName="ContourLayer",Cn.defaultProps=Mn;var Pn=new w.PhongMaterial,Tn={colorDomain:null,colorRange:p,elevationDomain:null,elevationRange:[0,1e3],elevationScale:{type:"number",min:0,value:1},gridSize:{type:"array",min:0,value:[1,1]},gridOrigin:{type:"array",min:0,value:[0,0]},gridOffset:{type:"array",min:0,value:[0,0]},cellSize:{type:"number",min:0,max:1e3,value:1e3},offset:{type:"array",min:0,value:[1,1]},coverage:{type:"number",min:0,max:1,value:1},extruded:!0,material:Pn},An=function(e){function t(){return i()(this,t),u()(this,c()(t).apply(this,arguments))}return d()(t,e),a()(t,[{key:"getShaders",value:function(){return h()(c()(t.prototype),"getShaders",this).call(this,{vs:"#version 300 es\n#define SHADER_NAME gpu-grid-cell-layer-vertex-shader\n#define RANGE_COUNT 6\n\nin vec3 positions;\nin vec3 normals;\n\nin vec4 colors;\nin vec4 elevations;\nin vec3 instancePickingColors;\nuniform vec2 offset;\nuniform bool extruded;\nuniform float cellSize;\nuniform float coverage;\nuniform float opacity;\nuniform float elevationScale;\n\nuniform ivec2 gridSize;\nuniform vec2 gridOrigin;\nuniform vec2 gridOriginLow;\nuniform vec2 gridOffset;\nuniform vec2 gridOffsetLow;\nuniform vec4 colorRange[RANGE_COUNT];\nuniform vec2 elevationRange;\nuniform vec2 colorDomain;\nuniform bool colorDomainValid;\nuniform vec2 elevationDomain;\nuniform bool elevationDomainValid;\n\nlayout(std140) uniform;\nuniform ColorData\n{\n  vec4 maxMinCount;\n} colorData;\nuniform ElevationData\n{\n  vec4 maxMinCount;\n} elevationData;\n\n#define EPSILON 0.00001\nout vec4 vColor;\n\nvec4 quantizeScale(vec2 domain, vec4 range[RANGE_COUNT], float value) {\n  vec4 outColor = vec4(0., 0., 0., 0.);\n  if (value >= (domain.x - EPSILON) && value <= (domain.y + EPSILON)) {\n    float domainRange = domain.y - domain.x;\n    if (domainRange <= 0.) {\n      outColor = colorRange[0];\n    } else {\n      float rangeCount = float(RANGE_COUNT);\n      float rangeStep = domainRange / rangeCount;\n      float idx = floor((value - domain.x) / rangeStep);\n      idx = clamp(idx, 0., rangeCount - 1.);\n      int intIdx = int(idx);\n      outColor = colorRange[intIdx];\n    }\n  }\n  return outColor;\n}\n\nfloat linearScale(vec2 domain, vec2 range, float value) {\n  if (value >= (domain.x - EPSILON) && value <= (domain.y + EPSILON)) {\n    return ((value - domain.x) / (domain.y - domain.x)) * (range.y - range.x) + range.x;\n  }\n  return -1.;\n}\n\nvoid main(void) {\n\n  vec2 clrDomain = colorDomainValid ? colorDomain : vec2(colorData.maxMinCount.a, colorData.maxMinCount.r);\n  vec4 color = quantizeScale(clrDomain, colorRange, colors.r);\n\n  float elevation = 0.0;\n\n  if (extruded) {\n    vec2 elvDomain = elevationDomainValid ? elevationDomain : vec2(elevationData.maxMinCount.a, elevationData.maxMinCount.r);\n    elevation = linearScale(elvDomain, elevationRange, elevations.r);\n    elevation = elevation  * (positions.z + 1.0) / 2.0 * elevationScale;\n  }\n  float shouldRender = float(color.r > 0.0 && elevations.r >= 0.0);\n  float dotRadius = cellSize / 2. * coverage * shouldRender;\n\n  int yIndex = (gl_InstanceID / gridSize[0]);\n  int xIndex = gl_InstanceID - (yIndex * gridSize[0]);\n\n  vec2 instancePositionXFP64 = mul_fp64(vec2(gridOffset[0], gridOffsetLow[0]), vec2(float(xIndex), 0.));\n  instancePositionXFP64 = sum_fp64(instancePositionXFP64, vec2(gridOrigin[0], gridOriginLow[0]));\n  vec2 instancePositionYFP64 = mul_fp64(vec2(gridOffset[1], gridOffsetLow[1]), vec2(float(yIndex), 0.));\n  instancePositionYFP64 = sum_fp64(instancePositionYFP64, vec2(gridOrigin[1], gridOriginLow[1]));\n\n  vec3 centroidPosition = vec3(instancePositionXFP64[0], instancePositionYFP64[0], elevation);\n  vec2 centroidPosition64xyLow = vec2(instancePositionXFP64[1], instancePositionYFP64[1]);\n  vec3 pos = vec3(project_size(positions.xy + offset) * dotRadius, 0.);\n  picking_setPickingColor(instancePickingColors);\n\n  vec4 position_commonspace;\n  gl_Position = project_position_to_clipspace(centroidPosition, centroidPosition64xyLow, pos, position_commonspace);\n\n  vec3 normals_commonspace = project_normal(normals);\n\n   if (extruded) {\n    vec3 lightColor = lighting_getLightColor(color.rgb, project_uCameraPosition, position_commonspace.xyz, normals_commonspace);\n    vColor = vec4(lightColor, color.a * opacity) / 255.;\n  } else {\n    vColor = vec4(color.rgb, color.a * opacity) / 255.;\n  }\n}\n",fs:"#version 300 es\n#define SHADER_NAME gpu-grid-cell-layer-fragment-shader\n\nprecision highp float;\n\nin vec4 vColor;\n\nout vec4 fragColor;\n\nvoid main(void) {\n  fragColor = vColor;\n  fragColor = picking_filterColor(fragColor);\n}\n",modules:["project32","gouraud-lighting","picking",w.fp64]})}},{key:"initializeState",value:function(){var e=this.context.gl;this.getAttributeManager().addInstanced({colors:{size:4,update:this.calculateColors,noAlloc:!0},elevations:{size:4,update:this.calculateElevations,noAlloc:!0}});var t=this._getModel(e);this._setupUniformBuffer(t),this.setState({model:t})}},{key:"_getModel",value:function(e){return new w.Model(e,Object.assign({},this.getShaders(),{id:this.props.id,geometry:new w.CubeGeometry,isInstanced:!0}))}},{key:"draw",value:function(e){var t=e.uniforms,n=this.props,r=n.data,i=n.cellSize,o=n.offset,a=n.extruded,s=n.elevationScale,u=n.coverage,l=n.gridSize,c=n.gridOrigin,g=n.gridOffset,h=n.elevationRange,f=[Object(v.fp64LowPart)(c[0]),Object(v.fp64LowPart)(c[1])],d=[Object(v.fp64LowPart)(g[0]),Object(v.fp64LowPart)(g[1])],p=this.getDomainUniforms(),y={colorMaxMinBuffer:r.color.maxMinBuffer,elevationMaxMinBuffer:r.elevation.maxMinBuffer},x=m(this.props.colorRange);this.bindUniformBuffers(y),this.state.model.setUniforms(Object.assign({},t,p,{cellSize:i,offset:o,extruded:a,elevationScale:s,coverage:u,gridSize:l,gridOrigin:c,gridOriginLow:f,gridOffset:g,gridOffsetLow:d,colorRange:x,elevationRange:h})).draw(),this.unbindUniformBuffers(y)}},{key:"bindUniformBuffers",value:function(e){var t=e.colorMaxMinBuffer,n=e.elevationMaxMinBuffer;t.bind({target:35345,index:0}),n.bind({target:35345,index:1})}},{key:"unbindUniformBuffers",value:function(e){var t=e.colorMaxMinBuffer,n=e.elevationMaxMinBuffer;t.unbind({target:35345,index:0}),n.unbind({target:35345,index:1})}},{key:"calculateColors",value:function(e){var t=this.props.data;e.update({buffer:t.color.aggregationBuffer})}},{key:"calculateElevations",value:function(e){var t=this.props.data;e.update({buffer:t.elevation.aggregationBuffer})}},{key:"getDomainUniforms",value:function(){var e=this.props,t=e.colorDomain,n=e.elevationDomain,r={};return null!==t?(r.colorDomainValid=!0,r.colorDomain=t):r.colorDomainValid=!1,null!==n?(r.elevationDomainValid=!0,r.elevationDomain=n):r.elevationDomainValid=!1,r}},{key:"_setupUniformBuffer",value:function(e){var t=this.context.gl,n=e.program.handle,r=t.getUniformBlockIndex(n,"ColorData"),i=t.getUniformBlockIndex(n,"ElevationData");t.uniformBlockBinding(n,r,0),t.uniformBlockBinding(n,i,1)}}]),t}(v.Layer);An.layerName="GPUGridCellLayer",An.defaultProps=Tn;var kn={colorDomain:null,colorRange:p,getColorWeight:{type:"accessor",value:function(e){return 1}},colorAggregation:"SUM",elevationDomain:null,elevationRange:[0,1e3],getElevationWeight:{type:"accessor",value:function(e){return 1}},elevationAggregation:"SUM",elevationScale:{type:"number",min:0,value:1},cellSize:{type:"number",min:1,max:1e3,value:1e3},coverage:{type:"number",min:0,max:1,value:1},getPosition:{type:"accessor",value:function(e){return e.position}},extruded:!1,fp64:!1,material:new w.PhongMaterial,gpuAggregation:!0},En=function(e){function t(){return i()(this,t),u()(this,c()(t).apply(this,arguments))}return d()(t,e),a()(t,[{key:"initializeState",value:function(){var e=this.context.gl,t=he.isSupported(e);t||v.log.error("GPUGridLayer is not supported on this browser, use GridLayer instead")();var n={id:"".concat(this.id,"-gpu-aggregator")};this.state={gpuGridAggregator:new he(e,n),isSupported:t}}},{key:"updateState",value:function(e){var t=this.getAggregationFlags(e);t&&(this.getLayerData(t),this.setState({gridHash:null}))}},{key:"finalizeState",value:function(){h()(c()(t.prototype),"finalizeState",this).call(this),this.state.gpuGridAggregator.delete()}},{key:"getAggregationFlags",value:function(e){var t=e.oldProps,n=e.props,r=e.changeFlags,i=null;return!!this.state.isSupported&&(this.isDataChanged({oldProps:t,props:n,changeFlags:r})&&(i=Object.assign({},i,{dataChanged:!0})),t.cellSize!==n.cellSize&&(i=Object.assign({},i,{cellSizeChanged:!0})),i)}},{key:"isDataChanged",value:function(e){var t=e.oldProps,n=e.props,r=e.changeFlags;return!!r.dataChanged||(t.gpuAggregation!==n.gpuAggregation||(t.colorAggregation!==n.colorAggregation||t.elevationAggregation!==n.elevationAggregation||!(!r.updateTriggersChanged||!(r.updateTriggersChanged.all||r.updateTriggersChanged.getPosition||r.updateTriggersChanged.getColorWeight||r.updateTriggersChanged.getElevationWeight))))}},{key:"getHashKeyForIndex",value:function(e){var t=this.state,n=t.gridSize,r=t.gridOrigin,i=t.cellSize,o=Math.floor(e/n[0]),a=e-o*n[0],s=Math.floor((o*i[1]+r[1]+90+i[1]/2)/i[1]),u=Math.floor((a*i[0]+r[0]+180+i[0]/2)/i[0]);return"".concat(s,"-").concat(u)}},{key:"getPositionForIndex",value:function(e){var t=this.state,n=t.gridSize,r=t.gridOrigin,i=t.cellSize,o=Math.floor(e/n[0]),a=e-o*n[0],s=o*i[1]+r[1];return[a*i[0]+r[0],s]}},{key:"getPickingInfo",value:function(e){var t=e.info,n=e.mode,r=t.index,i=null;if(r>=0){var o=this.state.gpuGridAggregator,a=this.getPositionForIndex(r),s=he.getAggregationData(Object.assign({pixelIndex:r},o.getData("color"))),u=he.getAggregationData(Object.assign({pixelIndex:r},o.getData("elevation")));if(i={colorValue:s.cellWeight,elevationValue:u.cellWeight,count:s.cellCount||u.cellCount,position:a,totalCount:s.totalCount||u.totalCount},"hover"!==n){var l=this.props,c=l.data,g=(l.getPosition,this.state.gridHash);if(!g)g=Se(c,this.props.cellSize).gridHash,this.setState({gridHash:g});var h=g[this.getHashKeyForIndex(r)];Object.assign(i,h)}}return Object.assign(t,{picked:Boolean(i),object:i})}},{key:"getLayerData",value:function(e){var t=this.props,n=t.data,r=t.cellSize,i=t.getPosition,o=t.gpuAggregation,a=t.getColorWeight,s=t.colorAggregation,u=t.getElevationWeight,l=t.elevationAggregation,c=t.fp64,g=Sn({data:n,cellSizeMeters:r,getPosition:i,weightParams:{color:{getWeight:a,operation:W[s]||W[kn.colorAggregation],needMin:!0,needMax:!0,combineMaxMin:!0},elevation:{getWeight:u,operation:W[l]||W[kn.elevationAggregation],needMin:!0,needMax:!0,combineMaxMin:!0}},gpuAggregation:o,gpuGridAggregator:this.state.gpuGridAggregator,boundingBox:this.state.boundingBox,aggregationFlags:e,fp64:c}),h=g.weights,f=g.gridSize,d=g.gridOrigin,v=g.cellSize,p=g.boundingBox;this.setState({weights:h,gridSize:f,gridOrigin:d,cellSize:v,boundingBox:p})}},{key:"renderLayers",value:function(){if(!this.state.isSupported)return null;var e=this.props,t=e.elevationScale,n=e.extruded,r=e.cellSize,i=e.coverage,o=e.material,a=e.elevationRange,s=e.colorDomain,u=e.elevationDomain,l=this.state,c=l.weights,g=l.gridSize,h=l.gridOrigin,f=l.cellSize,d=m(this.props.colorRange);return new(this.getSubLayerClass("gpu-grid-cell",An))({gridSize:g,gridOrigin:h,gridOffset:f,colorRange:d,elevationRange:a,colorDomain:s,elevationDomain:u,cellSize:r,coverage:i,material:o,elevationScale:t,extruded:n},this.getSubLayerProps({id:"gpu-grid-cell"}),{data:c,numInstances:g[0]*g[1]})}}]),t}(v.CompositeLayer);En.layerName="GPUGridLayer",En.defaultProps=kn;var On=Object.assign({},En.defaultProps,Ue.defaultProps,{gpuAggregation:!1}),Dn=function(e){function t(){return i()(this,t),u()(this,c()(t).apply(this,arguments))}return d()(t,e),a()(t,[{key:"initializeState",value:function(){this.state={useGPUAggregation:!0}}},{key:"updateState",value:function(e){e.oldProps;var t=e.props,n=(e.changeFlags,{});n.useGPUAggregation=this.canUseGPUAggregation(t),this.setState(n)}},{key:"renderLayers",value:function(){var e=this.props,t=e.data,n=e.updateTriggers,r=this.state.useGPUAggregation?"GPU":"CPU";return new(this.state.useGPUAggregation?this.getSubLayerClass("GPU",En):this.getSubLayerClass("CPU",Ue))(this.props,this.getSubLayerProps({id:r,updateTriggers:n}),{data:t})}},{key:"canUseGPUAggregation",value:function(e){var t=e.gpuAggregation,n=e.lowerPercentile,r=e.upperPercentile,i=e.getColorValue,o=e.getElevationValue;return!!t&&(!!he.isSupported(this.context.gl)&&(0===n&&100===r&&(null===i&&null===o)))}}]),t}(v.CompositeLayer);function _n(e){var t=e.map((function(e){return e[0]})),n=e.map((function(e){return e[1]})),r=Math.min.apply(null,t),i=Math.max.apply(null,t);return[r,Math.min.apply(null,n),i,Math.max.apply(null,n)]}function zn(e,t){return t[0]>=e[0]&&t[2]<=e[2]&&t[1]>=e[1]&&t[3]<=e[3]}Dn.layerName="GridLayer",Dn.defaultProps=On;var Nn=new Float32Array(12);function jn(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,n=0,r=!0,i=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done);r=!0)for(var u=a.value,l=0;l<t;l++)Nn[n++]=u[l]||0}catch(e){i=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(i)throw o}}return Nn}function Fn(e,t,n){var r=b()(e,4),i=r[0],o=r[1],a=r[2],s=r[3],u=a-i,l=s-o,c=u,g=l;u/l<t/n?c=t/n*l:g=n/t*u,c<t&&(c=t,g=n);var h=(a+i)/2,f=(s+o)/2;return[h-c/2,f-g/2,h+c/2,f+g/2]}function Ln(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}var Rn=function(e){function t(){return i()(this,t),u()(this,c()(t).apply(this,arguments))}return d()(t,e),a()(t,[{key:"getShaders",value:function(){return{vs:"#define SHADER_NAME heatp-map-layer-vertex-shader\n\nuniform sampler2D maxTexture;\nuniform float intensity;\nuniform vec2 colorDomain;\nuniform float threshold;\n\nattribute vec3 positions;\nattribute vec2 texCoords;\n\nvarying vec2 vTexCoords;\nvarying float vIntensityMin;\nvarying float vIntensityMax;\n\nvoid main(void) {\n  gl_Position = project_position_to_clipspace(positions, vec2(0.0), vec3(0.0));\n  vTexCoords = texCoords;\n  float maxValue = texture2D(maxTexture, vec2(0.5)).r;\n  float minValue = maxValue * threshold;\n  if (colorDomain[1] > 0.) {\n    maxValue = colorDomain[1];\n    minValue = colorDomain[0];\n  }\n  vIntensityMax = intensity / maxValue;\n  vIntensityMin = intensity / minValue;\n}\n",fs:"#define SHADER_NAME triangle-layer-fragment-shader\n\nprecision highp float;\n\nuniform float opacity;\nuniform sampler2D texture;\nvarying vec2 vTexCoords;\nuniform sampler2D colorTexture;\n\nvarying float vIntensityMin;\nvarying float vIntensityMax;\n\nvec4 getLinearColor(float value) {\n  float factor = clamp(value * vIntensityMax, 0., 1.);\n  vec4 color = texture2D(colorTexture, vec2(factor, 0.5));\n  color.a *= min(value * vIntensityMin, 1.0);\n  return color;\n}\n\nvoid main(void) {\n  float weight = texture2D(texture, vTexCoords).r;\n  if (weight <= 0.) {\n     discard;\n  }\n\n  vec4 linearColor = getLinearColor(weight);\n  linearColor.a *= opacity;\n  gl_FragColor =linearColor;\n}\n",modules:["project32"]}}},{key:"initializeState",value:function(){var e=this.context.gl;this.getAttributeManager().add({positions:{size:3,noAlloc:!0},texCoords:{size:2,noAlloc:!0}}),this.setState({model:this._getModel(e)})}},{key:"_getModel",value:function(e){var t=this.props.vertexCount;return new w.Model(e,Object.assign({},this.getShaders(),{id:this.props.id,geometry:new w.Geometry({drawMode:6,vertexCount:t})}))}},{key:"draw",value:function(e){var t=e.uniforms,n=this.state.model,r=this.props,i=r.texture,o=r.maxTexture,a=r.colorTexture,s=r.intensity,u=r.threshold,l=r.colorDomain;n.setUniforms(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ln(n,!0).forEach((function(t){x()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ln(n).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},t,{texture:i,maxTexture:o,colorTexture:a,intensity:s,threshold:u,colorDomain:l})).draw()}}]),t}(v.Layer);Rn.layerName="TriangleLayer",Rn.defaultProps={count:0,texture:null};var Bn;function In(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Wn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?In(n,!0).forEach((function(t){x()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):In(n).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Un={mipmaps:!1,parameters:(Bn={},x()(Bn,10240,9729),x()(Bn,10241,9729),x()(Bn,10242,33071),x()(Bn,10243,33071),Bn),dataFormat:6408},Gn=[0,0],Vn={getPosition:{type:"accessor",value:function(e){return e.position}},getWeight:{type:"accessor",value:1},intensity:{type:"number",min:0,value:1},radiusPixels:{type:"number",min:1,max:100,value:30},colorRange:p,threshold:{type:"number",min:0,max:1,value:.05},colorDomain:{type:"array",value:null,optional:!0}},Yn=[w.FEATURES.BLEND_EQUATION_MINMAX,w.FEATURES.TEXTURE_FLOAT],Xn=function(e){function t(){return i()(this,t),u()(this,c()(t).apply(this,arguments))}return d()(t,e),a()(t,[{key:"initializeState",value:function(){var e=this.context.gl;if(!Object(w.hasFeatures)(e,Yn))return this.setState({supported:!1}),void v.log.error("HeatmapLayer: ".concat(this.id," is not supported on this browser"))();this.setState({supported:!0}),this._setupTextureParams(),this._setupAttributes(),this._setupResources()}},{key:"shouldUpdateState",value:function(e){return e.changeFlags.somethingChanged}},{key:"updateState",value:function(e){if(this.state.supported){h()(c()(t.prototype),"updateState",this).call(this,e);var n=e.props,r=e.oldProps,i=this._getChangeFlags(e);if(i.viewportChanged&&(i.boundsChanged=this._updateBounds()),i.dataChanged||i.boundsChanged||i.uniformsChanged?this._updateWeightmap():i.viewportZoomChanged&&this._debouncedUpdateWeightmap(),n.colorRange!==r.colorRange&&this._updateColorTexture(e),i.viewportChanged&&this._updateTextureRenderingBounds(),r.colorDomain!==n.colorDomain||i.viewportChanged){var o=this.context.viewport,a=this.state.weightsScale,s=(o?1024/o.scale:1)*a,u=n.colorDomain?n.colorDomain.map((function(e){return e*s})):Gn;if(u[1]>0&&a<1){var l=Math.min(u[1],1);u[0]*=l/u[1],u[1]=l}this.setState({colorDomain:u})}this.setState({zoom:e.context.viewport.zoom})}}},{key:"renderLayers",value:function(){if(!this.state.supported)return[];var e=this.state,t=e.weightsTexture,n=e.triPositionBuffer,r=e.triTexCoordBuffer,i=e.maxWeightsTexture,o=e.colorTexture,a=e.colorDomain,s=this.props,u=s.updateTriggers,l=s.intensity,c=s.threshold;return new Rn(this.getSubLayerProps({id:"triangle-layer",updateTriggers:u}),{data:{attributes:{positions:n,texCoords:r}},vertexCount:4,maxTexture:i,colorTexture:o,texture:t,intensity:l,threshold:c,colorDomain:a})}},{key:"finalizeState",value:function(){h()(c()(t.prototype),"finalizeState",this).call(this);var e=this.state,n=e.weightsTransform,r=e.weightsTexture,i=e.maxWeightTransform,o=e.maxWeightsTexture,a=e.triPositionBuffer,s=e.triTexCoordBuffer,u=e.colorTexture;n&&n.delete(),r&&r.delete(),i&&i.delete(),o&&o.delete(),a&&a.delete(),s&&s.delete(),u&&u.delete()}},{key:"_getAttributeManager",value:function(){return new v.AttributeManager(this.context.gl,{id:this.props.id,stats:this.context.stats})}},{key:"_getChangeFlags",value:function(e){var t=e.oldProps,n=e.props,r={};this._isDataChanged(e)&&(r.dataChanged=!0),t.radiusPixels!==n.radiusPixels&&(r.uniformsChanged=!0),r.viewportChanged=e.changeFlags.viewportChanged;var i=this.state.zoom;return e.context.viewport&&e.context.viewport.zoom===i||(r.viewportZoomChanged=!0),r}},{key:"_getTextures",value:function(){var e=this.context.gl,t=this.state,n=t.textureSize,r=t.format,i=t.type;return{weightsTexture:new w.Texture2D(e,Wn({width:n,height:n,format:r,type:i},Un)),maxWeightsTexture:new w.Texture2D(e,Wn({format:r,type:i},Un))}}},{key:"_isDataChanged",value:function(e){var t=e.changeFlags;return!!t.dataChanged||!(!t.updateTriggersChanged||!(t.updateTriggersChanged.all||t.updateTriggersChanged.getPosition||t.updateTriggersChanged.getWeight))}},{key:"_setupAttributes",value:function(){this.getAttributeManager().add({positions:{size:3,accessor:"getPosition"},weights:{size:1,accessor:"getWeight"}})}},{key:"_setupTextureParams",value:function(){var e=this.context.gl,t=Math.min(2048,Object(w.getParameter)(e,3379)),n=Object(w.hasFeatures)(e,w.FEATURES.COLOR_ATTACHMENT_RGBA32F),r=function(e){var t=e.gl,n=e.floatTargetSupport;return{format:Object(w.isWebGL2)(t)?34836:6408,type:n?5126:5121}}({gl:e,floatTargetSupport:n}),i=r.format,o=r.type,a=n?1:1/255;this.setState({textureSize:t,format:i,type:o,weightsScale:a}),n||v.log.warn("HeatmapLayer: ".concat(this.id," rendering to float texture not supported, fallingback to low precession format"))()}},{key:"_setupResources",value:function(){var e=this.context.gl,t=this.state.textureSize,n=this._getTextures(),r=n.weightsTexture,i=n.maxWeightsTexture,o=new w.Transform(e,{id:"".concat(this.id,"-weights-transform"),vs:"attribute vec3 positions;\nattribute float weights;\nvarying vec4 weightsTexture;\nuniform float radiusPixels;\nuniform float textureWidth;\nuniform vec4 commonBounds;\nuniform float weightsScale;\nvoid main()\n{\n  weightsTexture = vec4(weights * weightsScale, 0., 0., 1.);\n\n  float radiusTexels  = radiusPixels * textureWidth / (commonBounds.z - commonBounds.x);\n  gl_PointSize = radiusTexels * 2.;\n\n  vec3 commonPosition = project_position(positions, vec2(0));\n  gl_Position.xy = (commonPosition.xy - commonBounds.xy) / (commonBounds.zw - commonBounds.xy) ;\n  gl_Position.xy = (gl_Position.xy * 2.) - (1.);\n}\n",_fs:"varying vec4 weightsTexture;\nfloat gaussianKDE(float u){\n  return pow(2.71828, -u*u/0.05555)/(1.77245385*0.166666);\n}\nvoid main()\n{\n  float dist = length(gl_PointCoord - vec2(0.5, 0.5));\n  if (dist > 0.5) {\n    discard;\n  }\n  gl_FragColor.rgb = weightsTexture.rgb * gaussianKDE(2. * dist);\n  gl_FragColor.a = 1.0;\n}\n",modules:["project32"],elementCount:1,_targetTexture:r,_targetTextureVarying:"weightsTexture"}),a=new w.Transform(e,{id:"".concat(this.id,"-max-weights-transform"),_sourceTextures:{inTexture:r},_targetTexture:i,_targetTextureVarying:"outTexture",vs:"attribute vec4 inTexture;\nvarying vec4 outTexture;\n\nvoid main()\n{\noutTexture = inTexture;\ngl_Position = vec4(0, 0, 0, 1.);\ngl_PointSize = 1.0;\n}\n",elementCount:t*t});this.setState({weightsTexture:r,maxWeightsTexture:i,weightsTransform:o,model:o.model,maxWeightTransform:a,zoom:null,triPositionBuffer:new w.Buffer(e,{byteLength:48,accessor:{size:3}}),triTexCoordBuffer:new w.Buffer(e,{byteLength:48,accessor:{size:2}})})}},{key:"_updateMaxWeightValue",value:function(){this.state.maxWeightTransform.run({parameters:{blend:!0,depthTest:!1,blendFunc:[1,1],blendEquation:32776}})}},{key:"_updateBounds",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.state.textureSize,n=this.context.viewport,r=[n.unproject([0,0]),n.unproject([n.width,0]),n.unproject([n.width,n.height]),n.unproject([0,n.height])],i=_n(r),o=this._worldToCommonBounds(i),a={visibleWorldBounds:i,viewportCorners:r},s=!1;if(e||!this.state.worldBounds||!zn(this.state.worldBounds,i)){var u=Fn(o,2*t,2*t),l=this._commonToWorldBounds(u);this.props.coordinateSystem===v.COORDINATE_SYSTEM.LNGLAT&&(l[1]=Math.max(l[1],-85.051129),l[3]=Math.min(l[3],85.051129),l[0]=Math.max(l[0],-360),l[2]=Math.min(l[2],360));var c=this._worldToCommonBounds(l,{scaleToAspect:!0,normalize:!0,width:2*t,height:2*t});a.worldBounds=l,a.normalizedCommonBounds=c,s=!0}return this.setState(a),s}},{key:"_updateTextureRenderingBounds",value:function(){var e=this.state,t=e.triPositionBuffer,n=e.triTexCoordBuffer,r=e.normalizedCommonBounds,i=e.viewportCorners,o=this.context.viewport,a=r.map((function(e){return e*o.scale}));t.subData(jn(i,3));var s=i.map((function(e){return t=o.projectPosition(e),n=a,r=b()(n,4),i=r[0],s=r[1],u=r[2],l=r[3],[(t[0]-i)/(u-i),(t[1]-s)/(l-s)];var t,n,r,i,s,u,l}));n.subData(jn(s,2))}},{key:"_updateColorTexture",value:function(e){var t=e.props.colorRange,n=this.state.colorTexture,r=m(t,!0);n?n.setImageData({data:r,width:t.length}):n=new w.Texture2D(this.context.gl,Wn({data:r,width:t.length,height:1,format:Object(w.isWebGL2)(this.context.gl)?34836:6408,type:5126},Un)),this.setState({colorTexture:n})}},{key:"_updateWeightmap",value:function(){var e,t=this.props.radiusPixels,n=this.state,r=n.weightsTransform,i=n.worldBounds,o=n.textureSize,a=n.weightsTexture,s=n.weightsScale;this._updateAttributes(this.props);var u=Object.assign(Object.create(this.props),{viewport:this.context.viewport,pickingActive:0}),l=this._worldToCommonBounds(i,{useLayerCoordinateSystem:!0,scaleToAspect:!0,width:2*o,height:2*o}),c=Object.assign({},r.model.getModuleUniforms(u),{radiusPixels:t,commonBounds:l,textureWidth:o,weightsScale:s});r.update({elementCount:this.getNumInstances()}),r.run({uniforms:c,parameters:{blend:!0,depthTest:!1,blendFunc:[1,1],blendEquation:32774},clearRenderTarget:!0}),this._updateMaxWeightValue(),a.setParameters((e={},x()(e,10240,9729),x()(e,10241,9729),e)),this.setState({lastUpdate:Date.now()})}},{key:"_debouncedUpdateWeightmap",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.state.updateTimer,n=Date.now()-this.state.lastUpdate;e&&(t=null),n>=500?(this._updateBounds(!0),this._updateWeightmap(),this._updateTextureRenderingBounds()):t||(t=setTimeout(this._debouncedUpdateWeightmap.bind(this,!0),500-n)),this.setState({updateTimer:t})}},{key:"_worldToCommonBounds",value:function(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=r.useLayerCoordinateSystem,o=void 0!==i&&i,a=r.scaleToAspect,s=void 0!==a&&a,u=r.width,l=r.height,c=b()(e,4),g=c[0],h=c[1],f=c[2],d=c[3],v=this.context.viewport;o?(t=this.projectPosition([g,d,0]),n=this.projectPosition([f,h,0])):(t=v.projectPosition([g,d,0]),n=v.projectPosition([f,h,0]));var p=t.slice(0,2).concat(n.slice(0,2));return s&&(p=Fn(p,u,l)),r.normalize&&(p=p.map((function(e){return e/v.scale}))),p}},{key:"_commonToWorldBounds",value:function(e){var t=b()(e,4),n=t[0],r=t[1],i=t[2],o=t[3],a=this.context.viewport,s=a.unprojectPosition([n,o]),u=a.unprojectPosition([i,r]);return s.slice(0,2).concat(u.slice(0,2))}}]),t}(v.CompositeLayer);Xn.layerName="HeatmapLayer",Xn.defaultProps=Vn,n.d(t,"experimental",(function(){return qn})),n.d(t,"ScreenGridLayer",(function(){return ye})),n.d(t,"CPUGridLayer",(function(){return Ue})),n.d(t,"HexagonLayer",(function(){return Ze})),n.d(t,"ContourLayer",(function(){return Cn})),n.d(t,"GridLayer",(function(){return Dn})),n.d(t,"GPUGridLayer",(function(){return En})),n.d(t,"AGGREGATION_OPERATION",(function(){return W})),n.d(t,"HeatmapLayer",(function(){return Xn})),n.d(t,"_GPUGridAggregator",(function(){return he}));var qn={BinSorter:Ce,linearScale:Pe,getLinearScale:Ee,quantizeScale:Te,getQuantizeScale:ke,getQuantileScale:ze,getOrdinalScale:Ne,defaultColorRange:p}}])}));