{"version":3,"sources":["../../../src/tile-layer/tile-layer.js"],"names":["CompositeLayer","GeoJsonLayer","TileCache","defaultProps","renderSubLayers","type","value","props","getTileData","x","y","z","Promise","resolve","onViewportLoaded","optional","onTileError","err","console","error","maxZoom","minZoom","maxCacheSize","TileLayer","initializeState","state","tiles","isLoaded","shouldUpdateState","changeFlags","somethingChanged","updateState","oldProps","context","tileCache","updateTriggersChanged","all","finalize","maxSize","onTileLoad","_onTileLoad","bind","_onTileError","setState","forEach","tile","layer","viewport","viewportChanged","id","getLayerZoomLevel","update","currTiles","filter","allCurrTilesLoaded","every","_data","map","getPickingInfo","info","sourceLayer","Math","floor","zoom","Number","isFinite","ceil","renderLayers","visible","isVisible","Object","assign","data","clone","layerName"],"mappings":"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","sourcesContent":["import {CompositeLayer} from '@deck.gl/core';\nimport {GeoJsonLayer} from '@deck.gl/layers';\nimport TileCache from './utils/tile-cache';\n\nconst defaultProps = {\n  renderSubLayers: {type: 'function', value: props => new GeoJsonLayer(props)},\n  getTileData: {type: 'function', value: ({x, y, z}) => Promise.resolve(null)},\n  // TODO - change to onViewportLoad to align with Tile3DLayer\n  onViewportLoaded: {type: 'function', optional: true, value: null},\n  // eslint-disable-next-line\n  onTileError: {type: 'function', value: err => console.error(err)},\n  maxZoom: null,\n  minZoom: 0,\n  maxCacheSize: null\n};\n\nexport default class TileLayer extends CompositeLayer {\n  initializeState() {\n    this.state = {\n      tiles: [],\n      isLoaded: false\n    };\n  }\n\n  shouldUpdateState({changeFlags}) {\n    return changeFlags.somethingChanged;\n  }\n\n  updateState({props, oldProps, context, changeFlags}) {\n    let {tileCache} = this.state;\n    if (\n      !tileCache ||\n      (changeFlags.updateTriggersChanged &&\n        (changeFlags.updateTriggersChanged.all || changeFlags.updateTriggersChanged.getTileData))\n    ) {\n      const {getTileData, maxZoom, minZoom, maxCacheSize} = props;\n      if (tileCache) {\n        tileCache.finalize();\n      }\n      tileCache = new TileCache({\n        getTileData,\n        maxSize: maxCacheSize,\n        maxZoom,\n        minZoom,\n        onTileLoad: this._onTileLoad.bind(this),\n        onTileError: this._onTileError.bind(this)\n      });\n      this.setState({tileCache});\n    } else if (changeFlags.updateTriggersChanged) {\n      // if any updateTriggersChanged (other than getTileData), delete the layer\n      this.state.tileCache.tiles.forEach(tile => {\n        tile.layer = null;\n      });\n    }\n\n    const {viewport} = context;\n    if (changeFlags.viewportChanged && viewport.id !== 'DEFAULT-INITIAL-VIEWPORT') {\n      const z = this.getLayerZoomLevel();\n      tileCache.update(viewport);\n      // The tiles that should be displayed at this zoom level\n      const currTiles = tileCache.tiles.filter(tile => tile.z === z);\n      this.setState({isLoaded: false, tiles: currTiles});\n      this._onTileLoad();\n    }\n  }\n\n  _onTileLoad() {\n    const {onViewportLoaded} = this.props;\n    const currTiles = this.state.tiles;\n    const allCurrTilesLoaded = currTiles.every(tile => tile.isLoaded);\n    if (this.state.isLoaded !== allCurrTilesLoaded) {\n      this.setState({isLoaded: allCurrTilesLoaded});\n      if (allCurrTilesLoaded && onViewportLoaded) {\n        onViewportLoaded(currTiles.filter(tile => tile._data).map(tile => tile._data));\n      }\n    }\n  }\n\n  _onTileError(error) {\n    this.props.onTileError(error);\n    // errorred tiles should not block rendering, are considered \"loaded\" with empty data\n    this._onTileLoad();\n  }\n\n  getPickingInfo({info, sourceLayer}) {\n    info.sourceLayer = sourceLayer;\n    info.tile = sourceLayer.props.tile;\n    return info;\n  }\n\n  getLayerZoomLevel() {\n    const z = Math.floor(this.context.viewport.zoom);\n    const {maxZoom, minZoom} = this.props;\n    if (Number.isFinite(maxZoom) && z > maxZoom) {\n      return Math.floor(maxZoom);\n    } else if (Number.isFinite(minZoom) && z < minZoom) {\n      return Math.ceil(minZoom);\n    }\n    return z;\n  }\n\n  renderLayers() {\n    const {renderSubLayers, visible} = this.props;\n    const z = this.getLayerZoomLevel();\n    return this.state.tileCache.tiles.map(tile => {\n      // For a tile to be visible:\n      // - parent layer must be visible\n      // - tile must be visible in the current viewport\n      // - if all tiles are loaded, only display the tiles from the current z level\n      const isVisible = visible && tile.isVisible && (!this.state.isLoaded || tile.z === z);\n      // cache the rendered layer in the tile\n      if (!tile.layer) {\n        tile.layer = renderSubLayers(\n          Object.assign({}, this.props, {\n            id: `${this.id}-${tile.x}-${tile.y}-${tile.z}`,\n            data: tile.data,\n            visible: isVisible,\n            tile\n          })\n        );\n      } else if (tile.layer.props.visible !== isVisible) {\n        tile.layer = tile.layer.clone({visible: isVisible});\n      }\n      return tile.layer;\n    });\n  }\n}\n\nTileLayer.layerName = 'TileLayer';\nTileLayer.defaultProps = defaultProps;\n"],"file":"tile-layer.js"}