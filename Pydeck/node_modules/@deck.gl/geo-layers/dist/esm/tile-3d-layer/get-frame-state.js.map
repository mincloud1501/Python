{"version":3,"sources":["../../../src/tile-3d-layer/get-frame-state.js"],"names":["Vector3","CullingVolume","Plane","Ellipsoid","scratchPlane","scratchPosition","cullingVolume","getFrameState","viewport","frameNumber","cameraDirection","cameraUp","height","metersPerPixel","distanceScales","viewportCenterCartographic","longitude","latitude","viewportCenterCartesian","WGS84","cartographicToCartesian","enuToFixedTransform","eastNorthUpToFixedFrame","cameraPositionCartographic","unprojectPosition","cameraPosition","cameraPositionCartesian","cameraDirectionCartesian","transformAsVector","scale","normalize","cameraUpCartesian","commonSpacePlanesToWGS84","camera","position","direction","up","sseDenominator","frustumPlanes","getFrustumPlanes","i","dir","plane","distanceToCenter","normal","dot","center","copy","distance","add","cartographicPos","cartesianPos","subtract","Math","abs","planes"],"mappings":"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","sourcesContent":["import {Vector3} from 'math.gl';\nimport {CullingVolume, Plane} from '@math.gl/culling';\nimport {Ellipsoid} from '@math.gl/geospatial';\n\nconst scratchPlane = new Plane();\nconst scratchPosition = new Vector3();\nconst cullingVolume = new CullingVolume([\n  new Plane(),\n  new Plane(),\n  new Plane(),\n  new Plane(),\n  new Plane(),\n  new Plane()\n]);\n\n// Extracts a frame state appropriate for tile culling from a deck.gl viewport\n// TODO - this could likely be generalized and merged back into deck.gl for other culling scenarios\nexport function getFrameState(viewport, frameNumber) {\n  // Traverse and and request. Update _selectedTiles so that we know what to render.\n  const {cameraDirection, cameraUp, height} = viewport;\n  const {metersPerPixel} = viewport.distanceScales;\n\n  const viewportCenterCartographic = [viewport.longitude, viewport.latitude, 0];\n  // TODO - Ellipsoid.eastNorthUpToFixedFrame() breaks on raw array, create a Vector.\n  // TODO - Ellipsoid.eastNorthUpToFixedFrame() takes a cartesian, is that intuitive?\n  const viewportCenterCartesian = Ellipsoid.WGS84.cartographicToCartesian(\n    viewportCenterCartographic,\n    new Vector3()\n  );\n  const enuToFixedTransform = Ellipsoid.WGS84.eastNorthUpToFixedFrame(viewportCenterCartesian);\n\n  const cameraPositionCartographic = viewport.unprojectPosition(viewport.cameraPosition);\n  const cameraPositionCartesian = Ellipsoid.WGS84.cartographicToCartesian(\n    cameraPositionCartographic,\n    new Vector3()\n  );\n\n  // These should still be normalized as the transform has scale 1 (goes from meters to meters)\n  const cameraDirectionCartesian = new Vector3(\n    enuToFixedTransform.transformAsVector(new Vector3(cameraDirection).scale(metersPerPixel))\n  ).normalize();\n  const cameraUpCartesian = new Vector3(\n    enuToFixedTransform.transformAsVector(new Vector3(cameraUp).scale(metersPerPixel))\n  ).normalize();\n\n  commonSpacePlanesToWGS84(viewport);\n\n  // TODO: make a file/class for frameState and document what needs to be attached to this so that traversal can function\n  return {\n    camera: {\n      position: cameraPositionCartesian,\n      direction: cameraDirectionCartesian,\n      up: cameraUpCartesian\n    },\n    height,\n    cullingVolume,\n    frameNumber, // TODO: This can be the same between updates, what number is unique for between updates?\n    sseDenominator: 1.15 // Assumes fovy = 60 degrees\n  };\n}\n\nfunction commonSpacePlanesToWGS84(viewport) {\n  // Extract frustum planes based on current view.\n  const viewportCenterCartographic = [viewport.longitude, viewport.latitude, 0];\n  const viewportCenterCartesian = Ellipsoid.WGS84.cartographicToCartesian(\n    viewportCenterCartographic,\n    new Vector3()\n  );\n\n  const frustumPlanes = viewport.getFrustumPlanes();\n  let i = 0;\n  for (const dir in frustumPlanes) {\n    const plane = frustumPlanes[dir];\n    const distanceToCenter = plane.normal.dot(viewport.center);\n    scratchPosition\n      .copy(plane.normal)\n      .scale(plane.distance - distanceToCenter)\n      .add(viewport.center);\n    const cartographicPos = viewport.unprojectPosition(scratchPosition);\n\n    const cartesianPos = Ellipsoid.WGS84.cartographicToCartesian(cartographicPos, new Vector3());\n\n    scratchPlane.normal\n      .copy(cartesianPos)\n      .subtract(viewportCenterCartesian)\n      .scale(-1) // Want the normal to point into the frustum since that's what culling expects\n      .normalize();\n    scratchPlane.distance = Math.abs(scratchPlane.normal.dot(cartesianPos));\n\n    cullingVolume.planes[i].normal.copy(scratchPlane.normal);\n    cullingVolume.planes[i].distance = scratchPlane.distance;\n    i = i + 1;\n  }\n}\n"],"file":"get-frame-state.js"}