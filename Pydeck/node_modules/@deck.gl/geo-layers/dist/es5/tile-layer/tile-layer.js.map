{"version":3,"sources":["../../../src/tile-layer/tile-layer.js"],"names":["defaultProps","renderSubLayers","type","value","props","GeoJsonLayer","getTileData","x","y","z","Promise","resolve","onViewportLoaded","optional","onTileError","err","console","error","maxZoom","minZoom","maxCacheSize","TileLayer","state","tiles","isLoaded","changeFlags","somethingChanged","oldProps","context","tileCache","updateTriggersChanged","all","finalize","TileCache","maxSize","onTileLoad","_onTileLoad","bind","_onTileError","setState","forEach","tile","layer","viewport","viewportChanged","id","getLayerZoomLevel","update","currTiles","filter","allCurrTilesLoaded","every","_data","map","info","sourceLayer","Math","floor","zoom","Number","isFinite","ceil","visible","isVisible","Object","assign","data","clone","CompositeLayer","layerName"],"mappings":"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","sourcesContent":["import {CompositeLayer} from '@deck.gl/core';\nimport {GeoJsonLayer} from '@deck.gl/layers';\nimport TileCache from './utils/tile-cache';\n\nconst defaultProps = {\n  renderSubLayers: {type: 'function', value: props => new GeoJsonLayer(props)},\n  getTileData: {type: 'function', value: ({x, y, z}) => Promise.resolve(null)},\n  // TODO - change to onViewportLoad to align with Tile3DLayer\n  onViewportLoaded: {type: 'function', optional: true, value: null},\n  // eslint-disable-next-line\n  onTileError: {type: 'function', value: err => console.error(err)},\n  maxZoom: null,\n  minZoom: 0,\n  maxCacheSize: null\n};\n\nexport default class TileLayer extends CompositeLayer {\n  initializeState() {\n    this.state = {\n      tiles: [],\n      isLoaded: false\n    };\n  }\n\n  shouldUpdateState({changeFlags}) {\n    return changeFlags.somethingChanged;\n  }\n\n  updateState({props, oldProps, context, changeFlags}) {\n    let {tileCache} = this.state;\n    if (\n      !tileCache ||\n      (changeFlags.updateTriggersChanged &&\n        (changeFlags.updateTriggersChanged.all || changeFlags.updateTriggersChanged.getTileData))\n    ) {\n      const {getTileData, maxZoom, minZoom, maxCacheSize} = props;\n      if (tileCache) {\n        tileCache.finalize();\n      }\n      tileCache = new TileCache({\n        getTileData,\n        maxSize: maxCacheSize,\n        maxZoom,\n        minZoom,\n        onTileLoad: this._onTileLoad.bind(this),\n        onTileError: this._onTileError.bind(this)\n      });\n      this.setState({tileCache});\n    } else if (changeFlags.updateTriggersChanged) {\n      // if any updateTriggersChanged (other than getTileData), delete the layer\n      this.state.tileCache.tiles.forEach(tile => {\n        tile.layer = null;\n      });\n    }\n\n    const {viewport} = context;\n    if (changeFlags.viewportChanged && viewport.id !== 'DEFAULT-INITIAL-VIEWPORT') {\n      const z = this.getLayerZoomLevel();\n      tileCache.update(viewport);\n      // The tiles that should be displayed at this zoom level\n      const currTiles = tileCache.tiles.filter(tile => tile.z === z);\n      this.setState({isLoaded: false, tiles: currTiles});\n      this._onTileLoad();\n    }\n  }\n\n  _onTileLoad() {\n    const {onViewportLoaded} = this.props;\n    const currTiles = this.state.tiles;\n    const allCurrTilesLoaded = currTiles.every(tile => tile.isLoaded);\n    if (this.state.isLoaded !== allCurrTilesLoaded) {\n      this.setState({isLoaded: allCurrTilesLoaded});\n      if (allCurrTilesLoaded && onViewportLoaded) {\n        onViewportLoaded(currTiles.filter(tile => tile._data).map(tile => tile._data));\n      }\n    }\n  }\n\n  _onTileError(error) {\n    this.props.onTileError(error);\n    // errorred tiles should not block rendering, are considered \"loaded\" with empty data\n    this._onTileLoad();\n  }\n\n  getPickingInfo({info, sourceLayer}) {\n    info.sourceLayer = sourceLayer;\n    info.tile = sourceLayer.props.tile;\n    return info;\n  }\n\n  getLayerZoomLevel() {\n    const z = Math.floor(this.context.viewport.zoom);\n    const {maxZoom, minZoom} = this.props;\n    if (Number.isFinite(maxZoom) && z > maxZoom) {\n      return Math.floor(maxZoom);\n    } else if (Number.isFinite(minZoom) && z < minZoom) {\n      return Math.ceil(minZoom);\n    }\n    return z;\n  }\n\n  renderLayers() {\n    const {renderSubLayers, visible} = this.props;\n    const z = this.getLayerZoomLevel();\n    return this.state.tileCache.tiles.map(tile => {\n      // For a tile to be visible:\n      // - parent layer must be visible\n      // - tile must be visible in the current viewport\n      // - if all tiles are loaded, only display the tiles from the current z level\n      const isVisible = visible && tile.isVisible && (!this.state.isLoaded || tile.z === z);\n      // cache the rendered layer in the tile\n      if (!tile.layer) {\n        tile.layer = renderSubLayers(\n          Object.assign({}, this.props, {\n            id: `${this.id}-${tile.x}-${tile.y}-${tile.z}`,\n            data: tile.data,\n            visible: isVisible,\n            tile\n          })\n        );\n      } else if (tile.layer.props.visible !== isVisible) {\n        tile.layer = tile.layer.clone({visible: isVisible});\n      }\n      return tile.layer;\n    });\n  }\n}\n\nTileLayer.layerName = 'TileLayer';\nTileLayer.defaultProps = defaultProps;\n"],"file":"tile-layer.js"}