{"version":3,"sources":["../../../../src/tileset/helpers/screen-space-error.js"],"names":["scratchPositionNormal","Vector3","scratchCartographic","Cartographic","scratchMatrix","Matrix4","scratchCenter","scratchPosition","scratchDirection","calculateDynamicScreenSpaceError","root","camera","mapProjection","options","dynamicScreenSpaceErrorHeightFalloff","dynamicScreenSpaceErrorDensity","up","direction","height","minimumHeight","maximumHeight","tileBoundingVolume","contentBoundingVolume","TileBoundingRegion","Cartesian3","normalize","positionWC","directionWC","positionCartographic","transformLocal","inverseTransformation","computedTransform","ellipsoid","boundingVolume","centerLocal","multiplyByPoint","center","magnitude","minimumRadius","centerCartographic","fromCartesian","positionLocal","UNIT_Z","multiplyByPointAsVector","z","TileOrientedBoundingBox","boxHeight","_header","box","TileBoundingSphere","radius","heightFalloff","heightClose","heightFar","t","dot","Math","abs","horizonFactor"],"mappings":"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","sourcesContent":["// This file is derived from the Cesium code base under Apache 2 license\n// See LICENSE.md and https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md\n\n// TODO - Dynamic screen space error provides an optimization when looking at\n// tilesets from above\n\n/* eslint-disable */\nimport {Matrix4, Vector3, clamp} from 'math.gl';\n\nconst scratchPositionNormal = new Vector3();\nconst scratchCartographic = new Cartographic();\nconst scratchMatrix = new Matrix4();\nconst scratchCenter = new Vector3();\nconst scratchPosition = new Vector3();\nconst scratchDirection = new Vector3();\n\n// eslint-disable-next-line max-statements, complexity\nexport function calculateDynamicScreenSpaceError(root, {camera, mapProjection}, options = {}) {\n  const {\n    dynamicScreenSpaceErrorHeightFalloff = 0.25,\n    dynamicScreenSpaceErrorDensity = 0.00278\n  } = options;\n\n  let up;\n  let direction;\n  let height;\n  let minimumHeight;\n  let maximumHeight;\n\n  const tileBoundingVolume = root.contentBoundingVolume;\n\n  if (tileBoundingVolume instanceof TileBoundingRegion) {\n    up = Cartesian3.normalize(camera.positionWC, scratchPositionNormal);\n    direction = camera.directionWC;\n    height = camera.positionCartographic.height;\n    minimumHeight = tileBoundingVolume.minimumHeight;\n    maximumHeight = tileBoundingVolume.maximumHeight;\n  } else {\n    // Transform camera position and direction into the local coordinate system of the tileset\n    const transformLocal = Matrix4.inverseTransformation(root.computedTransform, scratchMatrix);\n    const ellipsoid = mapProjection.ellipsoid;\n    const boundingVolume = tileBoundingVolume.boundingVolume;\n    const centerLocal = Matrix4.multiplyByPoint(\n      transformLocal,\n      boundingVolume.center,\n      scratchCenter\n    );\n    if (Cartesian3.magnitude(centerLocal) > ellipsoid.minimumRadius) {\n      // The tileset is defined in WGS84. Approximate the minimum and maximum height.\n      const centerCartographic = Cartographic.fromCartesian(\n        centerLocal,\n        ellipsoid,\n        scratchCartographic\n      );\n      up = Cartesian3.normalize(camera.positionWC, scratchPositionNormal);\n      direction = camera.directionWC;\n      height = camera.positionCartographic.height;\n      minimumHeight = 0.0;\n      maximumHeight = centerCartographic.height * 2.0;\n    } else {\n      // The tileset is defined in local coordinates (z-up)\n      const positionLocal = Matrix4.multiplyByPoint(\n        transformLocal,\n        camera.positionWC,\n        scratchPosition\n      );\n      up = Cartesian3.UNIT_Z;\n      direction = Matrix4.multiplyByPointAsVector(\n        transformLocal,\n        camera.directionWC,\n        scratchDirection\n      );\n      direction = Cartesian3.normalize(direction, direction);\n      height = positionLocal.z;\n      if (tileBoundingVolume instanceof TileOrientedBoundingBox) {\n        // Assuming z-up, the last component stores the half-height of the box\n        const boxHeight = root._header.boundingVolume.box[11];\n        minimumHeight = centerLocal.z - boxHeight;\n        maximumHeight = centerLocal.z + boxHeight;\n      } else if (tileBoundingVolume instanceof TileBoundingSphere) {\n        const radius = boundingVolume.radius;\n        minimumHeight = centerLocal.z - radius;\n        maximumHeight = centerLocal.z + radius;\n      }\n    }\n  }\n\n  // The range where the density starts to lessen. Start at the quarter height of the tileset.\n  const heightFalloff = dynamicScreenSpaceErrorHeightFalloff;\n  const heightClose = minimumHeight + (maximumHeight - minimumHeight) * heightFalloff;\n  const heightFar = maximumHeight;\n\n  const t = clamp((height - heightClose) / (heightFar - heightClose), 0.0, 1.0);\n\n  // Increase density as the camera tilts towards the horizon\n  const dot = Math.abs(Cartesian3.dot(direction, up));\n\n  let horizonFactor = 1.0 - dot;\n\n  // Weaken the horizon factor as the camera height increases, implying the camera is further away from the tileset.\n  // The goal is to increase density for the \"street view\", not when viewing the tileset from a distance.\n  horizonFactor = horizonFactor * (1.0 - t);\n\n  return dynamicScreenSpaceErrorDensity * horizonFactor;\n}\n"],"file":"screen-space-error.js"}