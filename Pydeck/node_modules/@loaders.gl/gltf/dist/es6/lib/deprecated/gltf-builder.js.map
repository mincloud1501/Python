{"version":3,"sources":["../../../../src/lib/deprecated/gltf-builder.js"],"names":["getImageMetadata","assert","KHR_DRACO_MESH_COMPRESSION","UBER_POINT_CLOUD_EXTENSION","GLBBuilder","packBinaryJson","GLTFBuilder","constructor","options","DracoWriter","DracoLoader","addApplicationData","key","data","packOptions","jsonData","packTypedArrays","json","addExtraData","packedJson","packedTypedArrays","extras","addExtension","extensionName","extensions","registerUsedExtension","addRequiredExtension","registerRequiredExtension","extensionsUsed","find","ext","push","extensionsRequired","addMesh","attributes","indices","mode","accessors","_addAttributes","glTFMesh","primitives","meshes","length","addPointCloud","accessorIndices","addCompressedMesh","Error","compressedData","encodeSync","decodedData","parseSync","fauxAccessors","_addFauxAttributes","bufferViewIndex","addBufferView","bufferView","addCompressedPointCloud","pointcloud","addImage","imageData","sizeAndType","mimeType","width","height","images"],"mappings":"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","sourcesContent":["import {getImageMetadata} from '@loaders.gl/images';\nimport assert from '../utils/assert';\nimport {KHR_DRACO_MESH_COMPRESSION, UBER_POINT_CLOUD_EXTENSION} from '../gltf-constants';\nimport GLBBuilder from './glb-builder';\nimport packBinaryJson from './packed-json/pack-binary-json';\n\nexport default class GLTFBuilder extends GLBBuilder {\n  constructor(options = {}) {\n    super(options);\n\n    // Soft dependency on DRACO, app needs to import and supply these\n    this.DracoWriter = options.DracoWriter;\n    this.DracoLoader = options.DracoLoader;\n  }\n\n  // NOTE: encode() inherited from GLBBuilder\n\n  // TODO - support encoding to non-GLB versions of glTF format\n  // Encode as a textual JSON file with binary data in base64 data URLs.\n  // encodeAsDataURLs(options)\n  // Encode as a JSON with all images (and buffers?) in separate binary files\n  // encodeAsSeparateFiles(options)\n\n  // Add an extra application-defined key to the top-level data structure\n  // By default packs JSON by extracting binary data and replacing it with JSON pointers\n  addApplicationData(key, data, packOptions = {}) {\n    const jsonData = packOptions.packTypedArrays ? packBinaryJson(data, this, packOptions) : data;\n    this.json[key] = jsonData;\n    return this;\n  }\n\n  // `extras` - Standard GLTF field for storing application specific data\n  // By default packs JSON by extracting binary data and replacing it with JSON pointers\n  addExtraData(key, data, packOptions = {}) {\n    const packedJson = packOptions.packedTypedArrays\n      ? packBinaryJson(data, this, packOptions)\n      : data;\n    this.json.extras = this.json.extras || {};\n    this.json.extras[key] = packedJson;\n    return this;\n  }\n\n  // Add to standard GLTF top level extension object, mark as used\n  // By default packs JSON by extracting binary data and replacing it with JSON pointers\n  addExtension(extensionName, data, packOptions = {}) {\n    assert(data);\n    const packedJson = packOptions.packTypedArrays ? packBinaryJson(data, this, packOptions) : data;\n    this.json.extensions = this.json.extensions || {};\n    this.json.extensions[extensionName] = packedJson;\n    this.registerUsedExtension(extensionName);\n    return this;\n  }\n\n  // Standard GLTF top level extension object, mark as used and required\n  // By default packs JSON by extracting binary data and replacing it with JSON pointers\n  addRequiredExtension(extensionName, data, packOptions = {}) {\n    assert(data);\n    const packedJson = packOptions.packTypedArrays ? packBinaryJson(data, this, packOptions) : data;\n    this.addExtension(extensionName, packedJson);\n    this.registerRequiredExtension(extensionName);\n    return this;\n  }\n\n  // Add extensionName to list of used extensions\n  registerUsedExtension(extensionName) {\n    this.json.extensionsUsed = this.json.extensionsUsed || [];\n    if (!this.json.extensionsUsed.find(ext => ext === extensionName)) {\n      this.json.extensionsUsed.push(extensionName);\n    }\n  }\n\n  // Add extensionName to list of required extensions\n  registerRequiredExtension(extensionName) {\n    this.registerUsedExtension(extensionName);\n    this.json.extensionsRequired = this.json.extensionsRequired || [];\n    if (!this.json.extensionsRequired.find(ext => ext === extensionName)) {\n      this.json.extensionsRequired.push(extensionName);\n    }\n  }\n\n  // mode:\n  // POINTS:  0x0000,\n  // LINES: 0x0001,\n  // LINE_LOOP: 0x0002,\n  // LINE_STRIP:  0x0003,\n  // TRIANGLES: 0x0004,\n  // TRIANGLE_STRIP:  0x0005,\n  // TRIANGLE_FAN:  0x0006,\n\n  addMesh(attributes, indices, mode = 4) {\n    const accessors = this._addAttributes(attributes);\n\n    const glTFMesh = {\n      primitives: [\n        {\n          attributes: accessors,\n          indices,\n          mode\n        }\n      ]\n    };\n\n    this.json.meshes = this.json.meshes || [];\n    this.json.meshes.push(glTFMesh);\n    return this.json.meshes.length - 1;\n  }\n\n  addPointCloud(attributes) {\n    const accessorIndices = this._addAttributes(attributes);\n\n    const glTFMesh = {\n      primitives: [\n        {\n          attributes: accessorIndices,\n          mode: 0 // GL.POINTS\n        }\n      ]\n    };\n\n    this.json.meshes = this.json.meshes || [];\n    this.json.meshes.push(glTFMesh);\n    return this.json.meshes.length - 1;\n  }\n\n  // eslint-disable-next-line max-len\n  // https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_draco_mesh_compression\n  // Only TRIANGLES: 0x0004 and TRIANGLE_STRIP: 0x0005 are supported\n  addCompressedMesh(attributes, indices, mode = 4) {\n    if (!this.DracoWriter || !this.DracoLoader) {\n      throw new Error('DracoWriter/DracoLoader not available');\n    }\n\n    // Since we do not add fallback data\n    this.registerRequiredExtension(KHR_DRACO_MESH_COMPRESSION);\n\n    const compressedData = this.DracoWriter.encodeSync({attributes});\n\n    // Draco compression may change the order and number of vertices in a mesh.\n    // To satisfy the requirement that accessors properties be correct for both\n    // compressed and uncompressed data, generators should create uncompressed\n    // attributes and indices using data that has been decompressed from the Draco buffer,\n    // rather than the original source data.\n    const decodedData = this.DracoLoader.parseSync({attributes});\n    const fauxAccessors = this._addFauxAttributes(decodedData.attributes);\n\n    const bufferViewIndex = this.addBufferView(compressedData);\n\n    const glTFMesh = {\n      primitives: [\n        {\n          attributes: fauxAccessors, // TODO - verify with spec\n          mode, // GL.POINTS\n          extensions: {\n            [KHR_DRACO_MESH_COMPRESSION]: {\n              bufferView: bufferViewIndex,\n              attributes: fauxAccessors // TODO - verify with spec\n            }\n          }\n        }\n      ]\n    };\n\n    this.json.meshes = this.json.meshes || [];\n    this.json.meshes.push(glTFMesh);\n    return this.json.meshes.length - 1;\n  }\n\n  addCompressedPointCloud(attributes) {\n    if (!this.DracoWriter || !this.DracoLoader) {\n      throw new Error('DracoWriter/DracoLoader not available');\n    }\n\n    attributes.mode = 0;\n    const compressedData = this.DracoWriter.encodeSync(attributes, {pointcloud: true});\n\n    const bufferViewIndex = this.addBufferView(compressedData);\n\n    const glTFMesh = {\n      primitives: [\n        {\n          attributes: {}, // This will be populated after decompression\n          mode: 0, // GL.POINTS\n          extensions: {\n            [UBER_POINT_CLOUD_EXTENSION]: {\n              bufferView: bufferViewIndex\n            }\n          }\n        }\n      ]\n    };\n\n    this.registerRequiredExtension(UBER_POINT_CLOUD_EXTENSION);\n\n    this.json.meshes = this.json.meshes || [];\n    this.json.meshes.push(glTFMesh);\n    return this.json.meshes.length - 1;\n  }\n\n  // Adds a binary image. Builds glTF \"JSON metadata\" and saves buffer reference\n  // Buffer will be copied into BIN chunk during \"pack\"\n  // Currently encodes as glTF image\n  addImage(imageData) {\n    const bufferViewIndex = this.addBufferView(imageData);\n\n    // Get the properties of the image to add as metadata.\n    const sizeAndType = getImageMetadata(imageData) || {};\n    if (sizeAndType) {\n      // width and height are non-spec fields\n      const {mimeType, width, height} = sizeAndType;\n      this.json.images.push({\n        bufferView: bufferViewIndex,\n        mimeType,\n        width,\n        height\n      });\n    } else {\n      // TODO: Spec violation, if we are using a bufferView, mimeType must be defined:\n      //   https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#images\n      //   \"a reference to a bufferView; in that case mimeType must be defined.\"\n      this.json.images.push({\n        bufferView: bufferViewIndex\n      });\n    }\n\n    return this.json.images.length - 1;\n  }\n}\n"],"file":"gltf-builder.js"}